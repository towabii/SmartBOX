<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Smart Box V7</title>
    
    <!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@latest"></script>

    <style>
        :root { 
            --primary: #2563eb; 
            --bg: #f1f5f9; 
            --card-bg: #ffffff;
            --text: #1e293b;
            --border: #e2e8f0;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 0; background: var(--bg); color: var(--text); padding-bottom: 110px; -webkit-tap-highlight-color: transparent; }
        
        /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; }
        #login-screen input { width: 200px; text-align: center; font-size: 1.5rem; letter-spacing: 5px; margin: 20px 0; border: none; border-radius: 8px; padding: 10px; }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header { background: var(--primary); color: white; padding: 15px 20px; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h1 { margin: 0; font-size: 1.2rem; font-weight: 800; }
        .status-badge { font-size: 0.75rem; background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 20px; font-weight: bold; }

        /* ã‚³ãƒ³ãƒ†ãƒŠ & ã‚«ãƒ¼ãƒ‰ */
        .container { max-width: 600px; margin: 0 auto; padding: 15px; }
        .card { background: var(--card-bg); border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid var(--border); }
        .card-title { font-size: 1rem; font-weight: bold; margin-bottom: 10px; color: #334155; border-bottom: 2px solid #f1f5f9; padding-bottom: 8px; }

        /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */
        input, select { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #cbd5e1; border-radius: 8px; background: #f8fafc; box-sizing: border-box; font-size: 1rem; }
        input:focus { border-color: var(--primary); outline: none; background: white; }

        /* ãƒœã‚¿ãƒ³ãƒ‡ã‚¶ã‚¤ãƒ³ (ã‚ã‹ã‚Šã‚„ã™ãæ”¹ä¿®) */
        button { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 0.95rem; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; margin-bottom: 8px; }
        button:active { transform: scale(0.98); opacity: 0.9; }
        
        .btn-main { background: var(--primary); color: white; }
        .btn-sub  { background: #e2e8f0; color: #475569; }
        .btn-danger { background: #fee2e2; color: #ef4444; }
        
        /* ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ (å¤§ããè¦‹ã‚„ã™ã) */
        .mode-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .btn-mode { flex-direction: column; padding: 15px; height: 80px; font-size: 0.85rem; }
        .btn-mode span { font-size: 1.5rem; margin-bottom: 5px; }
        .mode-normal { background: #e0f2fe; color: #0284c7; border: 1px solid #bae6fd; }
        .mode-fast   { background: #fef3c7; color: #d97706; border: 1px solid #fde68a; }
        .mode-voice  { background: #dcfce7; color: #16a34a; border: 1px solid #bbf7d0; }

        /* ãƒªã‚¹ãƒˆè¡¨ç¤º */
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f1f5f9; }
        .item-name { font-weight: bold; color: #334155; }
        .tag { color: var(--primary); background: #e0e7ff; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-left: 5px; }
        
        .box-row { padding: 15px; border-bottom: 1px solid #f1f5f9; cursor: pointer; position: relative; }
        .box-row:last-child { border-bottom: none; }
        .box-id { font-weight: bold; color: var(--primary); font-size: 1.1rem; }
        .box-cat { font-size: 0.75rem; background: #f1f5f9; padding: 3px 8px; border-radius: 4px; color: #64748b; margin-left: 8px; }
        
        /* å¼·èª¿è¡¨ç¤º */
        .hl { background: #fef08a; padding: 0 2px; border-radius: 2px; border: 1px solid #fde047; }
        .alert-badge { background: #fee2e2; color: #b91c1c; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; display: none; margin-left: 5px; }
        .alert-badge.show { display: inline-block; }

        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #e2e8f0; display: flex; padding-bottom: env(safe-area-inset-bottom); z-index: 1000; box-shadow: 0 -4px 10px rgba(0,0,0,0.05); }
        .nav-item { flex: 1; text-align: center; padding: 12px 0; color: #94a3b8; font-size: 0.7rem; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-icon { font-size: 1.5rem; display: block; margin-bottom: 4px; }
        
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* UIãƒ‘ãƒ¼ãƒ„ */
        #fast-mode-ui { position: fixed; top:0; left:0; width:100%; height:100%; background: #000; z-index: 1500; display:none; flex-direction:column; }
        #fast-video { width: 100%; height: 100%; object-fit: cover; }
        .fast-overlay { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.8); padding: 30px 20px; text-align: center; color: white; box-sizing: border-box; }

        /* å°åˆ·è¨­å®š (å³å¯†ãªA4 1æšè¨­å®š) */
        #print-area { display: none; }
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { 
                position: absolute; top: 0; left: 0; width: 100%; height: 100vh;
                margin: 0; padding: 10mm; box-sizing: border-box;
                display: grid !important; 
                grid-template-columns: 1fr 1fr; 
                grid-template-rows: repeat(4, 1fr); 
                gap: 10px; 
            }
            .print-card { 
                border: 2px solid #000; border-radius: 8px; 
                display: flex; flex-direction: column; align-items: center; justify-content: center; 
                overflow: hidden; 
            }
            .print-id { font-size: 24pt; font-weight: bold; margin-bottom: 10px; }
            
            /* å˜ä½“å°åˆ·ç”¨ã®ä¸Šæ›¸ã */
            #print-area.mode-single {
                display: flex !important; align-items: center; justify-content: center;
            }
            #print-area.mode-single .print-card {
                width: 80%; height: 60%; border: 4px solid #000;
            }
            #print-area.mode-single .print-id { font-size: 48pt; }
        }
    </style>
</head>
<body>

<!-- ãƒ­ã‚°ã‚¤ãƒ³ -->
<div id="login-screen">
    <div style="background:white; padding:30px; border-radius:20px; text-align:center; color:#333; width:80%; max-width:300px;">
        <h2>ğŸ” ãƒ­ãƒƒã‚¯è§£é™¤</h2>
        <p style="font-size:0.8rem; color:#666; margin-bottom:15px;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›</p>
        <input type="password" id="login-pass" placeholder="****" maxlength="8" style="width:100%; border:1px solid #ddd;">
        <button class="btn-main" onclick="tryLogin()">è§£é™¤</button>
        <p id="login-msg" style="color:red; font-size:0.8rem; margin-top:10px;"></p>
    </div>
</div>

<div class="header">
    <h1>ğŸ“¦ Smart Box V7</h1>
    <span id="sync-status" class="status-badge">Waiting</span>
</div>

<div class="container">

    <!-- 1. ã‚¹ã‚­ãƒ£ãƒ³ / ç·¨é›†ã‚¿ãƒ– -->
    <div id="view-scan" class="view active">
        <!-- ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ -->
        <div id="scan-ui" class="card">
            <h3 style="text-align:center; margin:0 0 10px 0;">QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³</h3>
            <div id="reader" style="border-radius:12px; overflow:hidden; background:black; min-height:250px;"></div>
            <p style="text-align:center; font-size:0.85rem; color:#64748b; margin-top:15px;">ã‚«ãƒ¡ãƒ©ã‚’è¨±å¯ã—ã¦ãã ã•ã„</p>
        </div>

        <!-- ç®±è©³ç´°ç”»é¢ -->
        <div id="box-ui" class="card" style="display:none;">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #f1f5f9; padding-bottom:10px; margin-bottom:15px;">
                <div>
                    <div id="disp-id" class="box-id" style="font-size:1.5rem;">BOX-ID</div>
                    <div style="margin-top:5px;">
                        <span id="disp-cat" class="box-cat" style="margin:0;">ã‚«ãƒ†ã‚´ãƒª</span>
                        <span id="disp-alert" class="alert-badge">âš ï¸ é•·æœŸæ”¾ç½®</span>
                    </div>
                </div>
                <button class="btn-sub" style="width:auto; padding:8px 12px;" onclick="printQR()">ğŸ–¨ï¸ å°åˆ·</button>
            </div>
            
            <label style="font-size:0.85rem; color:#64748b;">ä¿ç®¡å ´æ‰€</label>
            <input type="text" id="inp-loc" placeholder="ä¾‹: ã‚¯ãƒ­ãƒ¼ã‚¼ãƒƒãƒˆ" onchange="saveBox()">
            
            <!-- ã‚¢ã‚¤ãƒ†ãƒ ãƒªã‚¹ãƒˆ -->
            <div class="card-title">ä¸­èº«ãƒªã‚¹ãƒˆ</div>
            <div id="item-list-container" style="max-height:200px; overflow-y:auto; margin-bottom:20px; border:1px solid #e2e8f0; border-radius:8px; padding:10px;"></div>

            <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
            <div style="background:#f8fafc; padding:15px; border-radius:12px; border:1px solid #e2e8f0;">
                <div class="card-title" style="border:none; padding:0;">ã‚¢ã‚¤ãƒ†ãƒ è¿½åŠ </div>
                
                <!-- æ‰‹å‹•å…¥åŠ› -->
                <div style="display:flex; gap:8px; margin-top:10px;">
                    <input type="text" id="inp-name" placeholder="å“å #ã‚¿ã‚°" style="margin:0; flex:1;">
                    <button class="btn-main" style="width:auto; margin:0; padding:0 20px;" onclick="addItem()">è¿½åŠ </button>
                </div>

                <!-- ã‚¹ãƒãƒ¼ãƒˆå…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ (æ—§ãƒ‡ã‚¶ã‚¤ãƒ³é¢¨é…ç½®) -->
                <p style="font-size:0.8rem; color:#64748b; margin-top:15px; text-align:center;">ã‚¹ãƒãƒ¼ãƒˆå…¥åŠ›ãƒ¢ãƒ¼ãƒ‰</p>
                <div class="mode-grid">
                    <button class="btn-mode mode-normal" onclick="startNormalCamera()">
                        <span>ğŸ“·</span>
                        é€šå¸¸AIè­˜åˆ¥
                    </button>
                    <button class="btn-mode mode-fast" onclick="startFastMode(false)">
                        <span>ğŸš€</span>
                        é«˜é€Ÿ(ã‚«ãƒ¡ãƒ©+éŸ³å£°)
                    </button>
                </div>
                <button class="btn-mode mode-voice" style="width:100%; margin-top:10px; height:50px; flex-direction:row;" onclick="startVoiceOnlyMode()">
                    <span>ğŸ¤</span> éŸ³å£°ã®ã¿ãƒ¢ãƒ¼ãƒ‰
                </button>
                
                <!-- AIã‚«ãƒ¡ãƒ©ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ -->
                <div id="cam-ui" style="display:none; background:white; padding:10px; border-radius:8px; margin-top:10px; border:1px solid #ddd;">
                    <video id="cam-video" autoplay playsinline muted style="width:100%; border-radius:8px;"></video>
                    <div id="ai-hint" style="text-align:center; font-weight:bold; color:var(--primary); margin:8px 0;">è§£æä¸­...</div>
                    <div style="display:flex; gap:10px;">
                        <button class="btn-main" onclick="snapAI()">æ±ºå®š</button>
                        <button class="btn-sub" onclick="stopCam()">é–‰ã˜ã‚‹</button>
                    </div>
                </div>
            </div>

            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-sub" onclick="closeBox()">é–‰ã˜ã‚‹</button>
                <button class="btn-danger" onclick="deleteBox()">ç®±ã‚’å‰Šé™¤</button>
            </div>
        </div>
    </div>

    <!-- 2. ä¸€è¦§ & æ¤œç´¢ã‚¿ãƒ– -->
    <div id="view-list" class="view">
        
        <!-- ãŠã™ã™ã‚ç®± (ã©ã“ã«å…¥ã‚Œã‚Œã°ã„ã„ï¼Ÿ) -->
        <div class="card" style="background:#f0fdf4; border-color:#86efac;">
            <div class="card-title" style="color:#15803d; border-color:#86efac;">ğŸ’¡ ãŠã™ã™ã‚ç®±æ¤œç´¢ (ã©ã“å…¥ã‚Œã‚‹ï¼Ÿ)</div>
            <div style="display:flex; gap:8px;">
                <input type="text" id="suggest-input" placeholder="å“å (ä¾‹: ãƒã‚µãƒŸ)" style="margin:0; background:white;">
                <button class="btn-main" style="width:auto; margin:0; background:#16a34a;" onclick="findSuggestion()">ææ¡ˆ</button>
            </div>
            <div id="suggest-res" style="margin-top:10px; font-size:0.9rem; color:#14532d;"></div>
        </div>

        <!-- ãƒœãƒƒã‚¯ã‚¹æ¤œç´¢ (ã‚ã„ã¾ã„æ¤œç´¢) -->
        <div class="card">
            <div class="card-title">ğŸ“¦ ãƒœãƒƒã‚¯ã‚¹ä¸€è¦§ (æ¢ã™)</div>
            <input type="text" id="filter-input" placeholder="ğŸ” åå‰ã€å ´æ‰€ã€ã‚«ãƒ†ã‚´ãƒªã§æ¤œç´¢..." onkeyup="renderList()">
            <div id="list-container"></div>
        </div>
    </div>

    <!-- 3. è¨­å®šã‚¿ãƒ– -->
    <div id="view-settings" class="view">
        <div class="card">
            <div class="card-title">ğŸ–¨ï¸ QRä¸€æ‹¬å°åˆ·</div>
            <p style="font-size:0.9rem; color:#64748b; margin-bottom:15px;">
                A4ç”¨ç´™1æšã«8å€‹ã®QRã‚³ãƒ¼ãƒ‰ã‚’å°åˆ·ã—ã¾ã™ã€‚<br>
                â€»å°åˆ·ç”»é¢ã§ã€Œ1ãƒšãƒ¼ã‚¸ã€ã«ãªã‚‹ã‚ˆã†ã«èª¿æ•´æ¸ˆã¿ã§ã™ã€‚
            </p>
            <button class="btn-main" onclick="bulkPrint()">A4å°åˆ·ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ (8é¢)</button>
        </div>
        <div class="card">
            <div class="card-title">â˜ï¸ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</div>
            <button class="btn-sub" onclick="fetchData(true)">å¼·åˆ¶åŒæœŸ</button>
            <button class="btn-danger" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
    </div>
</div>

<!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
<div class="nav">
    <div class="nav-item active" onclick="tab('scan')"><span class="nav-icon">ğŸ“·</span>ç·¨é›†</div>
    <div class="nav-item" onclick="tab('list')"><span class="nav-icon">ğŸ”</span>æ¤œç´¢/ææ¡ˆ</div>
    <div class="nav-item" onclick="tab('settings')"><span class="nav-icon">âš™ï¸</span>è¨­å®š</div>
</div>

<!-- é«˜é€Ÿãƒ¢ãƒ¼ãƒ‰UI -->
<div id="fast-mode-ui">
    <div style="flex:1; position:relative; overflow:hidden; display:flex; justify-content:center; align-items:center;">
        <video id="fast-video" autoplay playsinline muted></video>
        <div id="voice-only-icon" style="display:none; font-size:5rem; color:white;">ğŸ¤</div>
        <div class="scan-line" id="scan-line"></div>
    </div>
    <div class="fast-overlay">
        <div id="fast-log" style="color:#4ade80; font-family:monospace; margin-bottom:15px; font-size:1.2rem;">å¾…æ©Ÿä¸­...</div>
        <button class="btn-sub" onclick="stopFastMode()">çµ‚äº†ã—ã¦ä¿å­˜</button>
    </div>
</div>

<!-- å°åˆ·ç”¨ã‚¨ãƒªã‚¢ -->
<div id="print-area"></div>

<script>
    // â–¼â–¼â–¼ GAS URL (ã“ã“ã‚’æ›¸ãæ›ãˆã¦ãã ã•ã„) â–¼â–¼â–¼
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwgy6T7BschsAXNxBEinbzdW8hrN6YBWHbhumMVE1o4WdrXJI9bTu58Sd09-vyIghxVWQ/exec";
    // â–²â–²â–² â–²â–²â–² â–²â–²â–²

    let localDB = {}; 
    let currentBoxId = null;
    let qrScanner = null;
    let aiModel = null;
    let password = localStorage.getItem('sb_pass') || "";

    // è¾æ›¸
    const DICTIONARY = {
        "æ–‡æˆ¿å…·": ["ãƒšãƒ³","é‰›ç­†","æ¶ˆã—ã‚´ãƒ ","å®šè¦","ãƒã‚µãƒŸ","ã‚«ãƒƒã‚¿ãƒ¼","ã®ã‚Š","ãƒ†ãƒ¼ãƒ—","ãƒ›ãƒƒãƒã‚­ã‚¹","ä»˜ç®‹","ãƒãƒ¼ãƒˆ","ãƒ¡ãƒ¢"],
        "è¡£é¡": ["æœ","ã‚·ãƒ£ãƒ„","ã‚ºãƒœãƒ³","ãƒ‘ãƒ³ãƒ„","ã‚¹ã‚«ãƒ¼ãƒˆ","ä¸‹ç€","é´ä¸‹","ã‚³ãƒ¼ãƒˆ","ã‚¸ãƒ£ã‚±ãƒƒãƒˆ","å¸½å­","ãƒãƒ•ãƒ©ãƒ¼"],
        "PCãƒ»ã‚¬ã‚¸ã‚§ãƒƒãƒˆ": ["PC","ãƒã‚¦ã‚¹","ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰","ãƒ¢ãƒ‹ã‚¿ãƒ¼","ã‚±ãƒ¼ãƒ–ãƒ«","USB","å……é›»å™¨","ã‚¹ãƒãƒ›","é›»æ± ","ã‚¤ãƒ¤ãƒ›ãƒ³"],
        "ã‚­ãƒƒãƒãƒ³": ["é‹","ãƒ•ãƒ©ã‚¤ãƒ‘ãƒ³","çš¿","ã‚³ãƒƒãƒ—","ç®¸","ã‚¹ãƒ—ãƒ¼ãƒ³","ãƒ•ã‚©ãƒ¼ã‚¯","æ´—å‰¤","ã‚¹ãƒãƒ³ã‚¸","ãƒ©ãƒƒãƒ—","é£Ÿå“","èª¿å‘³æ–™"],
        "æ—¥ç”¨å“": ["ãƒ†ã‚£ãƒƒã‚·ãƒ¥","ãƒˆã‚¤ãƒ¬ãƒƒãƒˆãƒšãƒ¼ãƒ‘ãƒ¼","æ´—å‰¤","ã‚·ãƒ£ãƒ³ãƒ—ãƒ¼","çŸ³é¹¸","æ­¯ãƒ–ãƒ©ã‚·","ãƒã‚¹ã‚¯","è–¬","æƒé™¤æ©Ÿ"],
        "å·¥å…·": ["ãƒ‰ãƒ©ã‚¤ãƒãƒ¼","ãƒ¬ãƒ³ãƒ","ãƒã‚¸","ã‚¬ãƒ ãƒ†ãƒ¼ãƒ—","è»æ‰‹","ç´"],
        "æ›¸é¡": ["å¥‘ç´„æ›¸","é€šå¸³","å°é‘‘","ãƒ‘ã‚¹ãƒãƒ¼ãƒˆ","å¹´é‡‘","ä¿é™º","è¨¼æ›¸"]
    };

    window.onload = () => {
        if(password) {
            document.getElementById('login-screen').style.display='none';
            fetchData();
        }
        renderList();
    };

    // --- èªè¨¼ ---
    function tryLogin() {
        const p = document.getElementById('login-pass').value;
        document.getElementById('login-msg').innerText = "èªè¨¼ä¸­...";
        fetch(`${GAS_URL}?password=${p}`)
        .then(r => r.json())
        .then(d => {
            if(d.error) {
                document.getElementById('login-msg').innerText = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™";
            } else {
                password = p;
                localStorage.setItem('sb_pass', p);
                document.getElementById('login-screen').style.display='none';
                localDB = d;
                renderList();
            }
        }).catch(e => document.getElementById('login-msg').innerText = "é€šä¿¡ã‚¨ãƒ©ãƒ¼");
    }
    function logout() { localStorage.removeItem('sb_pass'); location.reload(); }

    // --- é€šä¿¡ ---
    async function fetchData(force=false) {
        document.getElementById('sync-status').innerText = "Syncing...";
        try {
            const res = await fetch(`${GAS_URL}?password=${password}`);
            const json = await res.json();
            if(json.error) { alert("èªè¨¼ã‚¨ãƒ©ãƒ¼"); logout(); return; }
            localDB = json;
            document.getElementById('sync-status').innerText = "Ready";
            if(force) { alert("åŒæœŸå®Œäº†"); renderList(); }
        } catch(e){ document.getElementById('sync-status').innerText = "Error"; }
    }
    async function pushData(payload) {
        document.getElementById('sync-status').innerText = "Saving...";
        payload.password = password;
        try {
            await fetch(GAS_URL, { method:'POST', headers:{ "Content-Type":"text/plain" }, body:JSON.stringify(payload) });
            document.getElementById('sync-status').innerText = "Saved";
        } catch(e){ document.getElementById('sync-status').innerText = "Save Error"; }
    }

    // --- UI ---
    function tab(t) {
        document.querySelectorAll('.view').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
        document.getElementById('view-'+t).classList.add('active');
        const idx = ['scan','list','settings'].indexOf(t);
        document.querySelectorAll('.nav-item')[idx].classList.add('active');
        if(t==='scan') setTimeout(startQR,300); else stopQR();
        if(t==='list') renderList();
    }

    // --- QRå‡¦ç† ---
    function startQR() {
        if(currentBoxId || qrScanner) return;
        const r = document.getElementById("reader");
        if(r && r.offsetParent!==null) {
            const sc = new Html5Qrcode("reader");
            sc.start({facingMode:"environment"},{fps:10,qrbox:250},(t)=>{openBox(t)})
            .then(()=>{qrScanner=sc}).catch(()=>{setTimeout(startQR,500)});
        }
    }
    function stopQR() { if(qrScanner) qrScanner.stop().then(()=>{qrScanner.clear();qrScanner=null}).catch(()=>{qrScanner=null}); }

    function openBox(id) {
        stopQR();
        currentBoxId = id;
        document.getElementById('scan-ui').style.display='none';
        document.getElementById('box-ui').style.display='block';
        if(!localDB[id]) localDB[id] = { loc:"", items:[], category:"æœªåˆ†é¡", updated: new Date() };
        renderBoxUI();
    }
    function closeBox() { currentBoxId=null; document.getElementById('box-ui').style.display='none'; document.getElementById('scan-ui').style.display='block'; setTimeout(startQR,300); }

    function renderBoxUI() {
        const d = localDB[currentBoxId];
        document.getElementById('disp-id').innerText = currentBoxId;
        document.getElementById('disp-cat').innerText = d.category || "æœªåˆ†é¡";
        document.getElementById('inp-loc').value = d.loc;

        const diff = (new Date() - new Date(d.updated)) / (1000*60*60*24);
        if(diff > 365) document.getElementById('disp-alert').classList.add('show');
        else document.getElementById('disp-alert').classList.remove('show');

        const list = document.getElementById('item-list-container');
        list.innerHTML = "";
        d.items.forEach((item, i) => {
            const row = document.createElement('div');
            row.className = "item-row";
            const tags = (item.t||[]).map(t=>`<span class="tag">${t}</span>`).join("");
            row.innerHTML = `
                <div class="item-name">${item.n} ${tags} <span style="font-weight:normal; font-size:0.8rem;">x${item.c}</span></div>
                <button class="btn-sub" style="width:auto; padding:4px 10px; height:30px; margin:0;" onclick="delItem(${i})">å‰Šé™¤</button>`;
            list.appendChild(row);
        });
    }

    // --- ã‚¢ã‚¤ãƒ†ãƒ æ“ä½œ ---
    function addItem() {
        const val = document.getElementById('inp-name').value.trim();
        if(!val) return;
        const tags = val.match(/#[^\s]+/g) || [];
        const name = val.replace(/#[^\s]+/g, "").trim();
        localDB[currentBoxId].items.push({ n:name, c:1, t:tags });
        document.getElementById('inp-name').value = "";
        saveBox(); renderBoxUI();
    }
    function delItem(i) {
        if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            localDB[currentBoxId].items.splice(i, 1);
            saveBox(); renderBoxUI();
        }
    }
    async function deleteBox() {
        if(!confirm("ç®±ã”ã¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        delete localDB[currentBoxId];
        await pushData({ action:'delete', boxId:currentBoxId });
        alert("å‰Šé™¤ã—ã¾ã—ãŸ"); closeBox();
    }
    function saveBox() {
        const d = localDB[currentBoxId];
        d.loc = document.getElementById('inp-loc').value;
        d.updated = new Date();
        pushData({ action:'save', boxId:currentBoxId, location:d.loc, items:d.items, category:d.category });
    }

    // --- æ¤œç´¢æ©Ÿèƒ½ (åˆ†é›¢ç‰ˆ) ---
    // 1. ãŠã™ã™ã‚ç®±æ¤œç´¢ (ææ¡ˆ)
    function findSuggestion() {
        const query = document.getElementById('suggest-input').value.trim();
        const res = document.getElementById('suggest-res');
        if(!query) return;
        
        let hits = [];
        // ã‚«ãƒ†ã‚´ãƒªæ¨å®š
        let targetCat = "";
        Object.keys(DICTIONARY).forEach(cat => {
            if(DICTIONARY[cat].some(w => query.includes(w))) targetCat = cat;
        });

        Object.keys(localDB).forEach(id => {
            const box = localDB[id];
            let score = 0;
            if(box.category === targetCat) score += 10;
            if(box.category.includes(query)) score += 10;
            if(box.items.some(i => i.n.includes(query))) score += 5;
            if(score > 0) hits.push({ id, loc: box.loc, cat: box.category, score });
        });

        hits.sort((a,b) => b.score - a.score);
        if(hits.length > 0) {
            res.innerHTML = "<b>ğŸ’¡ ã“ã®ç®±ãŒãŠã™ã™ã‚:</b><br>" + hits.slice(0,3).map(h => 
                `ãƒ»<span style="color:var(--primary); font-weight:bold; cursor:pointer;" onclick="tab('scan'); openBox('${h.id}')">${h.id}</span> (${h.cat}) @${h.loc}`
            ).join("<br>");
        } else {
            res.innerText = "ğŸ’¡ è©²å½“ã™ã‚‹ç®±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ–°ã—ã„ç®±ã‚’ä½¿ã„ã¾ã—ã‚‡ã†ã€‚";
        }
    }

    // 2. ãƒœãƒƒã‚¯ã‚¹ä¸€è¦§æ¤œç´¢ (ã‚ã„ã¾ã„æ¤œç´¢)
    function renderList() {
        const key = document.getElementById('filter-input').value.toLowerCase();
        const cont = document.getElementById('list-container');
        cont.innerHTML="";
        
        // è¾æ›¸å±•é–‹
        let words = [key];
        if(key) {
            Object.keys(DICTIONARY).forEach(cat => {
                if(cat.includes(key) || DICTIONARY[cat].some(w=>w.includes(key))) {
                    words = words.concat(DICTIONARY[cat]);
                }
            });
        }

        Object.keys(localDB).forEach(id => {
            const d = localDB[id];
            const boxStr = `${id} ${d.loc} ${d.category}`.toLowerCase();
            const itmsStr = d.items.map(i=>i.n+(i.t||[]).join("")).join(" ").toLowerCase();
            
            let match = false;
            if(!key) match=true;
            else {
                for(let w of words) {
                    if(boxStr.includes(w) || itmsStr.includes(w)) { match=true; break; }
                }
            }

            if(match) {
                const div = document.createElement('div');
                div.className = "box-row";
                const prev = d.items.slice(0,3).map(i=>i.n).join(", ")+(d.items.length>3?"...":"");
                let locH = d.loc; if(key && locH.toLowerCase().includes(key)) locH = `<span class="hl">${locH}</span>`;
                
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between;">
                        <div><span class="box-id">${id}</span> <span class="box-cat">${d.category||'æœª'}</span></div>
                        <div style="font-size:0.8rem; color:#64748b;">@${locH}</div>
                    </div>
                    <div style="font-size:0.85rem; color:#334155; margin-top:5px;">${prev}</div>
                `;
                div.onclick = () => { tab('scan'); openBox(id); };
                cont.appendChild(div);
            }
        });
    }

    // --- ã‚«ãƒ¡ãƒ©/éŸ³å£° (ãƒ‡ã‚¶ã‚¤ãƒ³ä¿®æ­£ç‰ˆ) ---
    let aiStream=null, lastVoiceT=0, lastSpoken="";
    let isVoiceOnly=false;

    async function startNormalCamera() {
        if(!aiModel) aiModel = await mobilenet.load();
        document.getElementById('cam-ui').style.display='block';
        aiStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
        document.getElementById('cam-video').srcObject = aiStream;
        loopAI();
    }
    async function loopAI() {
        const v = document.getElementById('cam-video');
        if(v.readyState===4 && document.getElementById('cam-ui').style.display!=='none') {
            const p = await aiModel.classify(v);
            if(p.length>0) document.getElementById('ai-hint').innerText = "AIäºˆæ¸¬: " + p[0].className;
        }
        if(aiStream) requestAnimationFrame(loopAI);
    }
    async function snapAI() {
        const h = document.getElementById('ai-hint').innerText;
        if(h.includes("AIäºˆæ¸¬:")) {
            const en = h.split(": ")[1];
            const res = await fetch(`${GAS_URL}?action=translate&text=${en}&password=${password}`);
            const j = await res.json();
            const n = prompt("ç™»éŒ²å:", j.translated);
            if(n) { localDB[currentBoxId].items.push({n:n,c:1,t:[]}); saveBox(); renderBoxUI(); stopCam(); }
        }
    }
    function stopCam() { if(aiStream) aiStream.getTracks().forEach(t=>t.stop()); aiStream=null; document.getElementById('cam-ui').style.display='none'; }

    async function startFastMode(voiceOnly) {
        isVoiceOnly = voiceOnly;
        if(!voiceOnly && !aiModel) aiModel = await mobilenet.load();

        document.getElementById('fast-mode-ui').style.display = 'flex';
        const v = document.getElementById('fast-video');
        const icon = document.getElementById('voice-only-icon');
        const line = document.getElementById('scan-line');

        if(voiceOnly) {
            v.style.display='none'; line.style.display='none'; icon.style.display='block';
            document.getElementById('fast-log').innerText = "éŸ³å£°å¾…æ©Ÿä¸­...";
        } else {
            v.style.display='block'; line.style.display='block'; icon.style.display='none';
            try {
                aiStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                v.srcObject = aiStream;
                loopFastAI();
            } catch(e){}
        }
        startVoiceRec();
    }
    function startVoiceOnlyMode() { startFastMode(true); }

    let recognition = null;
    function startVoiceRec() {
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(SR) {
            recognition = new SR();
            recognition.lang = 'ja-JP'; recognition.continuous = true; recognition.interimResults = false;
            recognition.onend = () => { if(document.getElementById('fast-mode-ui').style.display==='flex') try{recognition.start()}catch(e){} };
            recognition.onresult = (e) => {
                const t = e.results[e.results.length-1][0].transcript.trim();
                handleFast(t, false);
            };
            try{recognition.start()}catch(e){}
        }
    }

    async function loopFastAI() {
        if(document.getElementById('fast-mode-ui').style.display==='none' || isVoiceOnly) return;
        const v = document.getElementById('fast-video');
        const now = Date.now();
        if(v.readyState===4 && (now - lastVoiceT > 1500)) {
            const p = await aiModel.classify(v);
            if(p.length>0 && p[0].probability>0.65) {
                const ja = await translate(p[0].className);
                if(Date.now() - lastVoiceT > 1500) handleFast(ja, true);
            }
        }
        if(aiStream) requestAnimationFrame(loopFastAI);
    }
    async function translate(text) {
        try {
            const res = await fetch(`${GAS_URL}?action=translate&text=${text}&password=${password}`);
            const j = await res.json();
            return j.translated;
        } catch(e){ return text; }
    }
    function handleFast(t, isAI) {
        if(t==="çµ‚äº†") { stopFastMode(); return; }
        if(t===lastSpoken) return;
        if(!isAI) lastVoiceT = Date.now();
        lastSpoken = t;
        localDB[currentBoxId].items.push({n:t,c:1,t:[]});
        document.getElementById('fast-log').innerText = `ç™»éŒ²: ${t} ${isAI?'(AI)':'(éŸ³å£°)'}`;
    }
    function stopFastMode() {
        if(aiStream) aiStream.getTracks().forEach(t=>t.stop());
        if(recognition) recognition.stop();
        aiStream = null;
        document.getElementById('fast-mode-ui').style.display = 'none';
        saveBox(); renderBoxUI();
    }

    // --- å°åˆ· (A4 1æš å³å¯†å¯¾å¿œ) ---
    function printQR() {
        // å˜ä½“å°åˆ·
        const a=document.getElementById('print-area'); a.style.display='block'; a.className='mode-single';
        a.innerHTML=`<div class="print-card"><div class="print-id">${currentBoxId}</div><div id="pq"></div></div>`;
        new QRCode(document.getElementById("pq"),{text:currentBoxId,width:256,height:256});
        setTimeout(()=>{window.print();a.style.display='none'},500);
    }
    function bulkPrint() {
        // 8é¢å°åˆ·
        const a=document.getElementById('print-area'); a.style.display='grid'; a.className='mode-bulk';
        a.innerHTML="";
        for(let i=0; i<8; i++) {
            let id='BOX-'+Math.floor(1000+Math.random()*9000);
            while(localDB[id]) id='BOX-'+Math.floor(1000+Math.random()*9000);
            const d=document.createElement('div'); d.className='print-card';
            d.innerHTML=`<div class="print-id">${id}</div><div id="pq${i}"></div>`;
            a.appendChild(d);
            new QRCode(document.getElementById(`pq${i}`),{text:id,width:128,height:128});
        }
        setTimeout(()=>{window.print();a.style.display='none'},500);
    }

</script>
</body>
</html>
