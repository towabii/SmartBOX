<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Smart Box V4.1 (Fix)</title>
    
    <!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@latest"></script>

    <style>
        :root { --primary: #2563eb; --accent: #f59e0b; --danger: #ef4444; --bg: #f3f4f6; --text: #1f2937; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; padding: 0; background: var(--bg); color: var(--text); padding-bottom: 90px; user-select: none; }
        
        header { background: var(--primary); color: white; padding: 15px; position: sticky; top: 0; z-index: 100; display:flex; justify-content:space-between; align-items:center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { margin: 0; font-size: 1.1rem; font-weight: 700; }
        
        .container { max-width: 600px; margin: 0 auto; padding: 15px; }
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        
        input, select { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #e5e7eb; border-radius: 8px; background: #f9fafb; box-sizing: border-box; font-size: 1rem; }
        
        button { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 0.95rem; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        button.primary { background: var(--primary); color: white; }
        button.accent { background: var(--accent); color: white; }
        button.secondary { background: #e5e7eb; color: #4b5563; }
        button.danger { background: var(--danger); color: white; }
        button.icon-btn { width: auto; padding: 8px 12px; font-size: 1.2rem; background: transparent; color: var(--primary); border: 1px solid var(--primary); margin: 0; }
        button:active { transform: scale(0.98); opacity: 0.9; }

        /* ã‚¿ãƒ–åˆ‡æ›¿ */
        .view { display: none; animation: fadeIn 0.2s; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #e5e7eb; display: flex; padding-bottom: env(safe-area-inset-bottom); z-index: 1000; }
        .nav-item { flex: 1; text-align: center; padding: 10px 0; color: #9ca3af; font-size: 0.7rem; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-icon { font-size: 1.4rem; display: block; margin-bottom: 2px; }

        /* ãƒªã‚¹ãƒˆãƒ»è©³ç´°ç³» */
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f3f4f6; }
        .num-circle { display: inline-flex; width: 22px; height: 22px; background: var(--primary); color: white; border-radius: 50%; font-size: 0.75rem; align-items: center; justify-content: center; margin-right: 8px; }
        
        .box-row { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .box-tag { font-size: 0.75rem; background: #e0f2fe; color: #0284c7; padding: 2px 6px; border-radius: 4px; margin-left: 5px; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« (è©³ç´°é–²è¦§ç”¨) */
        #detail-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; justify-content: center; align-items: flex-end; }
        .modal-content { background: white; width: 100%; max-width: 600px; border-radius: 15px 15px 0 0; padding: 20px; box-sizing: border-box; max-height: 85vh; overflow-y: auto; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* ææ¡ˆãƒœãƒƒã‚¯ã‚¹ */
        #suggestion-area { background: #ecfdf5; border: 1px solid #6ee7b7; color: #065f46; padding: 10px; border-radius: 8px; margin-bottom: 15px; display: none; }

        /* é«˜é€Ÿ/éŸ³å£°ãƒ¢ãƒ¼ãƒ‰UI */
        #fast-mode-ui { position: fixed; top:0; left:0; width:100%; height:100%; background: #000; z-index: 1500; display:none; flex-direction:column; }
        #fast-video { width: 100%; height: 100%; object-fit: cover; }
        .fast-overlay { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.8); padding: 20px; text-align: center; color: white; box-sizing: border-box; }
        .scan-line { position: absolute; top: 50%; width: 100%; height: 2px; background: cyan; box-shadow: 0 0 10px cyan; }
        
        /* å°åˆ· */
        #print-area { display: none; }
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; top: 0; left: 0; width: 100%; height: 100vh; padding: 10px; box-sizing: border-box; }
            #print-area.mode-bulk { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: repeat(4, 1fr); gap: 15px; }
            #print-area.mode-single { display: flex; flex-direction: column; justify-content: center; align-items: center; }
            .print-card { border: 2px solid #000; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; page-break-inside: avoid; border-radius: 8px; }
            .print-id { font-size: 2rem; font-weight: bold; margin-bottom: 10px; }
            .mode-single .print-id { font-size: 4rem; margin-bottom: 30px; }
        }
    </style>
</head>
<body>

<header>
    <h1>ğŸ“¦ Smart Box V4.1</h1>
    <span id="status-badge" style="font-size:0.8rem; background:rgba(255,255,255,0.2); padding:2px 8px; border-radius:4px;">Ready</span>
</header>

<div class="container">

    <!-- 1. ã‚¹ã‚­ãƒ£ãƒ³ & ç·¨é›† (Edit Mode) -->
    <div id="view-scan" class="view active">
        <div id="scan-ui" class="card">
            <h3 style="text-align:center; margin:0 0 10px 0;">QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³</h3>
            <div id="reader" style="border-radius:8px; overflow:hidden; background:#000;"></div>
            <p style="text-align:center; color:#666; font-size:0.8rem; margin-top:10px;">ç·¨é›†ãƒ»è¿½åŠ ã¯ã“ã“ã‹ã‚‰</p>
        </div>

        <div id="box-ui" class="card" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #eee; padding-bottom:10px; margin-bottom:10px;">
                <div>
                    <div id="disp-id" style="font-size:1.4rem; font-weight:900; color:var(--primary);">BOX-ID</div>
                    <span id="disp-cat" style="font-size:0.8rem; background:#eee; padding:3px 8px; border-radius:4px;">ã‚«ãƒ†ã‚´ãƒª</span>
                </div>
                <button class="icon-btn" onclick="printCurrentBoxQR()">ğŸ–¨ï¸</button>
            </div>
            
            <input type="text" id="inp-loc" placeholder="ä¿ç®¡å ´æ‰€ (ä¾‹: 2éš ã‚¯ãƒ­ãƒ¼ã‚¼ãƒƒãƒˆ)" onchange="saveBox()">
            
            <div style="max-height:200px; overflow-y:auto; margin-bottom:15px; border:1px solid #eee; border-radius:8px; padding:5px;">
                <div id="item-list"></div>
            </div>

            <!-- ã‚¢ã‚¤ãƒ†ãƒ è¿½åŠ ã‚¨ãƒªã‚¢ -->
            <div style="background:#f9fafb; padding:10px; border-radius:8px;">
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <input type="text" id="inp-bulk-name" placeholder="å“å (ä¾‹: PC)" style="flex:2; margin:0;">
                    <input type="number" id="inp-bulk-count" value="1" min="1" style="flex:1; margin:0;">
                    <button class="primary" onclick="addBulkItems()" style="width:auto; margin:0;">ï¼‹</button>
                </div>

                <!-- ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ -->
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                    <button class="secondary" onclick="startNormalCamera()">ğŸ“· é€šå¸¸è­˜åˆ¥</button>
                    <button class="accent" onclick="startFastMode()">ğŸš€ ã‚«ãƒ¡ãƒ©+éŸ³å£°</button>
                </div>
                <button class="primary" onclick="startVoiceOnlyMode()" style="background:#10b981;">ğŸ¤ éŸ³å£°ã®ã¿ãƒ¢ãƒ¼ãƒ‰</button>
                
                <!-- é€šå¸¸ã‚«ãƒ¡ãƒ©ã‚¨ãƒªã‚¢ -->
                <div id="normal-camera-area" style="display:none; margin-top:10px;">
                    <video id="normal-video" autoplay playsinline muted style="width:100%; border-radius:8px;"></video>
                    <div id="ai-hint" style="text-align:center; font-size:0.9rem; color:var(--primary); margin:5px 0;">AIæº–å‚™ä¸­...</div>
                    <button class="primary" onclick="snapAndRegister()">ã“ã‚Œã‚’å…¥ã‚Œã‚‹ï¼</button>
                    <button class="secondary" onclick="stopNormalCamera()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </div>
            
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="secondary" onclick="closeBox()">é–‰ã˜ã‚‹</button>
                <button class="danger" onclick="deleteBox()">ğŸ—‘ï¸ ç®±ã‚’å‰Šé™¤</button>
            </div>
        </div>
    </div>

    <!-- 2. ä¸€è¦§ & æ¤œç´¢ (List View) -->
    <div id="view-list" class="view">
        <div class="card">
            <!-- ã©ã“ã«å…¥ã‚Œã‚‹ï¼Ÿææ¡ˆæ©Ÿèƒ½ -->
            <div style="background:#f0f9ff; padding:10px; border-radius:8px; border:1px solid #bae6fd; margin-bottom:10px;">
                <label style="font-size:0.8rem; color:#0369a1; font-weight:bold;">ã©ã“ã«å…¥ã‚Œã‚Œã°ã„ã„ï¼Ÿ</label>
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <input type="text" id="inp-suggest" placeholder="å“å (ä¾‹: ãƒã‚¦ã‚¹)" style="margin:0;">
                    <button class="primary" onclick="findSuggestion()" style="width:auto; margin:0;">æ¤œç´¢</button>
                </div>
                <div id="suggestion-area"></div>
            </div>

            <input type="text" id="filter-input" placeholder="ğŸ” ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢..." onkeyup="renderList()">
            <div id="list-container"></div>
        </div>
    </div>

    <!-- 3. è¨­å®šãƒ»å°åˆ· -->
    <div id="view-settings" class="view">
        <div class="card">
            <h3>ğŸ–¨ï¸ QRä¸€æ‹¬å°åˆ·</h3>
            <button class="primary" onclick="generateBulkPrint()">A4å°åˆ· (8é¢)</button>
        </div>
        <div class="card">
            <h3>ãƒ‡ãƒ¼ã‚¿åŒæœŸ</h3>
            <button class="secondary" onclick="fetchData(true)">â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰æ›´æ–°</button>
        </div>
    </div>

</div>

<!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
<div class="nav">
    <div class="nav-item active" onclick="switchTab('scan')"><span class="nav-icon">ğŸ“·</span>ç·¨é›†/è¿½åŠ </div>
    <div class="nav-item" onclick="switchTab('list')"><span class="nav-icon">ğŸ“¦</span>ä¸€è¦§/ææ¡ˆ</div>
    <div class="nav-item" onclick="switchTab('settings')"><span class="nav-icon">âš™ï¸</span>è¨­å®š</div>
</div>

<!-- è©³ç´°é–²è¦§ãƒ¢ãƒ¼ãƒ€ãƒ« (Read-Only) -->
<div id="detail-modal" onclick="closeDetailModal(event)">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 id="modal-id" style="margin:0; color:var(--primary);">BOX-ID</h2>
            <span id="modal-cat" style="background:#eee; padding:4px 8px; border-radius:4px; font-size:0.8rem;">ã‚«ãƒ†ã‚´ãƒª</span>
        </div>
        <p id="modal-loc" style="color:#666; margin:5px 0 15px 0;">å ´æ‰€</p>
        
        <div style="border-top:1px solid #eee; padding-top:10px;">
            <ul id="modal-items" style="padding-left:20px; margin:0;"></ul>
        </div>
        
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button class="primary" onclick="editFromModal()">âœï¸ ç·¨é›†ãƒ»è¿½åŠ ã™ã‚‹</button>
            <button class="secondary" onclick="document.getElementById('detail-modal').style.display='none'">é–‰ã˜ã‚‹</button>
        </div>
    </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ‰UI (é«˜é€Ÿ/éŸ³å£°) -->
<div id="fast-mode-ui">
    <div style="flex:1; position:relative; overflow:hidden; display:flex; justify-content:center; align-items:center;">
        <video id="fast-video" autoplay playsinline muted></video>
        <!-- éŸ³å£°ã®ã¿ãƒ¢ãƒ¼ãƒ‰ã®æ™‚ã¯ãƒ“ãƒ‡ã‚ªã‚’æ¶ˆã—ã¦ã‚¢ã‚¤ã‚³ãƒ³ã‚’å‡ºã™ -->
        <div id="voice-only-icon" style="display:none; font-size:5rem; color:white;">ğŸ¤</div>
        <div class="scan-line" id="scan-line"></div>
    </div>
    <div class="fast-overlay">
        <div id="fast-log" style="color:#0f0; font-family:monospace; margin-bottom:10px;">å¾…æ©Ÿä¸­...</div>
        <button class="secondary" onclick="stopFastMode()">çµ‚äº†ã—ã¦ä¿å­˜</button>
    </div>
</div>

<div id="print-area"></div>

<script>
    // â–¼â–¼â–¼ GASã®URLã‚’è²¼ã‚Šä»˜ã‘ â–¼â–¼â–¼
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzlI2y972-VVGC9VEoyj7yaxHF_RY5evr4ZvTU6Fa5QvHo_D1iNReMJ8vC6shlp2cC6CQ/exec"; 
    // â–²â–²â–² â–²â–²â–² â–²â–²â–²

    let localDB = {}; 
    let currentBoxId = null;
    let qrScanner = null;
    let aiModel = null;
    let audioCtx = null;
    
    // ã‚«ãƒ¡ãƒ©ã®çŠ¶æ…‹ç®¡ç†ç”¨
    let isStopping = false;

    window.onload = async () => {
        if(GAS_URL.includes("URL")) alert("GASã®URLã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼");
        await fetchData();
        initAudio();
        renderList();
        // åˆæœŸçŠ¶æ…‹ã®ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹
        if(document.getElementById('view-scan').classList.contains('active')) {
            setTimeout(startQR, 500);
        }
    };

    function initAudio() {
        const AC = window.AudioContext || window.webkitAudioContext;
        if (AC) audioCtx = new AC();
    }
    function beep() {
        if(!audioCtx) initAudio();
        if(audioCtx && audioCtx.state==='suspended') audioCtx.resume();
        const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        o.frequency.setValueAtTime(880, audioCtx.currentTime);
        g.gain.setValueAtTime(0.1, audioCtx.currentTime);
        o.start(); o.stop(audioCtx.currentTime+0.1);
    }

    async function fetchData(force=false) {
        document.getElementById('status-badge').innerText = "Syncing...";
        try {
            const res = await fetch(GAS_URL);
            localDB = await res.json();
            document.getElementById('status-badge').innerText = "Sync OK";
            if(force) { alert("æ›´æ–°å®Œäº†"); renderList(); }
        } catch(e) { document.getElementById('status-badge').innerText = "Error"; }
    }

    async function pushData(payload) {
        document.getElementById('status-badge').innerText = "Saving...";
        try {
            await fetch(GAS_URL, {
                method: 'POST',
                headers: { "Content-Type": "text/plain" },
                body: JSON.stringify(payload)
            });
            document.getElementById('status-badge').innerText = "Saved";
        } catch(e) { document.getElementById('status-badge').innerText = "Save Error"; }
    }

    async function translate(text) {
        try {
            const res = await fetch(`${GAS_URL}?action=translate&text=${encodeURIComponent(text)}`);
            const json = await res.json();
            return json.translated.split(/[,\n]/)[0]; 
        } catch(e) { return text; }
    }

    function switchTab(tab) {
        document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        document.getElementById('view-'+tab).classList.add('active');
        document.querySelectorAll('.nav-item')[['scan','list','settings'].indexOf(tab)].classList.add('active');
        
        if(tab==='scan') {
            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆå®Œäº†ã‚’å¾…ã£ã¦ã‹ã‚‰ã‚«ãƒ¡ãƒ©èµ·å‹•ï¼ˆé‡è¦ï¼‰
            setTimeout(startQR, 300);
        } else {
            stopQR();
        }
        
        if(tab==='list') renderList();
    }

    // --- QRå‡¦ç† (ä¿®æ­£ç‰ˆ) ---
    function startQR() {
        if(currentBoxId) return; // ç·¨é›†ä¸­ã®å ´åˆã¯èµ·å‹•ã—ãªã„
        if(isStopping) {
            // åœæ­¢å‡¦ç†ä¸­ã®å ´åˆã¯å°‘ã—å¾…ã£ã¦å†è©¦è¡Œ
            setTimeout(startQR, 200);
            return;
        }
        if(qrScanner) return; // æ—¢ã«èµ·å‹•ä¸­ãªã‚‰ä½•ã‚‚ã—ãªã„

        // è¦ç´ ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
        const reader = document.getElementById("reader");
        if (!reader || reader.offsetParent === null) {
            return; // éè¡¨ç¤ºãªã‚‰èµ·å‹•ã—ãªã„
        }

        const scanner = new Html5Qrcode("reader");
        scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
            (decoded) => { beep(); openBox(decoded); })
        .then(() => {
            qrScanner = scanner;
        })
        .catch(err => {
            console.log("Start failed, retrying...", err);
            // èµ·å‹•ã«å¤±æ•—ã—ãŸå ´åˆï¼ˆã‚¿ãƒ–åˆ‡æ›¿ã®ç«¶åˆãªã©ï¼‰ã€å°‘ã—å¾…ã£ã¦å†è©¦è¡Œ
            setTimeout(() => {
                if(!qrScanner && !isStopping && document.getElementById('view-scan').classList.contains('active')) {
                    startQR();
                }
            }, 500);
        });
    }

    function stopQR() {
        if(qrScanner) {
            isStopping = true;
            qrScanner.stop().then(() => {
                qrScanner.clear();
                qrScanner = null;
                isStopping = false;
            }).catch(err => {
                console.log("Stop failed", err);
                isStopping = false;
                qrScanner = null; // å¼·åˆ¶ã‚¯ãƒªã‚¢
            });
        }
    }

    function openBox(id) {
        stopQR();
        currentBoxId = id;
        document.getElementById('scan-ui').style.display = 'none';
        document.getElementById('box-ui').style.display = 'block';
        if(!localDB[id]) localDB[id] = { loc: "", items: [], category: "æœªåˆ†é¡" };
        renderBoxEdit();
    }

    function renderBoxEdit() {
        const d = localDB[currentBoxId];
        document.getElementById('disp-id').innerText = currentBoxId;
        document.getElementById('disp-cat').innerText = d.category || "æœªåˆ†é¡";
        document.getElementById('inp-loc').value = d.loc;
        const list = document.getElementById('item-list');
        list.innerHTML = "";
        d.items.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = 'item-row';
            div.innerHTML = `<div><span class="num-circle">${getDupCount(item, d.items, idx)}</span> ${item}</div>
                <button class="secondary" style="width:auto;margin:0;padding:5px 10px;" onclick="delItem(${idx})">å‰Šé™¤</button>`;
            list.appendChild(div);
        });
    }

    function getDupCount(item, arr, idx) {
        let c = 0; for(let i=0; i<=idx; i++) if(arr[i]===item) c++; return c;
    }

    function addBulkItems() {
        const name = document.getElementById('inp-bulk-name').value.trim();
        const count = parseInt(document.getElementById('inp-bulk-count').value);
        if(!name || count < 1) return;
        for(let i=0; i<count; i++) localDB[currentBoxId].items.push(name);
        beep(); saveBox(); renderBoxEdit();
        document.getElementById('inp-bulk-name').value = "";
        document.getElementById('inp-bulk-count').value = 1;
    }

    function delItem(idx) {
        if(confirm("ã“ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            localDB[currentBoxId].items.splice(idx, 1);
            saveBox(); renderBoxEdit();
        }
    }

    async function deleteBox() {
        if(!confirm(`æœ¬å½“ã« ${currentBoxId} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nä¸­èº«ã®ãƒ‡ãƒ¼ã‚¿ã‚‚å…¨ã¦æ¶ˆãˆã¾ã™ã€‚`)) return;
        delete localDB[currentBoxId];
        await pushData({ boxId: currentBoxId, action: 'delete' });
        alert("å‰Šé™¤ã—ã¾ã—ãŸ");
        closeBox();
    }

    function saveBox() {
        const d = localDB[currentBoxId];
        d.loc = document.getElementById('inp-loc').value;
        pushData({ boxId: currentBoxId, location: d.loc, items: d.items, category: d.category, action: 'save' });
    }

    function closeBox() {
        currentBoxId = null;
        document.getElementById('box-ui').style.display = 'none';
        document.getElementById('scan-ui').style.display = 'block';
        // ç”»é¢åˆ‡ã‚Šæ›¿ãˆå¾Œã«ã‚«ãƒ¡ãƒ©å†èµ·å‹•
        setTimeout(startQR, 300);
    }

    function findSuggestion() {
        const query = document.getElementById('inp-suggest').value.trim();
        const area = document.getElementById('suggestion-area');
        if(!query) return;

        let candidates = [];
        let targetCat = "";
        if(query.match(/ãƒã‚¦ã‚¹|ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰|PC|USB/i)) targetCat = "PCãƒ»ã‚¬ã‚¸ã‚§ãƒƒãƒˆ";
        else if(query.match(/æœ|ã‚³ãƒ¼ãƒˆ/)) targetCat = "è¡£é¡ãƒ»ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³";

        Object.keys(localDB).forEach(id => {
            const box = localDB[id];
            let score = 0;
            if(box.category === targetCat) score += 10;
            if(targetCat === "" && box.category !== "æœªåˆ†é¡" && box.category !== "ãã®ä»–") {
                 if(box.category.includes(query)) score += 10;
            }
            const hasSimilar = box.items.some(item => item.includes(query) || query.includes(item));
            if(hasSimilar) score += 5;
            if(score > 0) candidates.push({ id, loc: box.loc, cat: box.category, score });
        });

        candidates.sort((a,b) => b.score - a.score);

        if(candidates.length > 0) {
            area.style.display = "block";
            area.innerHTML = "<b>ğŸ’¡ãŠã™ã™ã‚ã®ç®±:</b><br>" + candidates.slice(0, 3).map(c => 
                `ãƒ»<a href="#" onclick="showDetailModal('${c.id}')">${c.id}</a> (${c.cat}) @${c.loc}`
            ).join("<br>");
        } else {
            area.style.display = "block";
            area.innerHTML = "ğŸ’¡ä¸€è‡´ã™ã‚‹ç®±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
        }
    }

    function renderList() {
        const k = document.getElementById('filter-input').value.toLowerCase();
        const c = document.getElementById('list-container');
        c.innerHTML = "";
        
        Object.keys(localDB).forEach(id => {
            const d = localDB[id];
            if(`${id} ${d.loc} ${d.items.join(' ')}`.toLowerCase().includes(k)) {
                const div = document.createElement('div');
                div.className = 'box-row';
                const summary = d.items.length > 0 ? `${d.items[0]} ä»–${d.items.length-1}ç‚¹` : "ç©º";
                div.innerHTML = `
                    <div>
                        <div style="font-weight:bold; color:var(--primary);">${id} <span class="box-tag">${d.category||'æœª'}</span></div>
                        <div style="font-size:0.85rem; color:#666;">@${d.loc}</div>
                    </div>
                    <div style="font-size:0.9rem; color:#333;">${summary}</div>
                `;
                div.onclick = () => showDetailModal(id);
                c.appendChild(div);
            }
        });
    }

    function showDetailModal(id) {
        const d = localDB[id];
        document.getElementById('modal-id').innerText = id;
        document.getElementById('modal-cat').innerText = d.category || "æœªåˆ†é¡";
        document.getElementById('modal-loc').innerText = "ä¿ç®¡å ´æ‰€: " + (d.loc || "æœªè¨­å®š");
        const ul = document.getElementById('modal-items');
        ul.innerHTML = "";
        if(d.items.length === 0) {
            ul.innerHTML = "<li style='color:#999'>ä¸­èº«ã¯ã‚ã‚Šã¾ã›ã‚“</li>";
        } else {
            d.items.forEach(item => {
                const li = document.createElement('li'); li.innerText = item; ul.appendChild(li);
            });
        }
        currentBoxId = id;
        document.getElementById('detail-modal').style.display = "flex";
    }

    function closeDetailModal(e) {
        if(e.target.id === 'detail-modal') {
            document.getElementById('detail-modal').style.display = "none";
            currentBoxId = null;
        }
    }

    function editFromModal() {
        document.getElementById('detail-modal').style.display = "none";
        switchTab('scan');
        openBox(currentBoxId);
    }

    let normalStream=null, fastStream=null, recognition=null;
    let lastVoiceT=0, lastSpoken="";
    let isVoiceOnly = false;

    async function startNormalCamera() {
        if(!aiModel) aiModel = await mobilenet.load();
        document.getElementById('normal-camera-area').style.display = 'block';
        const v = document.getElementById('normal-video');
        normalStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        v.srcObject = normalStream;
        detNormal();
    }
    async function detNormal() {
        if(!normalStream) return;
        const v = document.getElementById('normal-video');
        if(v.readyState===4) {
            const p = await aiModel.classify(v);
            if(p.length>0) document.getElementById('ai-hint').innerText = `AIäºˆæ¸¬: ${p[0].className} ?`;
        }
        requestAnimationFrame(detNormal);
    }
    async function snapAndRegister() {
        const h = document.getElementById('ai-hint').innerText;
        if(h.includes("AIäºˆæ¸¬:")) {
            const ja = await translate(h.replace("AIäºˆæ¸¬: ", "").replace(" ?", ""));
            const n = prompt("ç™»éŒ²å:", ja);
            if(n) { localDB[currentBoxId].items.push(n); beep(); saveBox(); renderBoxEdit(); stopNormalCamera(); }
        }
    }
    function stopNormalCamera() {
        if(normalStream) normalStream.getTracks().forEach(t=>t.stop());
        normalStream = null;
        document.getElementById('normal-camera-area').style.display = 'none';
    }

    async function startFastMode(voiceOnly = false) {
        isVoiceOnly = voiceOnly;
        if(!voiceOnly && !aiModel) aiModel = await mobilenet.load();

        document.getElementById('fast-mode-ui').style.display = 'flex';
        const v = document.getElementById('fast-video');
        const icon = document.getElementById('voice-only-icon');
        const line = document.getElementById('scan-line');

        if(voiceOnly) {
            v.style.display = 'none';
            line.style.display = 'none';
            icon.style.display = 'block';
            document.getElementById('fast-log').innerText = "éŸ³å£°ã®ã¿: å¾…æ©Ÿä¸­...";
        } else {
            v.style.display = 'block';
            line.style.display = 'block';
            icon.style.display = 'none';
            try {
                fastStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                v.srcObject = fastStream;
                loopFastAI();
            } catch(e){}
        }

        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(SR) {
            recognition = new SR();
            recognition.lang = 'ja-JP'; recognition.continuous = true; recognition.interimResults = false;
            recognition.onend = () => { if(document.getElementById('fast-mode-ui').style.display==='flex') try{recognition.start()}catch(e){} };
            recognition.onresult = (e) => {
                const t = e.results[e.results.length-1][0].transcript.trim();
                handleFast(t, false);
            };
            try{recognition.start()}catch(e){}
        }
    }

    function startVoiceOnlyMode() { startFastMode(true); }

    async function loopFastAI() {
        if(document.getElementById('fast-mode-ui').style.display==='none' || isVoiceOnly) return;
        const v = document.getElementById('fast-video');
        const now = Date.now();
        if(v.readyState===4 && (now - lastVoiceT > 1500)) {
            const p = await aiModel.classify(v);
            if(p.length>0 && p[0].probability>0.65) {
                const ja = await translate(p[0].className);
                if(Date.now() - lastVoiceT > 1500) handleFast(ja, true);
            }
        }
        if(fastStream) requestAnimationFrame(loopFastAI);
    }

    function handleFast(t, isAI) {
        if(t==="çµ‚äº†") { stopFastMode(); return; }
        if(t===lastSpoken) return;
        if(!isAI) lastVoiceT = Date.now();
        lastSpoken = t;
        localDB[currentBoxId].items.push(t);
        document.getElementById('fast-log').innerText = `ç™»éŒ²: ${t} ${isAI?'(AI)':'(éŸ³å£°)'}`;
        beep();
    }

    function stopFastMode() {
        if(fastStream) fastStream.getTracks().forEach(t=>t.stop());
        if(recognition) recognition.stop();
        fastStream = null;
        document.getElementById('fast-mode-ui').style.display = 'none';
        saveBox(); renderBoxEdit();
    }

    function printCurrentBoxQR() {
        const area = document.getElementById('print-area');
        area.className = 'mode-single';
        area.innerHTML = `<div class="print-card"><div class="print-id">${currentBoxId}</div><div id="qr-single"></div></div>`;
        new QRCode(document.getElementById("qr-single"), { text: currentBoxId, width: 256, height: 256 });
        setTimeout(() => window.print(), 500);
    }
    function generateBulkPrint() {
        const area = document.getElementById('print-area');
        area.className = 'mode-bulk';
        area.innerHTML = "";
        let count = 0; let generated = [];
        while(count < 8) {
            const rand = 'BOX-' + Math.floor(1000 + Math.random()*9000);
            if(!localDB[rand] && !generated.includes(rand)) { generated.push(rand); count++; }
        }
        generated.forEach(id => {
            const c = document.createElement('div');
            c.className = 'print-card';
            c.innerHTML = `<div class="print-id">${id}</div><div id="qr-${id}"></div>`;
            area.appendChild(c);
            new QRCode(document.getElementById(`qr-${id}`), { text: id, width: 128, height: 128 });
        });
        setTimeout(() => window.print(), 500);
    }
</script>
</body>
</html>
