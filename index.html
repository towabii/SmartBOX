<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Smart Box V3</title>
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@latest"></script>

    <style>
        :root { --primary: #2563eb; --accent: #f59e0b; --bg: #f3f4f6; --text: #1f2937; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; padding: 0; background: var(--bg); color: var(--text); padding-bottom: 90px; user-select: none; }
        header { background: var(--primary); color: white; padding: 15px; position: sticky; top: 0; z-index: 100; display:flex; justify-content:space-between; align-items:center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { margin: 0; font-size: 1.1rem; font-weight: 700; }
        .container { max-width: 600px; margin: 0 auto; padding: 15px; }
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        input, select { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #e5e7eb; border-radius: 8px; background: #f9fafb; box-sizing: border-box; font-size: 1rem; }
        button { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 0.95rem; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        button.primary { background: var(--primary); color: white; }
        button.accent { background: var(--accent); color: white; }
        button.secondary { background: #e5e7eb; color: #4b5563; }
        button.icon-btn { width: auto; padding: 8px 12px; font-size: 1.2rem; background: transparent; color: var(--primary); border: 1px solid var(--primary); margin: 0; }
        button:active { transform: scale(0.98); opacity: 0.9; }
        
        .view { display: none; animation: fadeIn 0.2s; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #e5e7eb; display: flex; padding-bottom: env(safe-area-inset-bottom); z-index: 1000; }
        .nav-item { flex: 1; text-align: center; padding: 10px 0; color: #9ca3af; font-size: 0.7rem; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-icon { font-size: 1.4rem; display: block; margin-bottom: 2px; }

        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f3f4f6; }
        .num-circle { display: inline-flex; width: 22px; height: 22px; background: var(--primary); color: white; border-radius: 50%; font-size: 0.75rem; align-items: center; justify-content: center; margin-right: 8px; }
        .box-row { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; }

        /* é«˜é€Ÿãƒ¢ãƒ¼ãƒ‰UI */
        #fast-mode-ui { position: fixed; top:0; left:0; width:100%; height:100%; background: #000; z-index: 1500; display:none; flex-direction:column; }
        #fast-video { width: 100%; height: 100%; object-fit: cover; }
        .fast-overlay { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.8); padding: 20px; text-align: center; color: white; box-sizing: border-box; }
        .scan-line { position: absolute; top: 50%; width: 100%; height: 2px; background: cyan; box-shadow: 0 0 10px cyan; }
        
        /* å°åˆ· */
        #print-area { display: none; }
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; top: 0; left: 0; width: 100%; height: 100vh; padding: 10px; box-sizing: border-box; }
            #print-area.mode-bulk { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: repeat(4, 1fr); gap: 15px; }
            #print-area.mode-single { display: flex; flex-direction: column; justify-content: center; align-items: center; }
            .print-card { border: 2px solid #000; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; page-break-inside: avoid; border-radius: 8px; }
            .print-id { font-size: 2rem; font-weight: bold; margin-bottom: 10px; }
            .mode-single .print-id { font-size: 4rem; margin-bottom: 30px; }
        }
    </style>
</head>
<body>

<header>
    <h1>ğŸ“¦ Smart Box V3</h1>
    <span id="status-badge" style="font-size:0.8rem; background:rgba(255,255,255,0.2); padding:2px 8px; border-radius:4px;">Ready</span>
</header>

<div class="container">

    <!-- 1. ã‚¹ã‚­ãƒ£ãƒ³ & ãƒœãƒƒã‚¯ã‚¹è©³ç´° -->
    <div id="view-scan" class="view active">
        <div id="scan-ui" class="card">
            <h3 style="text-align:center; margin:0 0 10px 0;">QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³</h3>
            <div id="reader" style="border-radius:8px; overflow:hidden; background:#000;"></div>
            <p style="text-align:center; color:#666; font-size:0.8rem; margin-top:10px;">ã¾ãŸã¯ä¸‹ã®ã€Œä¸€è¦§ã€ã‹ã‚‰é¸æŠ</p>
        </div>

        <div id="box-ui" class="card" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #eee; padding-bottom:10px; margin-bottom:10px;">
                <div>
                    <div id="disp-id" style="font-size:1.4rem; font-weight:900; color:var(--primary);">BOX-ID</div>
                    <span id="disp-cat" style="font-size:0.8rem; background:#eee; padding:3px 8px; border-radius:4px;">ã‚«ãƒ†ã‚´ãƒª</span>
                </div>
                <button class="icon-btn" onclick="printCurrentBoxQR()">ğŸ–¨ï¸</button>
            </div>
            
            <input type="text" id="inp-loc" placeholder="ä¿ç®¡å ´æ‰€ (ä¾‹: 2éš ã‚¯ãƒ­ãƒ¼ã‚¼ãƒƒãƒˆ)" onchange="saveBox()">
            
            <div style="max-height:200px; overflow-y:auto; margin-bottom:15px; border:1px solid #eee; border-radius:8px; padding:5px;">
                <div id="item-list"></div>
            </div>

            <div style="background:#f9fafb; padding:10px; border-radius:8px;">
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <input type="text" id="inp-bulk-name" placeholder="å“å (ä¾‹: PC)" style="flex:2; margin:0;">
                    <input type="number" id="inp-bulk-count" value="1" min="1" style="flex:1; margin:0;">
                    <button class="primary" onclick="addBulkItems()" style="width:auto; margin:0;">ï¼‹</button>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <button class="secondary" onclick="startNormalCamera()">ğŸ“· é€šå¸¸è­˜åˆ¥</button>
                    <button class="accent" onclick="startFastMode()">ğŸš€ éŸ³å£°å„ªå…ˆ</button>
                </div>
                
                <div id="normal-camera-area" style="display:none; margin-top:10px;">
                    <video id="normal-video" autoplay playsinline muted style="width:100%; border-radius:8px;"></video>
                    <div id="ai-hint" style="text-align:center; font-size:0.9rem; color:var(--primary); margin:5px 0;">AIæº–å‚™ä¸­...</div>
                    <button class="primary" onclick="snapAndRegister()">ã“ã‚Œã‚’å…¥ã‚Œã‚‹ï¼</button>
                    <button class="secondary" onclick="stopNormalCamera()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </div>
            
            <button class="secondary" onclick="closeBox()" style="margin-top:10px;">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <!-- 2. ä¸€è¦§ç”»é¢ -->
    <div id="view-list" class="view">
        <div class="card">
            <input type="text" id="filter-input" placeholder="ğŸ” åå‰ã€å ´æ‰€ã€IDã§æ¤œç´¢..." onkeyup="renderList()">
            <div id="list-container"></div>
        </div>
    </div>

    <!-- 3. è¨­å®šãƒ»å°åˆ· -->
    <div id="view-settings" class="view">
        <div class="card">
            <h3>ğŸ–¨ï¸ QRä¸€æ‹¬å°åˆ·</h3>
            <button class="primary" onclick="generateBulkPrint()">A4å°åˆ· (8é¢)</button>
        </div>
        <div class="card">
            <h3>ãƒ‡ãƒ¼ã‚¿åŒæœŸ</h3>
            <button class="secondary" onclick="fetchData(true)">â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰æ›´æ–°</button>
        </div>
    </div>

</div>

<div class="nav">
    <div class="nav-item active" onclick="switchTab('scan')"><span class="nav-icon">ğŸ“·</span>ã‚¹ã‚­ãƒ£ãƒ³</div>
    <div class="nav-item" onclick="switchTab('list')"><span class="nav-icon">ğŸ“¦</span>ä¸€è¦§</div>
    <div class="nav-item" onclick="switchTab('settings')"><span class="nav-icon">âš™ï¸</span>è¨­å®š</div>
</div>

<div id="fast-mode-ui">
    <div style="flex:1; position:relative; overflow:hidden;">
        <video id="fast-video" autoplay playsinline muted></video>
        <div class="scan-line"></div>
    </div>
    <div class="fast-overlay">
        <div id="fast-log" style="color:#0f0; font-family:monospace; margin-bottom:10px;">éŸ³å£°: å¾…æ©Ÿä¸­...</div>
        <button class="secondary" onclick="stopFastMode()">çµ‚äº†ã—ã¦ä¿å­˜</button>
    </div>
</div>

<div id="print-area"></div>

<script>
    // â–¼â–¼â–¼ ã“ã“ã«GASã®URLã‚’è²¼ã‚Šä»˜ã‘ â–¼â–¼â–¼
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyz0WctGJaJuhzUJxvMGUfX6asMQOygxuASZekhBJs-t3ghcvZafK0CxtUHlQJF7DLCiA/exec"; 
    // â–²â–²â–² â–²â–²â–² â–²â–²â–²

    let localDB = {}; 
    let currentBoxId = null;
    let qrScanner = null;
    let aiModel = null;
    let audioCtx = null;

    window.onload = async () => {
        if(GAS_URL.includes("URL")) alert("GASã®URLã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼");
        await fetchData(); // èµ·å‹•æ™‚ã«ä¸€è¦§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹
        initAudio();
        renderList(); // ä¸€è¦§ã‚’æç”»ã—ã¦ãŠã
    };

    function initAudio() {
        const AC = window.AudioContext || window.webkitAudioContext;
        if (AC) audioCtx = new AC();
    }
    function beep() {
        if(!audioCtx) initAudio();
        if(audioCtx && audioCtx.state==='suspended') audioCtx.resume();
        const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        o.frequency.setValueAtTime(880, audioCtx.currentTime);
        g.gain.setValueAtTime(0.1, audioCtx.currentTime);
        o.start(); o.stop(audioCtx.currentTime+0.1);
    }

    // --- é€šä¿¡å‡¦ç† (ä¿å­˜ä¿®æ­£ç‰ˆ) ---
    async function fetchData(force=false) {
        document.getElementById('status-badge').innerText = "Syncing...";
        try {
            const res = await fetch(GAS_URL);
            localDB = await res.json();
            document.getElementById('status-badge').innerText = "Sync OK";
            if(force) { alert("æ›´æ–°å®Œäº†"); renderList(); }
        } catch(e) { document.getElementById('status-badge').innerText = "Error"; }
    }

    async function pushData(boxId, loc, items, category="æœªåˆ†é¡") {
        document.getElementById('status-badge').innerText = "Saving...";
        try {
            // CORSå¯¾ç­–ã®ãŸã‚ã€JSONã§ã¯ãªãtext/plainã¨ã—ã¦é€ã‚‹
            await fetch(GAS_URL, {
                method: 'POST',
                headers: { "Content-Type": "text/plain" },
                body: JSON.stringify({ boxId, location: loc, items, category, action: 'save' })
            });
            document.getElementById('status-badge').innerText = "Saved";
        } catch(e) {
            console.error(e);
            document.getElementById('status-badge').innerText = "Save Error";
        }
    }

    async function translate(text) {
        try {
            const res = await fetch(`${GAS_URL}?action=translate&text=${encodeURIComponent(text)}`);
            const json = await res.json();
            return json.translated.split(/[,\n]/)[0]; 
        } catch(e) { return text; }
    }

    // --- UIåˆ‡ã‚Šæ›¿ãˆ ---
    function switchTab(tab) {
        document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        document.getElementById('view-'+tab).classList.add('active');
        document.querySelectorAll('.nav-item')[['scan','list','settings'].indexOf(tab)].classList.add('active');
        if(tab==='scan') startQR(); else stopQR();
        if(tab==='list') renderList();
    }

    function startQR() {
        if(currentBoxId) return;
        if(!qrScanner) {
            qrScanner = new Html5Qrcode("reader");
            qrScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
            (decoded) => { beep(); openBox(decoded); }).catch(()=>{});
        }
    }
    function stopQR() {
        if(qrScanner) qrScanner.stop().then(()=>{ qrScanner.clear(); qrScanner=null; }).catch(()=>{});
    }

    function openBox(id) {
        stopQR();
        currentBoxId = id;
        document.getElementById('scan-ui').style.display = 'none';
        document.getElementById('box-ui').style.display = 'block';
        if(!localDB[id]) localDB[id] = { loc: "", items: [], category: "æ–°è¦" };
        renderBoxDetail();
    }

    function renderBoxDetail() {
        const d = localDB[currentBoxId];
        document.getElementById('disp-id').innerText = currentBoxId;
        document.getElementById('disp-cat').innerText = d.category || "æœªåˆ†é¡";
        document.getElementById('inp-loc').value = d.loc;
        const list = document.getElementById('item-list');
        list.innerHTML = "";
        d.items.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = 'item-row';
            div.innerHTML = `<div><span class="num-circle">${getDupCount(item, d.items, idx)}</span> ${item}</div>
                <button class="secondary" style="width:auto;margin:0;padding:5px 10px;" onclick="delItem(${idx})">å‰Šé™¤</button>`;
            list.appendChild(div);
        });
    }

    function getDupCount(item, arr, idx) {
        let c = 0;
        for(let i=0; i<=idx; i++) if(arr[i]===item) c++;
        return c;
    }

    function addBulkItems() {
        const name = document.getElementById('inp-bulk-name').value.trim();
        const count = parseInt(document.getElementById('inp-bulk-count').value);
        if(!name || count < 1) return;
        for(let i=0; i<count; i++) localDB[currentBoxId].items.push(name);
        beep(); saveBox(); renderBoxDetail();
        document.getElementById('inp-bulk-name').value = "";
        document.getElementById('inp-bulk-count').value = 1;
    }

    function delItem(idx) {
        if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            localDB[currentBoxId].items.splice(idx, 1);
            saveBox(); renderBoxDetail();
        }
    }

    function saveBox() {
        const d = localDB[currentBoxId];
        d.loc = document.getElementById('inp-loc').value;
        pushData(currentBoxId, d.loc, d.items, d.category);
    }

    function closeBox() {
        currentBoxId = null;
        document.getElementById('box-ui').style.display = 'none';
        document.getElementById('scan-ui').style.display = 'block';
        startQR();
    }

    // --- ã‚«ãƒ¡ãƒ© / é€šå¸¸è­˜åˆ¥ ---
    let normalStream = null;
    async function startNormalCamera() {
        if(!aiModel) aiModel = await mobilenet.load();
        document.getElementById('normal-camera-area').style.display = 'block';
        const v = document.getElementById('normal-video');
        normalStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        v.srcObject = normalStream;
        detNormal();
    }
    async function detNormal() {
        if(!normalStream) return;
        const v = document.getElementById('normal-video');
        if(v.readyState===4) {
            const p = await aiModel.classify(v);
            if(p.length>0) document.getElementById('ai-hint').innerText = `AIäºˆæ¸¬: ${p[0].className} ?`;
        }
        requestAnimationFrame(detNormal);
    }
    async function snapAndRegister() {
        const h = document.getElementById('ai-hint').innerText;
        if(h.includes("AIäºˆæ¸¬:")) {
            const ja = await translate(h.replace("AIäºˆæ¸¬: ", "").replace(" ?", ""));
            const n = prompt("ç™»éŒ²å:", ja);
            if(n) { localDB[currentBoxId].items.push(n); beep(); saveBox(); renderBoxDetail(); stopNormalCamera(); }
        }
    }
    function stopNormalCamera() {
        if(normalStream) normalStream.getTracks().forEach(t=>t.stop());
        normalStream = null;
        document.getElementById('normal-camera-area').style.display = 'none';
    }

    // --- é«˜é€Ÿãƒ¢ãƒ¼ãƒ‰ (éŸ³å£°å„ªå…ˆãƒ»é€£ç¶šå¯¾å¿œ) ---
    let fastStream = null, recognition = null;
    let lastVoiceTime = 0; // éŸ³å£°å…¥åŠ›ãŒã‚ã£ãŸæ™‚åˆ»
    let lastSpoken = "";
    
    async function startFastMode() {
        if(!aiModel) aiModel = await mobilenet.load();
        document.getElementById('fast-mode-ui').style.display = 'flex';
        
        // ã‚«ãƒ¡ãƒ©èµ·å‹•
        const v = document.getElementById('fast-video');
        try {
            fastStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            v.srcObject = fastStream;
        } catch(e) { console.log(e); }
        
        loopFastAI(); // AIç›£è¦–é–‹å§‹
        
        // éŸ³å£°èªè­˜é–‹å§‹
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(SR) {
            recognition = new SR();
            recognition.lang = 'ja-JP';
            recognition.continuous = true; 
            recognition.interimResults = false;
            
            // é‡è¦: éŸ³å£°èªè­˜ãŒåˆ‡ã‚ŒãŸã‚‰å†èµ·å‹•ã™ã‚‹ (é€£ç¶šå¯¾å¿œ)
            recognition.onend = () => {
                if(document.getElementById('fast-mode-ui').style.display === 'flex') {
                    try { recognition.start(); } catch(e){}
                }
            };

            recognition.onresult = (e) => {
                const results = e.results;
                const transcript = results[results.length-1][0].transcript.trim();
                handleFast(transcript, false); // éŸ³å£°ã¨ã—ã¦å‡¦ç†
            };
            try { recognition.start(); } catch(e){}
        } else {
            document.getElementById('fast-log').innerText = "â€»ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å…¥åŠ›éå¯¾å¿œ";
        }
    }

    async function loopFastAI() {
        if(document.getElementById('fast-mode-ui').style.display==='none') return;
        const v = document.getElementById('fast-video');
        const now = Date.now();

        // ã‚«ãƒ¡ãƒ©ãŒæº–å‚™OKã€ã‹ã¤ éŸ³å£°å…¥åŠ›ã‹ã‚‰1.5ç§’ä»¥ä¸ŠçµŒéã—ã¦ã„ã‚‹å ´åˆã®ã¿AIåˆ¤å®šã‚’è¡Œã†
        // (éŸ³å£°å…¥åŠ›ã‚’å„ªå…ˆã™ã‚‹ãŸã‚)
        if(v.readyState===4 && (now - lastVoiceTime > 1500)) {
            const p = await aiModel.classify(v);
            if(p.length>0 && p[0].probability>0.65) {
                // AIã®ç¢ºä¿¡åº¦ãŒé«˜ã„å ´åˆ
                const eng = p[0].className;
                const ja = await translate(eng);
                
                // å†åº¦ãƒã‚§ãƒƒã‚¯ï¼ˆç¿»è¨³ä¸­ã«éŸ³å£°ãŒå…¥ã£ãŸã‹ã‚‚ã—ã‚Œãªã„ï¼‰
                if(Date.now() - lastVoiceTime > 1500) {
                    handleFast(ja, true); 
                }
            }
        }
        if(fastStream) requestAnimationFrame(loopFastAI); // ãƒ«ãƒ¼ãƒ—ç¶™ç¶š
    }

    function handleFast(text, isAI) {
        if(text==="çµ‚äº†") { stopFastMode(); return; }
        if(text===lastSpoken) return; // ç›´å‰ã¨åŒã˜ãªã‚‰ç„¡è¦–

        // éŸ³å£°å…¥åŠ›ã®å ´åˆã¯ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’æ›´æ–°ã—ã€AIã‚’é»™ã‚‰ã›ã‚‹
        if(!isAI) lastVoiceTime = Date.now();

        lastSpoken = text;
        localDB[currentBoxId].items.push(text);
        
        const type = isAI ? "(AI)" : "ğŸ—£ï¸(éŸ³å£°)";
        document.getElementById('fast-log').innerText = `ç™»éŒ²: ${text} ${type}`;
        beep();
    }

    function stopFastMode() {
        if(fastStream) fastStream.getTracks().forEach(t=>t.stop());
        if(recognition) recognition.stop();
        document.getElementById('fast-mode-ui').style.display = 'none';
        saveBox(); renderBoxDetail();
    }

    // --- ä¸€è¦§æ¤œç´¢ ---
    function renderList() {
        const k = document.getElementById('filter-input').value.toLowerCase();
        const c = document.getElementById('list-container');
        c.innerHTML = "";
        Object.keys(localDB).forEach(id => {
            const d = localDB[id];
            if(`${id} ${d.loc} ${d.items.join(' ')}`.toLowerCase().includes(k)) {
                const div = document.createElement('div');
                div.className = 'box-row';
                div.innerHTML = `<div style="font-weight:bold;color:var(--primary);">${id} <span style="font-size:0.8rem;color:#666;">@${d.loc}</span></div><div style="font-size:0.85rem;">${d.items.slice(0,5).join(', ')}</div>`;
                div.onclick = () => { switchTab('scan'); openBox(id); };
                c.appendChild(div);
            }
        });
    }

    // --- å°åˆ· ---
    function printCurrentBoxQR() {
        if(!currentBoxId) return;
        const area = document.getElementById('print-area');
        area.className = 'mode-single';
        area.innerHTML = `<div class="print-card"><div class="print-id">${currentBoxId}</div><div id="qr-single"></div></div>`;
        new QRCode(document.getElementById("qr-single"), { text: currentBoxId, width: 256, height: 256 });
        setTimeout(() => window.print(), 500);
    }
    function generateBulkPrint() {
        const area = document.getElementById('print-area');
        area.className = 'mode-bulk';
        area.innerHTML = "";
        let count = 0; let generated = [];
        while(count < 8) {
            const rand = 'BOX-' + Math.floor(1000 + Math.random()*9000);
            if(!localDB[rand] && !generated.includes(rand)) { generated.push(rand); count++; }
        }
        generated.forEach(id => {
            const c = document.createElement('div');
            c.className = 'print-card';
            c.innerHTML = `<div class="print-id">${id}</div><div id="qr-${id}"></div>`;
            area.appendChild(c);
            new QRCode(document.getElementById(`qr-${id}`), { text: id, width: 128, height: 128 });
        });
        setTimeout(() => window.print(), 500);
    }
</script>
</body>
</html>
