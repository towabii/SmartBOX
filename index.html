<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Smart Box V19</title>
    
    <!-- PWA Settings Start -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/jpeg" href="smartbox.jpeg">
    <link rel="apple-touch-icon" href="smartbox.jpeg">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="SmartBOX">
    <meta name="theme-color" content="#F2F2F7">
    <!-- PWA Settings End -->

    <!-- Libraries -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@latest"></script>
    <!-- Icon Font: Material Symbols Rounded -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />

    <style>
        :root {
            /* ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ */
            --ios-bg: #F2F2F7;
            --ios-card: #FFFFFF;
            --ios-text: #000000;
            --ios-subtext: #8E8E93;
            --ios-input-bg: #E3E3E8;
            --ios-border: #C6C6C8;
            --ios-blue: #007AFF;
            --ios-red: #FF3B30;
            --ios-orange: #FF9500;
            --ios-green: #34C759;
            
            --btn-primary-bg: #1c1c1e;
            --btn-primary-text: #ffffff;
            --btn-sec-bg: #E5E5EA;
            --btn-sec-text: #1c1c1e;
            
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
        body.dark-mode {
            --ios-bg: #000000;
            --ios-card: #1c1c1e;
            --ios-text: #ffffff;
            --ios-subtext: #98989d;
            --ios-input-bg: #2c2c2e;
            --ios-border: #38383a;
            
            --btn-primary-bg: #ffffff;
            --btn-primary-text: #000000;
            --btn-sec-bg: #2c2c2e;
            --btn-sec-text: #ffffff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--ios-bg);
            color: var(--ios-text);
            margin: 0; padding: 0;
            padding-bottom: calc(80px + var(--safe-area-bottom));
            -webkit-tap-highlight-color: transparent;
            font-size: 16px; line-height: 1.5;
            transition: background-color 0.3s, color 0.3s;
        }

        /* ã‚¢ã‚¤ã‚³ãƒ³ */
        .material-symbols-rounded {
            font-size: 24px; vertical-align: middle; user-select: none;
        }
        .icon-lg { font-size: 48px; }
        /* ã‚«ãƒ†ã‚´ãƒªã‚¢ã‚¤ã‚³ãƒ³ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .cat-icon {
            font-size: 1.2em; vertical-align: -3px; margin-right: 4px;
        }

        /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .container { max-width: 600px; margin: 0 auto; padding: 16px; }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            position: sticky; top: 0; z-index: 90;
            background: var(--ios-bg); padding: 12px 16px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 0.5px solid var(--ios-border);
        }
        .header h1 { margin: 0; font-size: 20px; font-weight: 700; display:flex; align-items:center; gap:8px; }
        .sync-badge {
            font-size: 12px; color: var(--ios-subtext);
            background: var(--btn-sec-bg); padding: 4px 8px; border-radius: 12px; font-weight: 600;
        }

        /* ã‚«ãƒ¼ãƒ‰ */
        .ios-group { margin-bottom: 24px; }
        .ios-group-title {
            text-transform: uppercase; font-size: 13px; color: var(--ios-subtext);
            margin: 0 0 8px 16px; font-weight: normal;
        }
        .ios-card {
            background: var(--ios-card); border-radius: 12px; overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .ios-card-content { padding: 16px; }

        /* ãƒ•ã‚©ãƒ¼ãƒ  */
        input[type="text"], input[type="number"], input[type="password"], select {
            width: 100%; box-sizing: border-box; background: var(--ios-input-bg);
            border: none; padding: 12px 16px; border-radius: 10px;
            font-size: 17px; color: var(--ios-text); margin-bottom: 0; appearance: none;
        }
        input:focus { outline: 2px solid var(--ios-blue); }

        /* ãƒœã‚¿ãƒ³ */
        button {
            border: none; cursor: pointer; font-family: inherit; font-size: 17px; font-weight: 600;
            border-radius: 12px; padding: 14px; width: 100%;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: opacity 0.2s, transform 0.1s;
        }
        button:active { opacity: 0.7; transform: scale(0.98); }

        .btn-primary { background: var(--btn-primary-bg); color: var(--btn-primary-text); }
        .btn-secondary { background: var(--btn-sec-bg); color: var(--btn-sec-text); }
        .btn-danger { background: rgba(255, 59, 48, 0.15); color: var(--ios-red); }
        .btn-success { background: var(--btn-primary-bg); color: var(--btn-primary-text); }
        .btn-warning { background: var(--ios-orange); color: white; }

        /* ãƒªã‚¹ãƒˆ */
        .list-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 16px; background: var(--ios-card); 
            border-bottom: 0.5px solid var(--ios-border);
        }
        .list-row:last-child { border-bottom: none; }
        .list-row-content { flex: 1; min-width: 0; margin-right: 12px; }
        .item-title { font-size: 17px; font-weight: 500; color: var(--ios-text); display:flex; align-items:center; gap:6px; word-break: break-all; }
        .item-subtitle { font-size: 13px; color: var(--ios-subtext); margin-top: 4px; }

        .tag-badge {
            display: inline-block; background: var(--btn-sec-bg); color: var(--ios-text);
            font-size: 11px; padding: 2px 6px; border-radius: 4px; margin-left: 4px;
        }
        .clickable-tag {
            background: var(--ios-blue); color: white; padding: 4px 10px; border-radius: 16px;
            font-size: 12px; margin: 0 4px 4px 0; display: inline-block; cursor: pointer;
        }

        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px; }
        .btn-sm { padding: 8px 12px; font-size: 14px; width: auto; border-radius: 8px; }

        /* ãƒŠãƒ“ãƒãƒ¼ */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--ios-card); border-top: 0.5px solid var(--ios-border);
            display: flex; justify-content: space-around;
            padding-bottom: var(--safe-area-bottom); z-index: 1000;
        }
        .nav-item { 
            flex: 1; padding: 8px 0; text-align: center; font-size: 10px; color: var(--ios-subtext); 
            cursor: pointer; display:flex; flex-direction:column; align-items:center; justify-content:center;
            user-select: none; -webkit-user-select: none;
        }
        .nav-item.active { color: var(--ios-text); font-weight: bold; }
        .nav-item .material-symbols-rounded { font-size: 26px; margin-bottom: 2px; }

        /* PCãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        @media (min-width: 768px) {
            body { padding-bottom: 0; padding-left: 240px; background-color: var(--ios-bg); }
            .container { max-width: 800px; padding: 40px; }
            .nav-bar {
                top: 0; left: 0; width: 240px; height: 100vh;
                flex-direction: column; justify-content: flex-start;
                border-top: none; border-right: 1px solid var(--ios-border);
                padding-top: 40px; padding-bottom: 0; background: var(--ios-card);
            }
            .nav-item {
                flex: 0; flex-direction: row; gap: 16px;
                padding: 16px 32px; text-align: left; font-size: 16px; transition: 0.2s;
                justify-content: flex-start;
            }
            .nav-item:hover { background: var(--btn-sec-bg); }
            .nav-item .material-symbols-rounded { font-size: 24px; margin-bottom:0; }
            .header { position: static; background: transparent; border-bottom: none; padding: 0 0 20px 0; }
            .header h1 { font-size: 28px; }
            #pc-camera-trigger { display: flex !important; }
            #reader { display: none; }
            #reader.active { display: block; }
        }

        /* ãƒ­ã‚°ã‚¤ãƒ³ */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--ios-bg); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        #login-overlay input { text-align: center; letter-spacing: 0.5em; font-size: 24px; max-width: 200px; margin: 24px 0; background: var(--ios-card); }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); z-index: 2000;
            display: none; justify-content: center; align-items: flex-end;
            backdrop-filter: blur(2px);
        }
        .modal-content {
            background: var(--ios-card); width: 100%; max-width: 600px;
            border-radius: 20px 20px 0 0; padding: 24px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.3); animation: slideUp 0.3s;
            max-height: 85vh; overflow-y: auto;
        }
        @media (min-width: 768px) { .modal { align-items: center; } .modal-content { border-radius: 20px; } }
        @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }

        #reader { width: 100%; border-radius: 16px; overflow: hidden; background: #000; min-height: 300px; }
        #reader video { object-fit: cover; }
        
        .alert-box { background: var(--ios-card); border: 1px solid var(--ios-border); color: var(--ios-text); padding: 12px; border-radius: 10px; font-size: 14px; margin-bottom: 12px; display: none; }
        .alert-box.show { display: block; }
        
        .jump-link { font-weight: bold; text-decoration: underline; cursor: pointer; color: var(--ios-blue); }
        .jump-link:active { opacity: 0.6; }

        /* æ¤œç´¢ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
        .hl { background: #FFD60A; color: black; border-radius: 2px; padding: 0 2px; font-weight: bold; }
        .item-match { color: var(--ios-blue); font-weight: bold; }
        .highlight-target { background-color: var(--btn-sec-bg) !important; border-left: 4px solid var(--ios-orange) !important; }
        .highlight-text { color: var(--ios-orange); font-weight: 900; }
        
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(5px);} to{opacity:1; transform:translateY(0);} }

        #pc-camera-trigger {
            display: none; flex-direction: column; align-items: center; justify-content: center;
            height: 300px; background: var(--btn-sec-bg); border-radius: 16px; color: var(--ios-text); cursor: pointer;
        }
        #pc-camera-trigger:hover { opacity: 0.8; }

        /* çµ±è¨ˆãƒãƒ¼ */
        .stat-bar { height: 8px; border-radius: 4px; display: flex; overflow: hidden; margin-top: 10px; }
        .stat-seg { height: 100%; }
        .stat-legend { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; font-size: 12px; color: var(--ios-subtext); }
        .stat-item { display: flex; align-items: center; gap: 4px; }
        .stat-dot { width: 8px; height: 8px; border-radius: 50%; }

        /* å°åˆ·è¨­å®š (å³å¯†ãªã‚µã‚¤ã‚ºæŒ‡å®š) */
        #print-area { display: none; }
        @media print {
            @page { size: A4; margin: 0; }
            html, body { margin: 0; padding: 0; width: 100%; height: 100%; }
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            
            #print-area { 
                position: absolute; top: 0; left: 0; width: 210mm; min-height: 297mm;
                background: white; color: black; font-family: sans-serif;
            }
            
            /* å…±é€šã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
            .print-card {
                border: 2px dashed #333; 
                display: flex; flex-direction: column; align-items: center; justify-content: center;
                border-radius: 8px; box-sizing: border-box; padding: 5px; overflow: hidden;
                width: 92.5mm; height: 65.5mm; /* 8é¢å‰²ä»˜æ™‚ã®1ã‚»ãƒ«è¨ˆç®—å€¤(æ¦‚ç®—) */
            }
            .print-id { font-size: 20pt; font-weight: 900; margin-bottom: 5px; }
            .print-cat { font-size: 12pt; margin-bottom: 5px; font-weight: bold; border: 1px solid #333; padding: 2px 10px; border-radius: 20px; display: flex; align-items: center; gap: 5px; }
            .print-cat .material-symbols-rounded { font-size: 1.2em; }

            /* 8é¢å°åˆ· */
            #print-area.mode-bulk {
                display: grid; 
                grid-template-columns: 1fr 1fr; 
                grid-template-rows: repeat(4, 1fr);
                width: 210mm; height: 297mm; 
                padding: 10mm; box-sizing: border-box; 
                gap: 5mm; page-break-after: always;
            }
            .mode-bulk .print-card { width: 100%; height: 100%; }
            
            /* å˜ä½“å°åˆ· (8é¢ã¨åŒã˜ã‚µã‚¤ã‚ºã§ä¸­å¤®é…ç½®) */
            #print-area.mode-single {
                display: flex; align-items: center; justify-content: center;
                width: 210mm; height: 297mm;
            }
            /* ã‚¯ãƒ©ã‚¹æŒ‡å®šã«ã‚ˆã‚Š .print-card ã®ã‚µã‚¤ã‚º(92.5x65.5)ãŒé©ç”¨ã•ã‚Œã‚‹ */
        }
    </style>
</head>
<body>

<!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
<div id="login-overlay">
    <span class="material-symbols-rounded icon-lg" style="margin-bottom:10px;">inventory_2</span>
    <h2 style="margin: 0; font-weight: 700;">Smart Box</h2>
    <p style="color: var(--ios-subtext); margin-top: 5px;">V19 Ultimate</p>
    <input type="password" id="login-pass" placeholder="â€¢â€¢â€¢â€¢" maxlength="8">
    <button class="btn-primary" onclick="login()" style="max-width: 200px;">
        <span class="material-symbols-rounded">lock_open</span> ãƒ­ãƒƒã‚¯è§£é™¤
    </button>
    <p id="login-msg" style="color: var(--ios-red); margin-top: 20px; font-size: 14px; min-height: 20px;"></p>
</div>

<!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
<div class="header">
    <h1><span class="material-symbols-rounded">inventory_2</span> Smart Box</h1>
    <span id="sync-status" class="sync-badge">Wait</span>
</div>

<div class="container">

    <!-- 1. ç·¨é›† (Scan) -->
    <div id="view-scan" class="view active">
        <div id="scan-ui" class="ios-group">
            <div class="ios-group-title">QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³</div>
            <div class="ios-card">
                <div id="pc-camera-trigger" onclick="forceStartQR()">
                    <span class="material-symbols-rounded icon-lg">photo_camera</span>
                    <span style="font-weight:bold; margin-top:10px;">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•</span>
                </div>
                <div id="reader"></div>
                <div style="padding: 16px; text-align: center; color: var(--ios-subtext); font-size: 13px;">
                    â€»ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„
                </div>
            </div>
        </div>

        <div id="box-ui" style="display:none;">
            <div class="ios-group">
                <div class="ios-group-title">ãƒœãƒƒã‚¯ã‚¹æƒ…å ±</div>
                <div class="ios-card">
                    <div style="padding: 20px; border-bottom: 0.5px solid var(--ios-border); display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div id="disp-id" style="font-size: 24px; font-weight: 800;">BOX-000</div>
                            <div style="display: flex; gap: 8px; margin-top: 4px;">
                                <span id="disp-cat" class="tag-badge">ğŸ“¦ ã‚«ãƒ†ã‚´ãƒª</span>
                                <span id="disp-alert" style="display:none; font-size: 12px; font-weight: 700; color: var(--ios-red); background: rgba(255, 59, 48, 0.1); padding: 4px 8px; border-radius: 6px; align-items:center; gap:4px;">
                                    <span class="material-symbols-rounded" style="font-size:14px;">warning</span>é•·æœŸæ”¾ç½®
                                </span>
                            </div>
                        </div>
                        <button class="btn-secondary" style="width: 50px; height: 50px; border-radius: 25px; padding: 0;" onclick="printQR()">
                            <span class="material-symbols-rounded">print</span>
                        </button>
                    </div>
                    <div style="padding: 16px;">
                        <label style="font-size: 12px; font-weight: 600; color: var(--ios-subtext); display: block; margin-bottom: 8px;">ä¿ç®¡å ´æ‰€</label>
                        <input type="text" id="inp-loc" placeholder="ä¾‹: ã‚¯ãƒ­ãƒ¼ã‚¼ãƒƒãƒˆä¸Šæ®µ" onchange="saveBox()">
                    </div>
                </div>
            </div>

            <div id="existing-dup-alert" class="alert-box"></div>

            <div class="ios-group">
                <div class="ios-group-title" style="display:flex; justify-content:space-between; align-items:center;">
                    <span>ä¸­èº«ãƒªã‚¹ãƒˆ</span>
                    <button class="btn-sm btn-secondary" onclick="openBatchMove()" style="width:auto; padding:4px 10px; font-size:12px;">ä¸€æ‹¬ç§»å‹•</button>
                </div>
                <div class="ios-card" style="min-height: 100px;">
                    <div id="item-list-container"></div>
                </div>
            </div>

            <div class="ios-group">
                <div class="ios-group-title">ã‚¢ã‚¤ãƒ†ãƒ è¿½åŠ </div>
                <div class="ios-card ios-card-content">
                    <div style="display: flex; gap: 10px; margin-bottom: 12px;">
                        <input type="text" id="inp-name" placeholder="å“å (ä¾‹: é›»æ±  #å‚™è“„)" style="flex: 1;">
                        <button class="btn-primary" style="width: auto; padding: 0 20px;" onclick="addItem()">è¿½åŠ </button>
                    </div>
                    <div id="input-dup-alert" class="alert-box"></div>
                    <div style="text-align: center; font-size: 12px; color: var(--ios-subtext); margin: 16px 0 8px;">ã‚¹ãƒãƒ¼ãƒˆå…¥åŠ›</div>
                    <div class="btn-group">
                        <button class="btn-success" onclick="startFastMode(false)">
                            <span class="material-symbols-rounded">rocket_launch</span> ã‚«ãƒ¡ãƒ©+éŸ³å£°
                        </button>
                        <button class="btn-success" onclick="startFastMode(true)">
                            <span class="material-symbols-rounded">mic</span> éŸ³å£°ã®ã¿
                        </button>
                    </div>
                </div>
                
                <div id="cam-ui" class="ios-card" style="display:none; margin-top: 16px; padding: 16px;">
                    <video id="cam-video" autoplay playsinline muted style="width:100%; border-radius: 12px; margin-bottom: 10px;"></video>
                    <div id="ai-hint" style="text-align: center; font-weight: bold; margin-bottom: 12px;">è§£æä¸­...</div>
                    <div class="btn-group">
                        <button class="btn-primary" onclick="snapAI()">æ±ºå®š</button>
                        <button class="btn-secondary" onclick="stopCam()">é–‰ã˜ã‚‹</button>
                    </div>
                </div>
            </div>

            <div style="margin-bottom: 40px;">
                <button class="btn-secondary" onclick="closeBox()" style="margin-bottom: 16px;">
                    <span class="material-symbols-rounded">close</span> é–‰ã˜ã‚‹
                </button>
                <button class="btn-danger" onclick="deleteBox()">
                    <span class="material-symbols-rounded">delete</span> ã“ã®ãƒœãƒƒã‚¯ã‚¹ã‚’å‰Šé™¤
                </button>
            </div>
        </div>
    </div>

    <!-- 2. æ¢ã™ (Find) -->
    <div id="view-find" class="view">
        
        <!-- ã‚ã„ã¾ã„æ¤œç´¢ -->
        <div class="ios-group">
            <div class="ios-group-title">AIææ¡ˆæ¤œç´¢ï¼ˆã‚ã„ã¾ã„ï¼‰</div>
            <div class="ios-card ios-card-content">
                <div style="text-align:center; margin-bottom:20px;">
                    <span class="material-symbols-rounded icon-lg" style="color:var(--ios-blue);">travel_explore</span>
                    <div style="font-weight:bold; margin-top:10px; font-size:18px;">ä½•ã‚’æ¢ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ</div>
                    <div style="font-size:12px; color:var(--ios-subtext);">è¾æ›¸ã‚’ä½¿ã£ã¦é–¢é€£ã‚¢ã‚¤ãƒ†ãƒ ã‚‚æ¤œç´¢ã—ã¾ã™</div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="suggest-input" placeholder="ä¾‹: å……é›»å™¨" style="background: var(--ios-input-bg);">
                    <button class="btn-success" style="width: auto;" onclick="findSuggestion()">
                        <span class="material-symbols-rounded">search</span>
                    </button>
                </div>
                <div id="suggest-res" style="margin-top: 20px; font-size: 15px; line-height: 1.6;"></div>
            </div>
        </div>

        <!-- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ (æ–°è¦è¿½åŠ ) -->
        <div class="ios-group">
            <div class="ios-group-title">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ï¼ˆå®Œå…¨ä¸€è‡´ï¼‰</div>
            <div class="ios-card">
                 <div style="padding: 12px;">
                    <input type="text" id="find-keyword-input" placeholder="åå‰ã€å ´æ‰€ã€ã‚«ãƒ†ã‚´ãƒªã§æ¤œç´¢" onkeyup="renderFindKeyword()" style="padding-left:16px;">
                </div>
                <div id="find-keyword-result"></div>
            </div>
        </div>
    </div>

    <!-- 3. ä¸€è¦§ (List) -->
    <div id="view-list" class="view">
        <div class="ios-group">
            <div class="ios-group-title">åç´ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</div>
            <div class="ios-card ios-card-content" style="border: 2px solid var(--btn-sec-bg);">
                <div style="display:flex; align-items:center; gap:8px; margin-bottom:10px;">
                    <span class="material-symbols-rounded" style="color:var(--ios-orange);">move_to_inbox</span>
                    <span style="font-weight:bold;">ã“ã‚Œã€ã©ã“ã«å…¥ã‚Œã‚‹ï¼Ÿ</span>
                </div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="placement-input" placeholder="æ–°ã—ã„ã‚¢ã‚¤ãƒ†ãƒ å" style="background: var(--ios-input-bg);">
                    <button class="btn-secondary" style="width: auto;" onclick="findPlacement()">ææ¡ˆ</button>
                </div>
                <div id="placement-res" style="margin-top: 12px; font-size: 14px; line-height: 1.6; display:none;"></div>
            </div>
        </div>

        <div class="ios-group">
            <div class="ios-group-title">åç´ãƒ‡ãƒ¼ã‚¿</div>
            <div class="ios-card ios-card-content">
                <div style="display:flex; justify-content:space-between;">
                    <div style="font-weight:bold; font-size:14px;">ã‚«ãƒ†ã‚´ãƒªå‰²åˆ</div>
                    <div style="font-size:12px; color:var(--ios-subtext);" id="total-count"></div>
                </div>
                <div class="stat-bar" id="stat-bar"></div>
                <div class="stat-legend" id="stat-legend"></div>
            </div>
        </div>

        <div class="ios-group">
            <div class="ios-group-title">ãƒœãƒƒã‚¯ã‚¹ä¸€è¦§ (ãƒ•ã‚£ãƒ«ã‚¿)</div>
            <div style="padding: 0 0 12px 0;">
                <input type="text" id="filter-input" placeholder="åå‰ã€å ´æ‰€ã€ã‚«ãƒ†ã‚´ãƒªã§çµã‚Šè¾¼ã¿" onkeyup="renderList()" style="padding-left:16px;">
            </div>
            <div class="ios-card">
                <div id="list-container"></div>
            </div>
        </div>
    </div>

    <!-- 4. è¨­å®š -->
    <div id="view-settings" class="view">
        <div class="ios-group">
            <div class="ios-group-title">å¤–è¦³è¨­å®š</div>
            <div class="ios-card">
                <div class="list-row" onclick="toggleTheme()" style="cursor: pointer;">
                    <div class="list-row-content">
                        <div class="item-title"><span class="material-symbols-rounded">dark_mode</span> ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</div>
                    </div>
                    <div id="theme-label" style="color: var(--ios-subtext); font-size:14px;">ã‚ªãƒ•</div>
                </div>
            </div>
        </div>

        <div class="ios-group">
            <div class="ios-group-title">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</div>
            <div class="ios-card">
                <div class="list-row" onclick="exportCSV()" style="cursor: pointer;">
                    <div class="list-row-content">
                        <div class="item-title"><span class="material-symbols-rounded">download</span> CSVæ›¸ãå‡ºã—</div>
                    </div>
                </div>
                <div class="list-row" onclick="fetchData(true)" style="cursor: pointer;">
                    <div class="list-row-content">
                        <div class="item-title"><span class="material-symbols-rounded">cloud_sync</span> ãƒ‡ãƒ¼ã‚¿å¼·åˆ¶åŒæœŸ</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="ios-group">
            <div class="ios-group-title">ç®¡ç†è€…ãƒ„ãƒ¼ãƒ«</div>
            <div class="ios-card">
                <div class="list-row" onclick="reCategorizeAll()" style="cursor: pointer;">
                    <div class="list-row-content">
                        <div class="item-title"><span class="material-symbols-rounded" style="color:var(--ios-orange);">auto_fix_high</span> AIè‡ªå‹•æ•´ç†</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="ios-group">
            <div class="ios-group-title">å°åˆ·</div>
            <div class="ios-card">
                <div class="list-row" onclick="openPrintConfig()" style="cursor: pointer;">
                    <div class="list-row-content">
                        <div class="item-title"><span class="material-symbols-rounded">print</span> QRã‚³ãƒ¼ãƒ‰ä¸€æ‹¬å°åˆ·</div>
                        <div class="item-subtitle">8å€‹ã®QRã‚’ç”Ÿæˆ (ã‚«ã‚¹ã‚¿ãƒ å¯èƒ½)</div>
                    </div>
                    <div style="color: var(--ios-subtext);">
                        <span class="material-symbols-rounded">chevron_right</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="ios-group">
             <div class="ios-card">
                <div class="list-row" style="cursor: pointer;">
                    <button class="btn-danger" style="background: transparent; justify-content: flex-start; padding: 0;" onclick="logout()">
                        ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                    </button>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
<div class="nav-bar">
    <div class="nav-item active" onclick="tab('scan')"><span class="material-symbols-rounded">photo_camera</span><span>ç·¨é›†</span></div>
    <div class="nav-item" onclick="tab('find')"><span class="material-symbols-rounded">travel_explore</span><span>æ¢ã™</span></div>
    <div class="nav-item" onclick="tab('list')"><span class="material-symbols-rounded">inventory</span><span>ä¸€è¦§</span></div>
    <div class="nav-item" onclick="tab('settings')"><span class="material-symbols-rounded">settings</span><span>è¨­å®š</span></div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«: å˜ä½“ã‚¢ã‚¤ãƒ†ãƒ ç§»å‹• -->
<div id="move-modal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
            <h3 style="margin:0; display:flex; align-items:center; gap:8px;"><span class="material-symbols-rounded">local_shipping</span> ã‚¢ã‚¤ãƒ†ãƒ ç§»å‹•</h3>
            <button class="btn-secondary btn-sm" onclick="document.getElementById('move-modal').style.display='none'">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
        <p id="move-info" style="font-weight:600; margin-bottom:16px;"></p>
        <div class="ios-card" style="border: 1px solid var(--ios-border);">
            <div id="move-list" style="max-height: 40vh; overflow-y: auto;"></div>
        </div>
    </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«: ä¸€æ‹¬ã‚¢ã‚¤ãƒ†ãƒ ç§»å‹• -->
<div id="batch-move-modal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
            <h3 style="margin:0;">ã¾ã¨ã‚ã¦ç§»å‹•</h3>
            <button class="btn-secondary btn-sm" onclick="document.getElementById('batch-move-modal').style.display='none'">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <div style="font-size:14px; color:var(--ios-subtext);">ç§»å‹•ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠ:</div>
            <button class="btn-sm btn-secondary" onclick="toggleAllBatchCheck()">ã™ã¹ã¦é¸æŠ</button>
        </div>
        <div id="batch-item-list" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--ios-border); border-radius:8px; padding:10px; margin-bottom:15px;"></div>
        
        <div style="margin-bottom:10px; font-size:14px; color:var(--ios-subtext);">ç§»å‹•å…ˆã®ãƒœãƒƒã‚¯ã‚¹ã‚’é¸æŠ:</div>
        <div id="batch-box-list" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--ios-border); border-radius:8px;"></div>
        
        <button class="btn-primary" onclick="execBatchMove()" style="margin-top:15px;">ç§»å‹•å®Ÿè¡Œ</button>
    </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«: å°åˆ·è¨­å®š -->
<div id="print-config-modal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
            <h3 style="margin:0;">å°åˆ·è¨­å®š (è¨ˆ8æš)</h3>
            <button class="btn-secondary btn-sm" onclick="document.getElementById('print-config-modal').style.display='none'">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
        <div id="print-config-list" style="max-height: 50vh; overflow-y: auto; margin-bottom:15px;"></div>
        <div style="text-align:right; font-weight:bold; margin-bottom:10px;" id="print-total-count">åˆè¨ˆ: 0æš</div>
        <button class="btn-primary" onclick="execBulkPrint()">å°åˆ·ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä½œæˆ</button>
    </div>
</div>

<div id="fast-mode-ui" style="position: fixed; top:0; left:0; width:100%; height:100%; z-index: 1500; display:none; flex-direction:column; background:black;">
    <div style="flex:1; position:relative; overflow:hidden; display:flex; justify-content:center; align-items:center;">
        <video id="fast-video" autoplay playsinline muted style="width:100%; height:100%; object-fit:cover; opacity:0.7;"></video>
        <div id="voice-icon" style="display:none; color:white;"><span class="material-symbols-rounded icon-lg" style="font-size:64px;">mic</span></div>
    </div>
    <div class="fast-overlay" style="position: absolute; bottom: 0; width: 100%; padding: 20px; box-sizing: border-box; text-align: center; color: white; background: rgba(0,0,0,0.8);">
        <div id="fast-log" style="font-size: 24px; font-weight: bold; margin-bottom: 24px;">å¾…æ©Ÿä¸­...</div>
        <button class="btn-secondary" onclick="stopFastMode()" style="background: white; color: black; max-width: 200px; margin: 0 auto;">çµ‚äº†</button>
    </div>
</div>

<div id="print-area"></div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbydf1nPxbkN6jc82UgwBVF8WSE85ZMnmVUFjpKeE8RpPHpo0nluGnzo3LSLkbime9BDew/exec";

    let localDB = {}; 
    let currentBoxId = null;
    let qrScanner = null;
    let aiModel = null;
    let password = localStorage.getItem('sb_pass') || "";
    let moveTargetIdx = null;
    let targetHighlightItems = []; 
    let audioCtx = null;

    // ã‚«ãƒ†ã‚´ãƒªçµµæ–‡å­— (Material Symbols ã®åå‰)
    const CAT_ICONS = {
        "PCãƒ»ã‚¬ã‚¸ã‚§ãƒƒãƒˆ": "devices", "è¡£é¡ãƒ»ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³": "checkroom", "æ–‡æˆ¿å…·": "edit",
        "æ—¥ç”¨å“": "cleaning_services", "ã‚­ãƒƒãƒãƒ³": "skillet", "å·¥å…·ãƒ»DIY": "construction",
        "è¶£å‘³ãƒ»ãŠã‚‚ã¡ã‚ƒ": "sports_esports", "ã‚¢ã‚¦ãƒˆãƒ‰ã‚¢": "camping", "å­£ç¯€ç”¨å“": "ac_unit",
        "æ›¸é¡": "description", "æœªåˆ†é¡": "inventory_2"
    };
    function getCatIcon(c) {
        const icon = CAT_ICONS[c] || "inventory_2";
        return `<span class="material-symbols-rounded cat-icon">${icon}</span>`;
    }

    function initAudio() { const AC = window.AudioContext || window.webkitAudioContext; if (AC) audioCtx = new AC(); }
    function beep() {
        if(!audioCtx) initAudio();
        if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.type = 'sine'; osc.frequency.setValueAtTime(880, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        osc.start(); osc.stop(audioCtx.currentTime + 0.1);
    }
    document.addEventListener('click', (e) => { if(e.target.tagName === 'BUTTON' || e.target.closest('button')) beep(); });

    const DICT = {
        "PCãƒ»ã‚¬ã‚¸ã‚§ãƒƒãƒˆ": ["PC","ãƒ‘ã‚½ã‚³ãƒ³","ãƒã‚¦ã‚¹","ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰","ãƒ¢ãƒ‹ã‚¿ãƒ¼","ã‚±ãƒ¼ãƒ–ãƒ«","USB","å……é›»å™¨","ã‚¹ãƒãƒ›","é›»æ± ","ã‚¤ãƒ¤ãƒ›ãƒ³","HDD","SSD","SD","ãƒã‚¤ã‚¯","ãƒ«ãƒ¼ã‚¿ãƒ¼","ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ","iPad","Apple"],
        "è¡£é¡ãƒ»ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³": ["æœ","ã‚·ãƒ£ãƒ„","ã‚ºãƒœãƒ³","ãƒ‘ãƒ³ãƒ„","ã‚¹ã‚«ãƒ¼ãƒˆ","ä¸‹ç€","é´ä¸‹","ã‚³ãƒ¼ãƒˆ","ã‚¸ãƒ£ã‚±ãƒƒãƒˆ","å¸½å­","ãƒãƒ•ãƒ©ãƒ¼","ãƒ™ãƒ«ãƒˆ","æ‰‹è¢‹","ã‚¹ãƒ¼ãƒ„","ãƒã‚¯ã‚¿ã‚¤","é„","ãƒãƒƒã‚°","é´","ãƒ–ãƒ¼ãƒ„","ã‚µãƒ³ãƒ€ãƒ«","ãƒ‘ã‚¸ãƒ£ãƒ"],
        "æ–‡æˆ¿å…·": ["ãƒšãƒ³","é‰›ç­†","æ¶ˆã—ã‚´ãƒ ","å®šè¦","ãƒã‚µãƒŸ","ã‚«ãƒƒã‚¿ãƒ¼","ã®ã‚Š","ãƒ†ãƒ¼ãƒ—","ãƒ›ãƒƒãƒã‚­ã‚¹","ä»˜ç®‹","ãƒãƒ¼ãƒˆ","ãƒ¡ãƒ¢","ãƒ•ã‚¡ã‚¤ãƒ«","é›»å“","ç­†ç®±"],
        "æ—¥ç”¨å“": ["ãƒ†ã‚£ãƒƒã‚·ãƒ¥","æ´—å‰¤","ã‚·ãƒ£ãƒ³ãƒ—ãƒ¼","çŸ³é¹¸","æ­¯ãƒ–ãƒ©ã‚·","ãƒã‚¹ã‚¯","è–¬","æƒé™¤","ã‚´ãƒŸè¢‹","ã‚¹ãƒãƒ³ã‚¸","ãƒãƒ³ã‚¬ãƒ¼","ã‚«ã‚¤ãƒ­","æŸ”è»Ÿå‰¤","èŠ³é¦™å‰¤","é›»æ± "],
        "ã‚­ãƒƒãƒãƒ³": ["é‹","ãƒ•ãƒ©ã‚¤ãƒ‘ãƒ³","çš¿","ã‚³ãƒƒãƒ—","ç®¸","ã‚¹ãƒ—ãƒ¼ãƒ³","ãƒ•ã‚©ãƒ¼ã‚¯","ãƒ©ãƒƒãƒ—","ã‚¢ãƒ«ãƒŸãƒ›ã‚¤ãƒ«","é£Ÿå“","èª¿å‘³æ–™","æ°´ç­’","å¼å½“ç®±","ä¿å­˜å®¹å™¨","ãƒœã‚¦ãƒ«"],
        "å·¥å…·ãƒ»DIY": ["ãƒ‰ãƒ©ã‚¤ãƒãƒ¼","ãƒ¬ãƒ³ãƒ","ãƒã‚¸","ã‚¬ãƒ ãƒ†ãƒ¼ãƒ—","è»æ‰‹","ç´","æ¥ç€å‰¤","ãƒ¡ã‚¸ãƒ£ãƒ¼","ãƒ‰ãƒªãƒ«","ãƒšãƒ³ãƒ"],
        "è¶£å‘³ãƒ»ãŠã‚‚ã¡ã‚ƒ": ["ã‚²ãƒ¼ãƒ ","ã‚¹ã‚¤ãƒƒãƒ","PS5","ãƒ•ã‚£ã‚®ãƒ¥ã‚¢","ãƒ—ãƒ©ãƒ¢","ã¬ã„ãã‚‹ã¿","æœ¬","æ¼«ç”»","CD","DVD","ã‚«ãƒ¡ãƒ©","æ¥½å™¨","æ¥½è­œ","ã‚°ãƒƒã‚º"],
        "ã‚¢ã‚¦ãƒˆãƒ‰ã‚¢": ["ãƒ†ãƒ³ãƒˆ","å¯è¢‹","ãƒ©ãƒ³ã‚¿ãƒ³","æ¤…å­","ãƒªãƒ¥ãƒƒã‚¯","é›¨å…·","è‡ªè»¢è»Š","é‡£ã‚Š","ã‚¯ãƒ¼ãƒ©ãƒ¼ãƒœãƒƒã‚¯ã‚¹","å¯è¢‹"],
        "å­£ç¯€ç”¨å“": ["æ‰‡é¢¨æ©Ÿ","ãƒ’ãƒ¼ã‚¿ãƒ¼","ã‚¹ãƒˆãƒ¼ãƒ–","ã“ãŸã¤","åŠ æ¹¿å™¨","ã‚¯ãƒªã‚¹ãƒã‚¹","æ­£æœˆ","ãƒ—ãƒ¼ãƒ«","æµ®ãè¼ª"],
        "æ›¸é¡": ["å¥‘ç´„æ›¸","é€šå¸³","å°é‘‘","ãƒ‘ã‚¹ãƒãƒ¼ãƒˆ","å¹´é‡‘","ä¿é™º","è¨¼æ›¸","èª¬æ˜æ›¸"]
    };

    window.onload = () => {
        initAudio();
        if(localStorage.getItem('sb_dark')==='1') document.body.classList.add('dark-mode');
        updateThemeLabel();
        if(password) { document.getElementById('login-overlay').style.display='none'; fetchData(); }
        renderList(); 
        document.getElementById('inp-name').addEventListener('input', checkInputDuplicate);
    };

    function toggleTheme() { document.body.classList.toggle('dark-mode'); localStorage.setItem('sb_dark', document.body.classList.contains('dark-mode')?'1':'0'); updateThemeLabel(); }
    function updateThemeLabel() { document.getElementById('theme-label').innerText = document.body.classList.contains('dark-mode') ? 'ã‚ªãƒ³' : 'ã‚ªãƒ•'; }

    function exportCSV() {
        if(Object.keys(localDB).length === 0) { alert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
        let csv = "\uFEFFBOX_ID,ä¿ç®¡å ´æ‰€,ã‚«ãƒ†ã‚´ãƒª,ã‚¢ã‚¤ãƒ†ãƒ å,ã‚¿ã‚°,æ›´æ–°æ—¥\n";
        Object.keys(localDB).forEach(id => {
            const b = localDB[id];
            if(b.items.length === 0) { csv += `"${id}","${b.loc}","${b.category}","(ãªã—)","","${b.updated}"\n`; } 
            else { b.items.forEach(i => { const tags = (i.t||[]).join(" "); csv += `"${id}","${b.loc}","${b.category}","${i.n}","${tags}","${b.updated}"\n`; }); }
        });
        const blob = new Blob([csv], { type: 'text/csv' }); const a = document.createElement('a');
        a.href = URL.createObjectURL(blob); a.download = `smartbox_backup_${new Date().toISOString().slice(0,10)}.csv`; a.click();
    }

    function login() {
        const p = document.getElementById('login-pass').value; document.getElementById('login-msg').innerText = "èªè¨¼ä¸­...";
        fetch(`${GAS_URL}?password=${p}`).then(r => r.json()).then(d => {
            if(d.error) { document.getElementById('login-msg').innerText = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™"; } else {
                password = p; localStorage.setItem('sb_pass', p);
                document.getElementById('login-overlay').style.opacity = 0;
                setTimeout(()=>document.getElementById('login-overlay').style.display='none', 300);
                localDB = d; renderList();
            }
        }).catch(e => document.getElementById('login-msg').innerText = "é€šä¿¡ã‚¨ãƒ©ãƒ¼");
    }
    function logout() { localStorage.removeItem('sb_pass'); location.reload(); }

    async function fetchData(force=false) {
        document.getElementById('sync-status').innerText = "Syncing...";
        try {
            const res = await fetch(`${GAS_URL}?password=${password}`); const json = await res.json();
            if(json.error) { alert("èªè¨¼ã‚¨ãƒ©ãƒ¼"); logout(); return; }
            localDB = json; document.getElementById('sync-status').innerText = "Ready";
            if(force) { alert("åŒæœŸå®Œäº†"); renderList(); }
        } catch(e){ document.getElementById('sync-status').innerText = "Error"; }
    }
    async function pushData(payload) {
        document.getElementById('sync-status').innerText = "Saving..."; payload.password = password;
        try { await fetch(GAS_URL, { method:'POST', headers:{ "Content-Type":"text/plain" }, body:JSON.stringify(payload) }); document.getElementById('sync-status').innerText = "Saved"; } catch(e){ document.getElementById('sync-status').innerText = "Save Error"; }
    }

    function tab(t) {
        document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        document.getElementById('view-'+t).classList.add('active');
        const idx = t === 'scan' ? 0 : t === 'find' ? 1 : t === 'list' ? 2 : 3;
        document.querySelectorAll('.nav-item')[idx].classList.add('active');
        const isDesktop = window.innerWidth >= 768;
        if(t==='scan') {
            if(isDesktop) { stopQR(); document.getElementById('pc-camera-trigger').style.display = 'flex'; document.getElementById('reader').classList.remove('active'); } 
            else { setTimeout(startQR,300); }
        } else { stopQR(); }
        if(t==='list') setTimeout(renderList, 10);
        if(t==='find') setTimeout(renderFindKeyword, 10);
    }

    function forceStartQR() { document.getElementById('pc-camera-trigger').style.display = 'none'; document.getElementById('reader').classList.add('active'); startQR(); }
    function startQR() {
        if(currentBoxId || qrScanner) return;
        const r = document.getElementById("reader");
        if(r && r.offsetParent!==null) {
            const sc = new Html5Qrcode("reader");
            sc.start({facingMode:"environment"},{fps:10,qrbox:250},(t)=>{ beep(); openBox(t); })
            .then(()=>{qrScanner=sc}).catch(()=>{ if(window.innerWidth<768) setTimeout(startQR,500); });
        }
    }
    function stopQR() { if(qrScanner) qrScanner.stop().then(()=>{qrScanner.clear();qrScanner=null}).catch(()=>{qrScanner=null}); }

    function openBox(id) {
        stopQR(); currentBoxId = id;
        document.getElementById('scan-ui').style.display='none'; document.getElementById('box-ui').style.display='block';
        if(!localDB[id]) localDB[id] = { loc:"", items:[], category:"æœªåˆ†é¡", updated: new Date() };
        renderBoxUI();
    }
    function closeBox() { 
        currentBoxId=null; targetHighlightItems=[];
        document.getElementById('box-ui').style.display='none'; document.getElementById('scan-ui').style.display='block'; 
        if(window.innerWidth >= 768) { document.getElementById('pc-camera-trigger').style.display = 'flex'; document.getElementById('reader').classList.remove('active'); } else { setTimeout(startQR,300); }
    }
    function jumpToBox(boxId, itemName) {
        document.getElementById('box-ui').style.display='none';
        targetHighlightItems = [itemName]; 
        openBox(boxId);
        tab('scan');
    }

    function renderBoxUI() {
        const d = localDB[currentBoxId];
        document.getElementById('disp-id').innerText = currentBoxId;
        document.getElementById('disp-cat').innerHTML = `${getCatIcon(d.category)} ${d.category || "æœªåˆ†é¡"}`;
        document.getElementById('inp-loc').value = d.loc;
        const diff = (new Date() - new Date(d.updated)) / (1000*60*60*24);
        document.getElementById('disp-alert').style.display = (diff > 365) ? 'flex' : 'none';
        checkExistingDuplicates(d.items);
        
        const list = document.getElementById('item-list-container'); list.innerHTML = "";
        if(d.items.length === 0) list.innerHTML = `<div style="text-align:center; padding:20px; color:var(--ios-subtext);">ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
        
        d.items.forEach((item, i) => {
            const row = document.createElement('div'); row.className = "list-row";
            const tags = (item.t||[]).map(t=>`<span class="tag-badge">${t}</span>`).join("");
            
            if(targetHighlightItems.includes(item.n)) {
                row.classList.add('highlight-target');
                row.innerHTML = `
                    <div class="list-row-content">
                        <div class="item-title highlight-text">${item.n} ${tags}</div>
                    </div>
                    <div style="display: flex; gap: 6px;">
                        <button class="btn-secondary btn-sm" onclick="openMoveModal(${i})"><span class="material-symbols-rounded">local_shipping</span></button>
                        <button class="btn-danger btn-sm" onclick="delItem(${i})"><span class="material-symbols-rounded">delete</span></button>
                    </div>`;
                setTimeout(() => row.scrollIntoView({behavior: "smooth", block: "center"}), 300);
            } else {
                row.innerHTML = `
                    <div class="list-row-content">
                        <div class="item-title">${item.n} ${tags}</div>
                    </div>
                    <div style="display: flex; gap: 6px;">
                        <button class="btn-secondary btn-sm" onclick="openMoveModal(${i})"><span class="material-symbols-rounded">local_shipping</span></button>
                        <button class="btn-danger btn-sm" onclick="delItem(${i})"><span class="material-symbols-rounded">delete</span></button>
                    </div>`;
            }
            list.appendChild(row);
        });
    }

    function checkExistingDuplicates(items) {
        const alertBox = document.getElementById('existing-dup-alert'); alertBox.classList.remove('show'); alertBox.innerHTML = "";
        if(!items || items.length === 0) return;
        let foundDupes = [];
        for(let item of items) {
            for(let bid of Object.keys(localDB)) {
                if(bid === currentBoxId) continue;
                if(localDB[bid].items.some(i => i.n.includes(item.n) || item.n.includes(i.n))) {
                    foundDupes.push(`<div><span class="material-symbols-rounded" style="color:var(--ios-orange);font-size:16px;">lightbulb</span> <span class="jump-link" onclick="jumpToBox('${bid}', '${item.n}')">${bid}</span> ã«ã‚‚ã€${item.n}ã€ãŒã‚ã‚Šã¾ã™</div>`);
                    if(foundDupes.length >= 3) break;
                }
            }
            if(foundDupes.length >= 3) break;
        }
        if(foundDupes.length > 0) { alertBox.innerHTML = foundDupes.join(""); alertBox.classList.add('show'); }
    }

    function checkInputDuplicate() {
        const val = document.getElementById('inp-name').value.trim();
        const alertDiv = document.getElementById('input-dup-alert');
        if(val.length < 2) { alertDiv.classList.remove('show'); return; }
        let suggestedBoxId = null; let foundName = "";
        Object.keys(localDB).forEach(bid => {
            if(bid === currentBoxId) return;
            const match = localDB[bid].items.find(i => i.n.includes(val) || val.includes(i.n));
            if(match) { suggestedBoxId = bid; foundName = match.n; }
        });
        if(suggestedBoxId) {
            const cat = localDB[suggestedBoxId].category;
            alertDiv.innerHTML = `<div><span class="material-symbols-rounded" style="color:var(--ios-orange);font-size:16px;">lightbulb</span> <b>${suggestedBoxId}</b> (${cat}) ã«ä¼¼ãŸç‰©ã€Œ${foundName}ã€ãŒã‚ã‚Šã¾ã™ã€‚<br><span class="jump-link" onclick="jumpToBox('${suggestedBoxId}', '${foundName}')">ãã“ã¸ç§»å‹•ã—ã¦ç¢ºèª</span></div>`;
            alertDiv.classList.add('show');
        } else { alertDiv.classList.remove('show'); }
    }

    function autoCategorize(items) {
        let scores = {};
        items.forEach(itm => { const txt = itm.n + (itm.t||[]).join(""); Object.keys(DICT).forEach(cat => { if(DICT[cat].some(w => txt.includes(w))) scores[cat] = (scores[cat]||0)+1; }); });
        let max = 0, best = "æœªåˆ†é¡"; Object.keys(scores).forEach(c => { if(scores[c]>max){max=scores[c]; best=c;} });
        if(best === "æœªåˆ†é¡" && localDB[currentBoxId].category !== "æœªåˆ†é¡") return localDB[currentBoxId].category;
        return best;
    }
    function reCategorizeAll() {
        if(!confirm("âš ï¸ ã€è­¦å‘Šã€‘\nå…¨ãƒœãƒƒã‚¯ã‚¹ã®ã‚«ãƒ†ã‚´ãƒªã‚’è‡ªå‹•å†è¨­å®šã—ã¾ã™ã€‚\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
        const u = prompt("å®Ÿè¡Œã™ã‚‹ã«ã¯ã€Œæ•´ç†ã€ã¨å…¥åŠ›"); if(u !== "æ•´ç†") { alert("ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ"); return; }
        let count = 0;
        Object.keys(localDB).forEach(bid => {
            const box = localDB[bid]; const newCat = autoCategorize(box.items);
            if(newCat !== "æœªåˆ†é¡" && newCat !== box.category) { box.category = newCat; pushData({ action:'save', boxId:bid, location:box.loc, items:box.items, category:box.category }); count++; }
        });
        alert(`${count}å€‹ã®ãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°ã—ã¾ã—ãŸ`);
    }

    function addItem() {
        const val = document.getElementById('inp-name').value.trim(); if(!val) return;
        const tags = val.match(/#[^\s]+/g) || []; const name = val.replace(/#[^\s]+/g, "").trim();
        localDB[currentBoxId].items.push({ n:name, c:1, t:tags });
        document.getElementById('inp-name').value = ""; document.getElementById('input-dup-alert').classList.remove('show');
        localDB[currentBoxId].category = autoCategorize(localDB[currentBoxId].items); saveBox(); renderBoxUI();
    }
    function delItem(i) { if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { localDB[currentBoxId].items.splice(i, 1); saveBox(); renderBoxUI(); } }
    async function deleteBox() { if(!confirm("ç®±ã”ã¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return; delete localDB[currentBoxId]; await pushData({ action:'delete', boxId:currentBoxId }); alert("å‰Šé™¤ã—ã¾ã—ãŸ"); closeBox(); }
    function saveBox() {
        const d = localDB[currentBoxId]; d.loc = document.getElementById('inp-loc').value; d.updated = new Date();
        pushData({ action:'save', boxId:currentBoxId, location:d.loc, items:d.items, category:d.category });
    }

    function openMoveModal(i) {
        moveTargetIdx = i; const itm = localDB[currentBoxId].items[i];
        document.getElementById('move-info').innerHTML = `ã€Œ${itm.n}ã€ã‚’ç§»å‹•`;
        const list = document.getElementById('move-list'); list.innerHTML="";
        Object.keys(localDB).forEach(bid => {
            if(bid === currentBoxId) return; const b = localDB[bid];
            const div = document.createElement('div'); div.className = "list-row"; div.style.cursor="pointer";
            div.innerHTML = `<div class="list-row-content"><div class="item-title">${bid}</div><div class="item-subtitle">${b.category} @${b.loc}</div></div>`;
            div.onclick = () => {
                localDB[bid].items.push(itm); localDB[currentBoxId].items.splice(moveTargetIdx,1);
                pushData({ action:'save', boxId:currentBoxId, location:localDB[currentBoxId].loc, items:localDB[currentBoxId].items, category:localDB[currentBoxId].category });
                pushData({ action:'save', boxId:bid, location:localDB[bid].loc, items:localDB[bid].items, category:localDB[bid].category });
                alert(`ç§»å‹•ã—ã¾ã—ãŸ`); document.getElementById('move-modal').style.display='none'; renderBoxUI();
            };
            list.appendChild(div);
        });
        document.getElementById('move-modal').style.display='flex';
    }

    // --- ã¾ã¨ã‚ã¦ç§»å‹• ---
    function openBatchMove() {
        const d = localDB[currentBoxId];
        if(!d.items.length) { alert("ç§»å‹•ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
        
        const iList = document.getElementById('batch-item-list'); iList.innerHTML = "";
        d.items.forEach((item, i) => {
            const div = document.createElement('div');
            div.style.padding="8px"; div.style.borderBottom="1px solid var(--ios-border)";
            div.innerHTML = `<label style="display:flex;align-items:center;gap:10px;"><input type="checkbox" value="${i}" class="batch-check" style="width:20px;height:20px;margin:0;"> ${item.n}</label>`;
            iList.appendChild(div);
        });

        const bList = document.getElementById('batch-box-list'); bList.innerHTML = "";
        Object.keys(localDB).forEach(bid => {
            if(bid === currentBoxId) return;
            const b = localDB[bid];
            const div = document.createElement('div');
            div.className = "list-row"; div.style.cursor="pointer";
            div.innerHTML = `<label style="display:flex;align-items:center;gap:10px;width:100%;cursor:pointer;"><input type="radio" name="batch-target-box" value="${bid}" style="width:20px;height:20px;margin:0;"> <div><div style="font-weight:bold;">${bid}</div><div style="font-size:12px;color:#888;">${b.category} @${b.loc}</div></div></label>`;
            bList.appendChild(div);
        });
        document.getElementById('batch-move-modal').style.display='flex';
    }

    function toggleAllBatchCheck() {
        const checks = document.querySelectorAll('.batch-check');
        const allChecked = Array.from(checks).every(c => c.checked);
        checks.forEach(c => c.checked = !allChecked);
    }

    function execBatchMove() {
        const checks = document.querySelectorAll('.batch-check:checked');
        if(checks.length===0) { alert("ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
        const indices = Array.from(checks).map(c=>parseInt(c.value)).sort((a,b)=>b-a);
        
        const radio = document.querySelector('input[name="batch-target-box"]:checked');
        if(!radio) { alert("ç§»å‹•å…ˆã®ãƒœãƒƒã‚¯ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
        const targetBid = radio.value;

        indices.forEach(idx => {
            localDB[targetBid].items.push(localDB[currentBoxId].items[idx]);
            localDB[currentBoxId].items.splice(idx, 1);
        });

        const d1 = localDB[currentBoxId];
        pushData({ action:'save', boxId:currentBoxId, location:d1.loc, items:d1.items, category:d1.category });
        const d2 = localDB[targetBid];
        pushData({ action:'save', boxId:targetBid, location:d2.loc, items:d2.items, category:d2.category });

        alert(`${indices.length}å€‹ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ç§»å‹•ã—ã¾ã—ãŸ`);
        document.getElementById('batch-move-modal').style.display='none';
        renderBoxUI();
    }

    // --- ã‚ã„ã¾ã„æ¤œç´¢ (è¡¨ç¤ºå¼·åŒ–) ---
    function findSuggestion() {
        const key = document.getElementById('suggest-input').value.trim().toLowerCase();
        const res = document.getElementById('suggest-res');
        if(!key) { res.innerHTML = ""; return; }
        
        let hits = []; let words = [key];
        Object.keys(DICT).forEach(c => { if(DICT[c].some(w=>w.includes(key))) words=words.concat(DICT[c]); });
        
        Object.keys(localDB).forEach(id => {
            const b = localDB[id]; let score = 0; let reason = [];
            const content = b.items.map(i=>i.n.toLowerCase()).join(" ");
            
            // ã‚¢ã‚¤ãƒ†ãƒ åãƒãƒƒãƒãƒ³ã‚°
            let hitItems = [];
            b.items.forEach(item => {
                if(words.some(w => item.n.toLowerCase().includes(w))) {
                    hitItems.push(item.n);
                }
            });

            words.forEach(w => { 
                if(content.includes(w)) { score += 10; if(!reason.includes("é–¢é€£ã‚¢ã‚¤ãƒ†ãƒ ")) reason.push("é–¢é€£ã‚¢ã‚¤ãƒ†ãƒ "); }
                if(b.category.includes(w)) { score += 5; if(!reason.includes("ã‚«ãƒ†ã‚´ãƒªä¸€è‡´")) reason.push("ã‚«ãƒ†ã‚´ãƒªä¸€è‡´"); }
            });
            
            if(score > 0) {
                hits.push({id, loc:b.loc, cat:b.category, score, reason:reason.join(", "), hitItems});
            }
        });
        hits.sort((a,b)=>b.score-a.score);
        if(hits.length>0) {
            res.innerHTML = "<b><span class='material-symbols-rounded' style='font-size:14px;vertical-align:middle;'>check_circle</span> æ¤œç´¢çµæœ:</b><br>" + hits.slice(0,5).map(h => {
                // ã‚¢ã‚¤ãƒ†ãƒ è¡¨ç¤º (ãƒ’ãƒƒãƒˆã—ãŸã‚‚ã®ã‚’é’å­—)
                let displayItems = h.hitItems.length > 0 
                    ? `<br><span style="font-size:0.85em; color:#007AFF;">ğŸ’¡ ${h.hitItems.join(", ")}</span>` 
                    : "";
                return `ãƒ»<span class="jump-link" onclick="jumpToBox('${h.id}', '${key}')">${h.id}</span> <span style="font-size:0.85em;color:var(--ios-subtext);">(${h.reason})</span><br>ã€€${getCatIcon(h.cat)} ${h.cat} @${h.loc} ${displayItems}`;
            }).join("<br><hr style='border:0;border-top:1px dashed #ccc;margin:8px 0;'>");
        } else {
            res.innerHTML = "è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
        }
    }

    // --- åç´ææ¡ˆ ---
    function findPlacement() {
        const key = document.getElementById('placement-input').value.trim().toLowerCase();
        const res = document.getElementById('placement-res');
        if(!key) { res.style.display='none'; return; }
        res.style.display='block';
        let words = [key]; let targetCat = "æœªåˆ†é¡";
        Object.keys(DICT).forEach(c => { if(DICT[c].some(w=>w.includes(key))) { words=words.concat(DICT[c]); targetCat = c; }});
        let hits = [];
        Object.keys(localDB).forEach(id => {
            const b = localDB[id]; let score = 0;
            if(b.category === targetCat && targetCat !== "æœªåˆ†é¡") score += 20;
            const content = b.items.map(i=>i.n.toLowerCase()).join(" ");
            words.forEach(w => { if(content.includes(w)) score += 5; });
            if(score > 0) hits.push({id, loc:b.loc, cat:b.category, score});
        });
        hits.sort((a,b)=>b.score-a.score);
        let msg = targetCat !== "æœªåˆ†é¡" ? `æ¨æ¸¬ã‚«ãƒ†ã‚´ãƒª: <b>${targetCat}</b><br>` : "";
        if(hits.length > 0) msg += "<b>ãŠã™ã™ã‚ã®åç´å…ˆ:</b><br>" + hits.slice(0,3).map(h=>`ãƒ»<span class="jump-link" onclick="tab('scan');openBox('${h.id}')">${h.id}</span> (${h.cat}) @${h.loc}`).join("<br>");
        else msg += "æ–°ã—ã„ç®±ã‹ã€ç©ºã„ã¦ã„ã‚‹ç®±ã‚’ä½¿ã„ã¾ã—ã‚‡ã†ã€‚";
        res.innerHTML = msg;
    }

    // --- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ (ãƒã‚¤ãƒ©ã‚¤ãƒˆ) ---
    function highlightText(text, keyword) {
        if(!keyword) return text;
        const parts = text.split(new RegExp(`(${keyword})`, 'gi'));
        return parts.map(part => part.toLowerCase() === keyword.toLowerCase() ? `<span class="hl">${part}</span>` : part).join('');
    }
    function renderFindKeyword() {
        const key = document.getElementById('find-keyword-input').value.trim().toLowerCase();
        const res = document.getElementById('find-keyword-result');
        res.innerHTML = ""; if(!key) return;
        let found = false;
        Object.keys(localDB).forEach(id => {
            const d = localDB[id]; const rawTxt = `${id} ${d.loc} ${d.category} ${d.items.map(i=>i.n).join(" ")}`.toLowerCase();
            const terms = key.split(/\s+/);
            if(terms.every(t => rawTxt.includes(t))) {
                found = true; const div = document.createElement('div'); div.className = "list-row";
                let itemsHtml = d.items.map(i => {
                     let name = i.n; let isMatch = false;
                     terms.forEach(t => { if(t && name.toLowerCase().includes(t)) { name = highlightText(name, t); isMatch = true; } });
                     return isMatch ? `<span class="item-match">${name}</span>` : name;
                }).join(", ");
                div.innerHTML = `
                    <div class="list-row-content" onclick="jumpToBox('${id}', '${key}')">
                        <div class="item-title"><span class="jump-link">${highlightText(id, terms[0])}</span> <span class="tag-badge">${getCatIcon(d.category)} ${highlightText(d.category, terms[0])}</span></div>
                        <div class="item-subtitle">@${highlightText(d.loc, terms[0])}</div>
                        <div style="font-size:12px; color:var(--ios-text); margin-top:4px;">${itemsHtml}</div>
                    </div>`;
                res.appendChild(div);
            }
        });
        if(!found) res.innerHTML = "<div style='padding:10px;text-align:center;color:var(--ios-subtext)'>è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>";
    }

    function renderList() {
        const cats = {}; let boxCount = 0; let itemCount = 0;
        Object.keys(localDB).forEach(id => { boxCount++; const c = localDB[id].category || "æœªåˆ†é¡"; cats[c] = (cats[c]||0)+1; itemCount += localDB[id].items.length; });
        document.getElementById('total-count').innerText = `${boxCount}ç®± / ${itemCount}ç‚¹`;
        const bar = document.getElementById('stat-bar'); bar.innerHTML=""; const leg = document.getElementById('stat-legend'); leg.innerHTML="";
        const colors = ["#007AFF","#34C759","#FF9500","#FF3B30","#AF52DE","#5856D6","#FF2D55","#A2845E"]; let ci = 0;
        Object.keys(cats).sort((a,b)=>cats[b]-cats[a]).forEach(c => {
            const pct = (cats[c]/boxCount)*100; const col = colors[ci % colors.length];
            const seg = document.createElement('div'); seg.className='stat-seg'; seg.style.width=pct+"%"; seg.style.background=col; bar.appendChild(seg);
            const li = document.createElement('div'); li.className='stat-item'; li.innerHTML = `<div class="stat-dot" style="background:${col}"></div> ${c}`; leg.appendChild(li); ci++;
        });
        const key = document.getElementById('filter-input').value.trim().toLowerCase(); const c = document.getElementById('list-container'); c.innerHTML="";
        Object.keys(localDB).forEach(id => {
            const d = localDB[id]; const txt = `${id} ${d.loc} ${d.category} ${d.items.map(i=>i.n).join(" ")}`.toLowerCase(); const terms = key.split(/\s+/);
            if(!key || terms.every(t => txt.includes(t))) {
                const div = document.createElement('div'); div.className = "list-row"; div.style.cursor="pointer";
                const prev = d.items.slice(0,3).map(i=>i.n).join(", ") + (d.items.length>3?"...":"");
                div.innerHTML = `
                    <div class="list-row-content">
                        <div class="item-title">${id} <span class="tag-badge">${getCatIcon(d.category)} ${d.category}</span></div>
                        <div class="item-subtitle">@${d.loc}</div>
                        <div style="font-size:12px; color:var(--ios-text); margin-top:4px;">${prev}</div>
                    </div>
                    <div style="color:var(--ios-subtext);"><span class="material-symbols-rounded">chevron_right</span></div>`;
                div.onclick=()=>{ tab('scan'); openBox(id); }; c.appendChild(div);
            }
        });
    }

    let aiStream=null, recognition=null, isVoiceOnly=false, lastSpoken="";
    async function startFastMode(voiceOnly) {
        isVoiceOnly = voiceOnly; if(!voiceOnly && !aiModel) aiModel = await mobilenet.load();
        document.getElementById('fast-mode-ui').style.display='flex';
        const v = document.getElementById('fast-video'); const ico = document.getElementById('voice-icon');
        if(voiceOnly) { v.style.display='none'; ico.style.display='block'; document.getElementById('fast-log').innerText = "éŸ³å£°å…¥åŠ›ä¸­..."; } 
        else { v.style.display='block'; ico.style.display='none'; try { aiStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}); v.srcObject = aiStream; loopAI(); } catch(e){} }
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(SR) {
            recognition = new SR(); recognition.lang = 'ja-JP'; recognition.continuous = true; recognition.interimResults = false;
            recognition.onend = () => { if(document.getElementById('fast-mode-ui').style.display==='flex') try{recognition.start()}catch(e){} };
            recognition.onresult = (e) => { handleFastInput(e.results[e.results.length-1][0].transcript.trim(), false); };
            try{recognition.start()}catch(e){}
        }
    }
    async function loopAI() {
        if(document.getElementById('fast-mode-ui').style.display==='none' || isVoiceOnly) return;
        const v = document.getElementById('fast-video');
        if(v.readyState===4 && Math.random()<0.05) {
            const p = await aiModel.classify(v); if(p.length>0 && p[0].probability>0.65) { const ja = await translate(p[0].className); handleFastInput(ja, true); }
        }
        if(aiStream) requestAnimationFrame(loopAI);
    }
    async function translate(t) { try { const r = await fetch(`${GAS_URL}?action=translate&text=${t}&password=${password}`); const j=await r.json(); return j.translated; } catch(e){return t;} }
    function handleFastInput(t, isAI) {
        if(t==="çµ‚äº†") { stopFastMode(); return; } if(t===lastSpoken) return; lastSpoken = t;
        localDB[currentBoxId].items.push({n:t, c:1, t:[]}); document.getElementById('fast-log').innerText = `ç™»éŒ²: ${t}`;
        localDB[currentBoxId].category = autoCategorize(localDB[currentBoxId].items); beep();
    }
    function stopFastMode() { if(aiStream) aiStream.getTracks().forEach(t=>t.stop()); if(recognition) recognition.stop(); aiStream=null; recognition=null; document.getElementById('fast-mode-ui').style.display='none'; saveBox(); renderBoxUI(); }

    // --- å°åˆ·æ©Ÿèƒ½ ---
    function printQR() {
        const a=document.getElementById('print-area'); a.style.display='flex'; a.className='mode-single';
        a.innerHTML=`<div class="print-card"><div class="print-id">${currentBoxId}</div><div class="print-cat">${getCatIcon(localDB[currentBoxId].category)} ${localDB[currentBoxId].category}</div><div id="pq"></div></div>`;
        new QRCode(document.getElementById("pq"),{text:currentBoxId,width:200,height:200});
        setTimeout(()=>{window.print();a.style.display='none'},500);
    }

    function openPrintConfig() {
        const list = document.getElementById('print-config-list'); list.innerHTML = "";
        Object.keys(CAT_ICONS).forEach(cat => {
            const div = document.createElement('div');
            div.style.display = "flex"; div.style.justifyContent = "space-between"; div.style.alignItems = "center"; div.style.padding = "8px"; div.style.borderBottom = "1px solid var(--ios-border)";
            div.innerHTML = `<span>${getCatIcon(cat)} ${cat}</span><input type="number" min="0" max="8" value="0" class="print-count-input" data-cat="${cat}" style="width:60px; text-align:center;" onchange="updatePrintTotal()">`;
            list.appendChild(div);
        });
        updatePrintTotal(); document.getElementById('print-config-modal').style.display='flex';
    }

    function updatePrintTotal() {
        let total = 0; document.querySelectorAll('.print-count-input').forEach(inp => total += parseInt(inp.value||0));
        const el = document.getElementById('print-total-count'); el.innerText = `åˆè¨ˆ: ${total}æš (æ®‹ã‚Š${8-total}æš)`;
        el.style.color = total > 8 ? "red" : "black";
    }

    function execBulkPrint() {
        let total = 0; const requests = [];
        document.querySelectorAll('.print-count-input').forEach(inp => {
            const count = parseInt(inp.value||0);
            const cat = inp.dataset.cat;
            for(let i=0; i<count; i++) requests.push(cat);
            total += count;
        });
        if(total > 8) { alert("åˆè¨ˆ8æšä»¥å†…ã«ã—ã¦ãã ã•ã„"); return; }
        if(total === 0) { for(let i=0; i<8; i++) requests.push("æœªåˆ†é¡"); }
        while(requests.length < 8) requests.push("æœªåˆ†é¡");

        document.getElementById('print-config-modal').style.display='none';
        const a=document.getElementById('print-area'); a.style.display='grid'; a.className='mode-bulk'; a.innerHTML="";
        
        requests.forEach((cat, i) => {
            let id='BOX-'+Math.floor(1000+Math.random()*9000);
            while(localDB[id]) id='BOX-'+Math.floor(1000+Math.random()*9000);
            const d=document.createElement('div'); d.className='print-card';
            d.innerHTML=`<div class="print-id">${id}</div><div class="print-cat">${getCatIcon(cat)} ${cat}</div><div id="pq${i}"></div>`;
            a.appendChild(d);
            new QRCode(document.getElementById(`pq${i}`),{text:id,width:128,height:128});
        });
        setTimeout(()=>{window.print();a.style.display='none'},500);
    }

    // PWA Service Worker Registration
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            navigator.serviceWorker.register('./sw.js').then(function(registration) {
                console.log('ServiceWorker registration successful with scope: ', registration.scope);
            }, function(err) {
                console.log('ServiceWorker registration failed: ', err);
            });
        });
    }
</script>
</body>
</html>
