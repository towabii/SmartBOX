<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AI Logistics Box</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@latest"></script>
    
    <style>
        :root { --primary: #2563eb; --accent: #f59e0b; --bg: #f3f4f6; --text: #1f2937; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 0; background: var(--bg); color: var(--text); padding-bottom: 90px; user-select: none; }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ & é€šçŸ¥ */
        header { background: var(--primary); color: white; padding: 15px; position: sticky; top: 0; z-index: 100; display:flex; justify-content:space-between; align-items:center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { margin: 0; font-size: 1.1rem; font-weight: 700; }
        .badge { background: var(--accent); color: white; padding: 3px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: bold; }
        
        #toast { position: fixed; top: 70px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px; font-size: 0.9rem; display: none; z-index: 2000; }

        /* ã‚³ãƒ³ãƒ†ãƒŠ */
        .container { max-width: 600px; margin: 0 auto; padding: 15px; }
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        
        /* UIãƒ‘ãƒ¼ãƒ„ */
        input, select { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #e5e7eb; border-radius: 8px; background: #f9fafb; box-sizing: border-box; font-size: 1rem; }
        button { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 0.95rem; margin-bottom: 8px; }
        button.primary { background: var(--primary); color: white; }
        button.secondary { background: #e5e7eb; color: #4b5563; }
        button.danger { background: #fee2e2; color: #dc2626; width: auto; padding: 5px 12px; font-size: 0.8rem; margin: 0; }
        button:active { transform: scale(0.98); }

        /* é«˜é€Ÿãƒ¢ãƒ¼ãƒ‰ç”¨ */
        .fast-mode-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: #000; z-index: 1500; display:none; flex-direction:column; }
        .fast-video-container { flex: 1; position: relative; overflow: hidden; }
        #fast-video { width: 100%; height: 100%; object-fit: cover; }
        .fast-controls { padding: 20px; background: rgba(0,0,0,0.8); text-align: center; color: white; }
        #fast-log { position: absolute; bottom: 10px; left: 10px; color: #0f0; font-family: monospace; font-size: 1rem; background: rgba(0,0,0,0.5); padding: 5px; border-radius: 5px; pointer-events: none; }
        .scan-line { position: absolute; top: 50%; left: 0; width: 100%; height: 2px; background: cyan; box-shadow: 0 0 10px cyan; }

        /* ãƒªã‚¹ãƒˆè¡¨ç¤º */
        .box-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f3f4f6; cursor: pointer; }
        .box-tag { font-size: 0.75rem; color: #6b7280; background: #f3f4f6; padding: 2px 6px; border-radius: 4px; margin-right: 5px; }
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f3f4f6; }
        .num-circle { display: inline-flex; width: 20px; height: 20px; background: var(--primary); color: white; border-radius: 50%; font-size: 0.7rem; align-items: center; justify-content: center; margin-right: 8px; }

        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #e5e7eb; display: flex; padding-bottom: env(safe-area-inset-bottom); z-index: 1000; }
        .nav-item { flex: 1; text-align: center; padding: 10px 0; color: #9ca3af; font-size: 0.7rem; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-icon { font-size: 1.4rem; display: block; margin-bottom: 2px; }

        /* ãã®ä»– */
        .view { display: none; animation: fadeIn 0.2s; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .recommendation-box { background: #eff6ff; border: 1px solid #bfdbfe; color: #1e40af; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 0.9rem; display: none; }
    </style>
</head>
<body>

<!-- é€šçŸ¥ãƒˆãƒ¼ã‚¹ãƒˆ -->
<div id="toast">ä¿å­˜ã—ã¾ã—ãŸ</div>

<header>
    <h1>ğŸ“¦ AI Logistics</h1>
    <div class="badge" id="storage-status">Syncing...</div>
</header>

<div class="container">

    <!-- 1. ã‚¹ã‚­ãƒ£ãƒ³/ãƒ›ãƒ¼ãƒ ç”»é¢ -->
    <div id="view-scan" class="view active">
        <div id="scan-ui" class="card">
            <h3 style="text-align:center; margin:0 0 10px 0;">QRã‚¹ã‚­ãƒ£ãƒ³</h3>
            <div id="reader" style="border-radius:8px; overflow:hidden; background:#000;"></div>
            <p style="text-align:center; font-size:0.8rem; color:#666; margin-top:10px;">ç®±ã®QRã‚’èª­ã¿å–ã£ã¦ãã ã•ã„</p>
        </div>

        <!-- ç®±è©³ç´°ç”»é¢ -->
        <div id="box-ui" class="card" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <span style="font-size:1.2rem; font-weight:bold; color:var(--primary);" id="disp-id">BOX-00</span>
                <span class="box-tag" id="disp-category">æœªåˆ†é¡</span>
            </div>
            
            <input type="text" id="inp-loc" placeholder="ä¿ç®¡å ´æ‰€ (ä¾‹: ã‚¯ãƒ­ãƒ¼ã‚¼ãƒƒãƒˆ)" onchange="saveBox()">
            
            <!-- ä¸­èº«ãƒªã‚¹ãƒˆ -->
            <div style="max-height:250px; overflow-y:auto; margin-bottom:15px;">
                <div id="item-list"></div>
            </div>

            <div style="border-top:2px dashed #e5e7eb; padding-top:15px;">
                <!-- ã‚¹ãƒãƒ¼ãƒˆææ¡ˆè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div id="recommend-area" class="recommendation-box">
                    ğŸ’¡ <b>ææ¡ˆ:</b> <span id="rec-msg"></span>
                </div>

                <!-- é€šå¸¸å…¥åŠ› -->
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <input type="text" id="inp-item" placeholder="å“åã‚’å…¥åŠ›..." oninput="checkRecommendation()">
                    <button class="primary" style="width:80px;" onclick="addItemManually()">è¿½åŠ </button>
                </div>

                <button class="primary" onclick="startFastMode()" style="background: linear-gradient(45deg, #2563eb, #8b5cf6);">
                    ğŸš€ é«˜é€Ÿå…¥ç®±ãƒ¢ãƒ¼ãƒ‰ (ã‚«ãƒ¡ãƒ©+éŸ³å£°)
                </button>
            </div>
            <button class="secondary" onclick="closeBox()">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <!-- 2. ãƒœãƒƒã‚¯ã‚¹ä¸€è¦§ç”»é¢ -->
    <div id="view-list" class="view">
        <div class="card">
            <input type="text" id="filter-input" placeholder="ğŸ” åå‰ã€å ´æ‰€ã€ä¸­èº«ã§æ¤œç´¢..." onkeyup="renderBoxList()">
            <div id="box-list-container"></div>
        </div>
    </div>

    <!-- 3. QRä½œæˆãƒ»è¨­å®š -->
    <div id="view-settings" class="view">
        <div class="card">
            <h3>QRã‚³ãƒ¼ãƒ‰ç™ºè¡Œ</h3>
            <input type="text" id="new-id" readonly>
            <div id="qrcode-display" style="display:flex; justify-content:center; padding:10px;"></div>
            <button class="primary" onclick="createQR()">IDç™ºè¡Œ</button>
        </div>
        <div class="card">
            <button class="secondary" onclick="fetchData(true)">â˜ï¸ ãƒ‡ãƒ¼ã‚¿ã‚’å¼·åˆ¶æ›´æ–°</button>
        </div>
    </div>
</div>

<!-- é«˜é€Ÿãƒ¢ãƒ¼ãƒ‰ UI -->
<div id="fast-mode-ui" class="fast-mode-overlay">
    <div class="fast-video-container">
        <video id="fast-video" autoplay playsinline muted></video>
        <div class="scan-line"></div>
        <div id="fast-log">å¾…æ©Ÿä¸­...</div>
    </div>
    <div class="fast-controls">
        <p style="margin:0 0 10px 0; font-size:0.9rem;">å“ç‰©ã‚’ã‚«ãƒ¡ãƒ©ã«è¦‹ã›ã‚‹ã‹ã€éŸ³å£°ã§è©±ã—ã¦ãã ã•ã„ã€‚<br>ã€Œå®Œäº†ã€ã¨è¨€ã†ã‹ãƒœã‚¿ãƒ³ã§çµ‚äº†ã€‚</p>
        <button class="danger" onclick="stopFastMode()">çµ‚äº†ã—ã¦ä¿å­˜</button>
    </div>
</div>

<!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
<div class="nav">
    <div class="nav-item active" onclick="switchTab('scan')"><span class="nav-icon">ğŸ“·</span>ã‚¹ã‚­ãƒ£ãƒ³</div>
    <div class="nav-item" onclick="switchTab('list')"><span class="nav-icon">ğŸ“¦</span>ä¸€è¦§</div>
    <div class="nav-item" onclick="switchTab('settings')"><span class="nav-icon">âš™ï¸</span>è¨­å®š</div>
</div>

<script>
    // â–¼â–¼â–¼ è¨­å®šã‚¨ãƒªã‚¢ â–¼â–¼â–¼
    const GAS_URL = "https://script.google.com/macros/s/AKfycbz-8sgey9IKDrB0bga-hnXD2gDsahEb2ZQEyIe_LmQF7MwBCy-bC5ldWflplIQkJV9kAQ/exec"; 
    // â–²â–²â–² è¨­å®šã‚¨ãƒªã‚¢ â–²â–²â–²

    let localDB = {}; // { "BOX-1": { loc: "", items: [], category: "" } }
    let currentBoxId = null;
    let qrScanner = null;
    let aiModel = null;
    
    // é«˜é€Ÿãƒ¢ãƒ¼ãƒ‰ç”¨å¤‰æ•°
    let fastStream = null;
    let isFastMode = false;
    let recognition = null; // éŸ³å£°èªè­˜
    let lastSpokenItem = "";
    let lastAiItem = "";
    let lastAiTime = 0;

    // --- åˆæœŸåŒ– ---
    window.onload = async () => {
        if(GAS_URL.includes("URL")) alert("GASã®URLã‚’è¨­å®šã—ã¦ãã ã•ã„");
        await fetchData();
        createQR();
        initSpeech();
    };

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.style.display = 'block';
        setTimeout(()=> t.style.display='none', 2000);
    }

    // --- ãƒ‡ãƒ¼ã‚¿é€šä¿¡ ---
    async function fetchData(force=false) {
        document.getElementById('storage-status').innerText = "Sync...";
        try {
            const res = await fetch(GAS_URL);
            localDB = await res.json();
            document.getElementById('storage-status').innerText = "Ready";
            if(force) { showToast("æ›´æ–°å®Œäº†"); renderBoxList(); }
        } catch(e) {
            document.getElementById('storage-status').innerText = "Error";
        }
    }

    async function pushData(boxId, loc, items, category="æœªåˆ†é¡") {
        document.getElementById('storage-status').innerText = "Saving...";
        try {
            const payload = { boxId, location: loc, items, category, action: 'save' };
            const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) });
            const json = await res.json();
            // ã‚µãƒ¼ãƒãƒ¼å´ã§åˆ¤å®šã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªã‚’åæ˜ 
            if(localDB[boxId]) localDB[boxId].category = json.category;
            renderBoxHeader(); 
            document.getElementById('storage-status').innerText = "Saved";
        } catch(e) {
            document.getElementById('storage-status').innerText = "Error";
        }
    }

    async function sendLearningData(english, japanese) {
        // AIã®èª¤åˆ¤å®šã‚’ä¿®æ­£ã—ãŸã¨ãã«å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’é€ã‚‹
        fetch(GAS_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'learn', english, japanese })
        });
    }

    // --- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ ---
    function switchTab(tab) {
        document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        document.getElementById('view-'+tab).classList.add('active');
        
        const idx = ['scan','list','settings'].indexOf(tab);
        document.querySelectorAll('.nav-item')[idx].classList.add('active');

        if(tab==='scan') startQR(); else stopQR();
        if(tab==='list') renderBoxList();
    }

    // --- QRå‡¦ç† ---
    function startQR() {
        if(currentBoxId) return;
        if(!qrScanner) {
            qrScanner = new Html5Qrcode("reader");
            qrScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
            (decoded) => openBox(decoded)).catch(()=>{});
        }
    }
    function stopQR() {
        if(qrScanner) qrScanner.stop().then(()=>{ qrScanner.clear(); qrScanner=null; }).catch(()=>{});
    }

    // --- ãƒœãƒƒã‚¯ã‚¹æ“ä½œ ---
    function openBox(id) {
        stopQR();
        currentBoxId = id;
        document.getElementById('scan-ui').style.display = 'none';
        document.getElementById('box-ui').style.display = 'block';
        
        if(!localDB[id]) localDB[id] = { loc: "", items: [], category: "æ–°è¦" };
        
        renderBoxHeader();
        renderItems();
    }

    function renderBoxHeader() {
        if(!currentBoxId) return;
        const data = localDB[currentBoxId];
        document.getElementById('disp-id').innerText = currentBoxId;
        document.getElementById('disp-category').innerText = data.category || "æœªåˆ†é¡";
        document.getElementById('inp-loc').value = data.loc;
    }

    function renderItems() {
        const list = document.getElementById('item-list');
        list.innerHTML = "";
        const items = localDB[currentBoxId].items;
        
        items.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = 'item-row';
            div.innerHTML = `
                <div><span class="num-circle">${getDuplicateNumber(item, items, idx)}</span> ${item}</div>
                <button class="danger" onclick="deleteItem(${idx})">å‰Šé™¤</button>
            `;
            list.appendChild(div);
        });
    }

    // é‡è¤‡æ™‚ã®ç•ªå·ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ (ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼â‘ , ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼â‘¡...)
    function getDuplicateNumber(currentItem, allItems, currentIndex) {
        // è‡ªåˆ†ã‚ˆã‚Šå‰ã«åŒã˜åå‰ãŒã„ãã¤ã‚ã‚‹ã‹ã‚«ã‚¦ãƒ³ãƒˆ
        let count = 0;
        for(let i=0; i<=currentIndex; i++) {
            if(allItems[i] === currentItem) count++;
        }
        return count; 
    }

    function addItemManually() {
        const inp = document.getElementById('inp-item');
        const val = inp.value.trim();
        if(val) {
            addItem(val);
            inp.value = "";
            document.getElementById('recommend-area').style.display = 'none';
        }
    }

    function addItem(name) {
        const data = localDB[currentBoxId];
        data.items.push(name);
        saveBox();
        renderItems();
    }

    function deleteItem(idx) {
        if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            localDB[currentBoxId].items.splice(idx, 1);
            saveBox();
            renderItems();
        }
    }

    function saveBox() {
        const data = localDB[currentBoxId];
        const loc = document.getElementById('inp-loc').value;
        data.loc = loc;
        pushData(currentBoxId, loc, data.items, data.category);
    }

    function closeBox() {
        currentBoxId = null;
        document.getElementById('box-ui').style.display = 'none';
        document.getElementById('scan-ui').style.display = 'block';
        startQR();
    }

    // --- ã‚¹ãƒãƒ¼ãƒˆææ¡ˆ (Smart Recommendation) ---
    function checkRecommendation() {
        const keyword = document.getElementById('inp-item').value.toLowerCase();
        const area = document.getElementById('recommend-area');
        const msg = document.getElementById('rec-msg');
        
        if(keyword.length < 2) { area.style.display = 'none'; return; }

        // ç°¡æ˜“ãƒ­ã‚¸ãƒƒã‚¯: ã‚«ãƒ†ã‚´ãƒªåã‚„ä¸­èº«ã«ä¼¼ãŸã‚‚ã®ãŒã‚ã‚‹ç®±ã‚’æ¢ã™
        let bestBox = null;
        let maxScore = 0;

        Object.keys(localDB).forEach(id => {
            if(id === currentBoxId) return; // ä»Šã®ç®±ã¯é™¤ã
            const box = localDB[id];
            let score = 0;
            
            // ã‚«ãƒ†ã‚´ãƒªä¸€è‡´
            if(box.category && keyword.includes(box.category)) score += 5;
            // ãƒ‘ã‚½ã‚³ãƒ³ãªã©ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ä¸€è‡´
            if(box.category === "PCãƒ»ã‚¬ã‚¸ã‚§ãƒƒãƒˆ" && (keyword.includes("ãƒã‚¦ã‚¹") || keyword.includes("pc"))) score += 10;
            // ä¸­èº«ã®éƒ¨åˆ†ä¸€è‡´
            if(box.items.some(i => i.includes(keyword))) score += 3;

            if(score > maxScore) {
                maxScore = score;
                bestBox = id;
            }
        });

        if(bestBox) {
            area.style.display = 'block';
            msg.innerHTML = `<span style="cursor:pointer; text-decoration:underline;" onclick="alert('ã“ã®ç®±ã‚’é–‰ã˜ã¦ ${bestBox} ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„')">${bestBox} (${localDB[bestBox].category})</span> ã«ä¼¼ãŸã‚‚ã®ãŒã‚ã‚Šã¾ã™`;
        } else {
            area.style.display = 'none';
        }
    }

    // --- ãƒœãƒƒã‚¯ã‚¹ä¸€è¦§è¡¨ç¤º ---
    function renderBoxList() {
        const filter = document.getElementById('filter-input').value.toLowerCase();
        const container = document.getElementById('box-list-container');
        container.innerHTML = "";

        Object.keys(localDB).forEach(id => {
            const box = localDB[id];
            const text = `${id} ${box.loc} ${box.category} ${box.items.join(' ')}`.toLowerCase();
            if(text.includes(filter)) {
                const div = document.createElement('div');
                div.className = 'box-row';
                div.onclick = () => { switchTab('scan'); openBox(id); }; // ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°ã¸
                div.innerHTML = `
                    <div>
                        <div style="font-weight:bold; color:var(--primary);">${id} <span style="font-size:0.8rem; color:#666;">@${box.loc}</span></div>
                        <div style="font-size:0.8rem; margin-top:2px;">
                            <span class="box-tag">${box.category||'æœª'}</span>
                            ${box.items.length}ç‚¹
                        </div>
                    </div>
                    <div style="font-size:1.2rem; color:#ccc;">â€º</div>
                `;
                container.appendChild(div);
            }
        });
    }

    // --- ğŸš€ é«˜é€Ÿå…¥ç®±ãƒ¢ãƒ¼ãƒ‰ (High-Speed Mode) ---
    async function startFastMode() {
        if(!aiModel) aiModel = await mobilenet.load();
        
        isFastMode = true;
        document.getElementById('fast-mode-ui').style.display = 'flex';
        
        // ã‚«ãƒ¡ãƒ©èµ·å‹•
        const video = document.getElementById('fast-video');
        try {
            fastStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            video.srcObject = fastStream;
            loopFastAI(); // AIãƒ«ãƒ¼ãƒ—é–‹å§‹
            if(recognition) recognition.start(); // éŸ³å£°èªè­˜é–‹å§‹
        } catch(e) {
            alert("ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼");
            stopFastMode();
        }
    }

    function stopFastMode() {
        isFastMode = false;
        if(fastStream) fastStream.getTracks().forEach(t=>t.stop());
        if(recognition) recognition.stop();
        document.getElementById('fast-mode-ui').style.display = 'none';
        saveBox(); // æœ€å¾Œã«ä¿å­˜
        renderItems();
    }

    // AIç›£è¦–ãƒ«ãƒ¼ãƒ—
    async function loopFastAI() {
        if(!isFastMode) return;
        const video = document.getElementById('fast-video');
        const log = document.getElementById('fast-log');

        if(video.readyState === 4) {
            const now = Date.now();
            // 2ç§’ã«1å›ç¨‹åº¦ã®åˆ¤å®šé »åº¦ã«åˆ¶é™ (èª¤æ¤œçŸ¥é˜²æ­¢)
            if(now - lastAiTime > 2000) {
                const preds = await aiModel.classify(video);
                if(preds && preds.length > 0) {
                    const top = preds[0];
                    // ç¢ºç‡60%ä»¥ä¸Šã§ã€å‰å›ã¨åŒã˜ç‰©ä½“ã§ãªã‘ã‚Œã°ç™»éŒ²
                    if(top.probability > 0.6) {
                        // GASçµŒç”±ã§ç¿»è¨³ã—ã¦ç™»éŒ²
                        const jaName = await translate(top.className);
                        registerFastItem(jaName, top.className); // å…ƒã®è‹±èªã‚‚æ¸¡ã—ã¦å­¦ç¿’å¯èƒ½ã«
                        lastAiTime = now;
                    }
                }
            }
        }
        requestAnimationFrame(loopFastAI);
    }

    // éŸ³å£°èªè­˜ (Web Speech API)
    function initSpeech() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'ja-JP';
            recognition.continuous = true;
            recognition.onresult = (event) => {
                const last = event.results.length - 1;
                const text = event.results[last][0].transcript.trim();
                if(text === "å®Œäº†" || text === "çµ‚äº†") {
                    stopFastMode();
                } else {
                    registerFastItem(text, null); // æ‰‹å‹•(éŸ³å£°)å…¥åŠ›ãªã®ã§è‹±èªãƒ©ãƒ™ãƒ«ã¯ãªã—
                }
            };
        }
    }

    // ã‚¢ã‚¤ãƒ†ãƒ ç™»éŒ² & ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
    function registerFastItem(name, originalEng) {
        // é‡è¤‡é˜²æ­¢ï¼ˆç›´å‰ã®ã‚‚ã®ã¨åŒã˜ãªã‚‰ç„¡è¦–ï¼‰
        if(name === lastSpokenItem) return;
        lastSpokenItem = name;

        // ãƒ­ã‚°è¡¨ç¤º
        const log = document.getElementById('fast-log');
        log.innerText = `ç™»éŒ²: ${name}`;
        log.style.color = "#0f0";

        // éŸ³å£°èª­ã¿ä¸Šã’
        const u = new SpeechSynthesisUtterance(name + "ã‚’ç™»éŒ²");
        speechSynthesis.speak(u);

        // ãƒ‡ãƒ¼ã‚¿è¿½åŠ 
        localDB[currentBoxId].items.push(name);
        
        // ã‚‚ã—AIç”±æ¥ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¾Œã§åå‰ã‚’ä¿®æ­£ã—ãŸã‚‰å­¦ç¿’ã•ã›ã‚‹ãŸã‚ã®ãƒ•ãƒƒã‚¯ï¼ˆç°¡æ˜“å®Ÿè£…ã¨ã—ã¦ã€ã“ã“ã§ã¯AIåˆ¤å®šç›´å¾Œã«ã€Œä¿®æ­£UIã€ã‚’å‡ºã™ã®ã¯é«˜é€Ÿãƒ¢ãƒ¼ãƒ‰ã®é‚ªé­”ã«ãªã‚‹ãŸã‚ã€å¾Œã§ä¸€è¦§ã‹ã‚‰ä¿®æ­£ã—ãŸéš›ã«å­¦ç¿’ã•ã›ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ãŒè‰¯ã„ãŒã€ä»Šå›ã¯è‡ªå‹•ç™»éŒ²ã¾ã§ï¼‰
        // â€» ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä¿®æ­£ã™ã‚‹UIã¯ã“ã“ã«ã¯ãªã„ãŒã€é€šå¸¸ã®ãƒªã‚¹ãƒˆç”»é¢ã§ä¿®æ­£å¯èƒ½
    }

    // ç¿»è¨³ãƒ˜ãƒ«ãƒ‘ãƒ¼
    async function translate(text) {
        try {
            const res = await fetch(`${GAS_URL}?action=translate&text=${encodeURIComponent(text)}`);
            const json = await res.json();
            return json.translated.split(',')[0]; // æœ€åˆã®å€™è£œã ã‘
        } catch(e) { return text; }
    }

    // --- ãã®ä»– ---
    function createQR() {
        const id = 'BOX-' + Math.floor(10000 + Math.random()*90000);
        document.getElementById('new-id').value = id;
        document.getElementById('qrcode-display').innerHTML = "";
        new QRCode(document.getElementById("qrcode-display"), { text: id, width: 128, height: 128 });
    }
</script>
</body>
</html>
