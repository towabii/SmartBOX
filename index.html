<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Box Pro</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@latest"></script>

    <style>
        :root { --primary: #007bff; --bg: #f8f9fa; --text: #343a40; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 0; background: var(--bg); color: var(--text); padding-bottom: 80px; }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        header { background: var(--primary); color: white; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { margin: 0; font-size: 1.1rem; letter-spacing: 1px; }

        /* ã‚³ãƒ³ãƒ†ãƒŠ */
        .container { max-width: 600px; margin: 0 auto; padding: 15px; }
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }

        /* UIãƒ‘ãƒ¼ãƒ„ */
        input, button { font-size: 1rem; border-radius: 8px; box-sizing: border-box; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; margin-bottom: 10px; background: #fafafa; }
        button { width: 100%; padding: 12px; border: none; background: var(--primary); color: white; font-weight: bold; cursor: pointer; margin-bottom: 8px; transition: opacity 0.2s; }
        button:active { opacity: 0.8; }
        button.secondary { background: #6c757d; }
        button.danger { background: #dc3545; font-size: 0.8rem; padding: 5px 10px; width: auto; margin: 0; }
        button.ai-btn { background: #28a745; display: flex; align-items: center; justify-content: center; gap: 8px; }

        /* ãƒªã‚¹ãƒˆè¡¨ç¤º */
        .box-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 10px; }
        .box-title { font-weight: 900; color: var(--primary); font-size: 1.2rem; }
        .box-meta { font-size: 0.85rem; color: #666; background: #eee; padding: 4px 8px; border-radius: 4px; }
        
        .item-row { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
        .item-info { display: flex; align-items: center; gap: 10px; }
        .item-num { background: #e9ecef; color: #495057; font-size: 0.8rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; min-width: 25px; text-align: center; }
        .item-name { font-weight: 500; }
        .count-badge { background: var(--primary); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; }

        /* ã‚«ãƒ¡ãƒ©ã‚¨ãƒªã‚¢ */
        #reader { width: 100%; border-radius: 8px; overflow: hidden; background: #000; }
        #ai-video { width: 100%; border-radius: 8px; display: none; margin-bottom: 10px; }
        #ai-status { text-align: center; font-size: 0.9rem; color: #28a745; margin: 5px 0; display: none; }
        #qrcode-display { display: flex; justify-content: center; padding: 20px; }

        /* ã‚¿ãƒ–ãƒãƒ¼ */
        .nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #ddd; display: flex; justify-content: space-around; padding-bottom: env(safe-area-inset-bottom); z-index: 999; }
        .nav-item { padding: 12px 0; flex: 1; text-align: center; font-size: 0.75rem; color: #888; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-icon { font-size: 1.4rem; display: block; margin-bottom: 2px; }

        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<header>
    <h1>ğŸ“¦ Smart Box Pro</h1>
</header>

<div class="container">
    
    <!-- 1. ã‚¹ã‚­ãƒ£ãƒ³ & ç™»éŒ²ç”»é¢ -->
    <div id="view-scan" class="view active">
        <div id="scan-mode" class="card">
            <h3 style="text-align:center; margin-top:0;">QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³</h3>
            <div id="reader"></div>
            <p style="text-align:center; color:#666; font-size:0.8rem;">ç®±ã®QRã‚³ãƒ¼ãƒ‰ã‚’å†™ã—ã¦ãã ã•ã„</p>
        </div>

        <!-- ç®±ã®ä¸­èº«è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="box-detail" class="card" style="display:none;">
            <div class="box-header">
                <span class="box-title" id="disp-id">BOX-00</span>
                <span class="count-badge">åˆè¨ˆ: <span id="disp-count">0</span>ç‚¹</span>
            </div>
            
            <input type="text" id="inp-location" placeholder="ä¿ç®¡å ´æ‰€ (ä¾‹: 2éš ã‚¯ãƒ­ãƒ¼ã‚¼ãƒƒãƒˆ)" onchange="saveCurrentBox()">
            
            <div style="max-height: 250px; overflow-y: auto; margin-bottom:15px;">
                <div id="item-list-container"></div>
            </div>

            <!-- è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div style="border-top: 2px dashed #ddd; padding-top: 15px;">
                <h4 style="margin:0 0 10px 0;">ã‚¢ã‚¤ãƒ†ãƒ è¿½åŠ </h4>
                
                <!-- AIã‚«ãƒ¡ãƒ© -->
                <video id="ai-video" autoplay playsinline muted></video>
                <div id="ai-status">AIæº–å‚™ä¸­...</div>
                
                <button id="btn-ai-start" class="ai-btn" onclick="startAICamera()">
                    <span>ğŸ¤– AIã§è‡ªå‹•å…¥åŠ›</span>
                </button>
                <button id="btn-ai-snap" class="ai-btn" style="display:none; background:#ff9800;" onclick="identifyItem()">
                    <span>ğŸ“¸ ã“ã‚Œã‚’èªè­˜ï¼</span>
                </button>

                <div style="display:flex; gap:5px;">
                    <input type="text" id="inp-item" placeholder="å“åã‚’å…¥åŠ›" style="margin:0;">
                    <button onclick="addItem()" style="width:80px; margin:0;">è¿½åŠ </button>
                </div>
            </div>
            <button class="secondary" onclick="closeBox()" style="margin-top:10px;">é–‰ã˜ã‚‹ / ã‚¹ã‚­ãƒ£ãƒ³ã«æˆ»ã‚‹</button>
        </div>
    </div>

    <!-- 2. æ¤œç´¢ç”»é¢ -->
    <div id="view-search" class="view">
        <div class="card">
            <input type="text" id="search-keyword" placeholder="ğŸ” ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ (ä¾‹: å†¬æœ, ã‚±ãƒ¼ãƒ–ãƒ«)" onkeyup="runSearch()">
            <div id="search-results"></div>
        </div>
    </div>

    <!-- 3. QRä½œæˆãƒ»è¨­å®š -->
    <div id="view-settings" class="view">
        <div class="card">
            <h3>QRã‚³ãƒ¼ãƒ‰ä½œæˆ</h3>
            <p style="font-size:0.9rem; color:#666;">æ–°ã—ã„ç®±ç”¨ã®IDã‚’ç™ºè¡Œã—ã¾ã™ã€‚</p>
            <input type="text" id="new-id" readonly>
            <div id="qrcode-display"></div>
            <button onclick="createQR()">æ–°ã—ã„IDã‚’ç™ºè¡Œ</button>
        </div>
        <div class="card">
            <h3>ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
            <p>ä½¿ç”¨å®¹é‡: <span id="storage-usage">0</span> KB</p>
            <button class="danger" onclick="clearData()" style="width:100%;">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤</button>
        </div>
    </div>

</div>

<!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
<div class="nav">
    <div class="nav-item active" onclick="changeTab('scan')">
        <span class="nav-icon">ğŸ“·</span>ã‚¹ã‚­ãƒ£ãƒ³
    </div>
    <div class="nav-item" onclick="changeTab('search')">
        <span class="nav-icon">ğŸ”</span>æ¤œç´¢
    </div>
    <div class="nav-item" onclick="changeTab('settings')">
        <span class="nav-icon">âš™ï¸</span>QRä½œæˆ
    </div>
</div>

<script>
    // --- ãƒ‡ãƒ¼ã‚¿ç®¡ç† (LocalStorage) ---
    // ãƒ‡ãƒ¼ã‚¿å½¢å¼: { "BOX-ID": { loc: "å ´æ‰€", items: ["å“ç‰©A", "å“ç‰©B"] } }
    // itemsé…åˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹+1 ãŒã€Œä½•ç•ªç›®ã«å…¥ã‚ŒãŸã‹ã€ã«ãªã‚Šã¾ã™ã€‚
    const DB_KEY = 'smartbox_db';

    function getDB() {
        return JSON.parse(localStorage.getItem(DB_KEY) || '{}');
    }

    function saveDB(data) {
        localStorage.setItem(DB_KEY, JSON.stringify(data));
        updateStorageInfo();
    }

    // --- UIåˆ¶å¾¡ ---
    let scanner = null;
    let currentBoxID = null;
    let aiModel = null;
    let aiStream = null;

    function changeTab(tabName) {
        document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        
        document.getElementById('view-' + tabName).classList.add('active');
        // ãƒŠãƒ“ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
        const tabs = ['scan', 'search', 'settings'];
        document.querySelectorAll('.nav-item')[tabs.indexOf(tabName)].classList.add('active');

        if(tabName === 'scan') startScanner(); else stopScanner();
        if(tabName === 'search') runSearch();
        if(tabName === 'settings') updateStorageInfo();
    }

    // --- QRã‚¹ã‚­ãƒ£ãƒ³æ©Ÿèƒ½ ---
    function startScanner() {
        if(currentBoxID) return; // ç®±ã‚’é–‹ã„ã¦ã„ã‚‹æ™‚ã¯èµ·å‹•ã—ãªã„
        if(!scanner) {
            scanner = new Html5Qrcode("reader");
            scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (decodedText) => {
                openBox(decodedText);
            }).catch(err => console.error(err));
        }
    }

    function stopScanner() {
        if(scanner) {
            scanner.stop().then(() => { scanner.clear(); scanner = null; }).catch(err=>{});
        }
    }

    // --- ç®±æ“ä½œ ---
    function openBox(id) {
        stopScanner();
        currentBoxID = id;
        document.getElementById('scan-mode').style.display = 'none';
        document.getElementById('box-detail').style.display = 'block';

        const db = getDB();
        const box = db[id] || { loc: "", items: [] };

        document.getElementById('disp-id').innerText = id;
        document.getElementById('inp-location').value = box.loc;
        renderItems(box.items);
    }

    function renderItems(items) {
        const container = document.getElementById('item-list-container');
        document.getElementById('disp-count').innerText = items.length;
        container.innerHTML = "";

        if(items.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:#999;">ã¾ã ä½•ã‚‚å…¥ã£ã¦ã„ã¾ã›ã‚“</p>';
            return;
        }

        items.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'item-row';
            // ç•ªå·ã¯ index + 1 ã§è¡¨ç¤º
            div.innerHTML = `
                <div class="item-info">
                    <span class="item-num">#${index + 1}</span>
                    <span class="item-name">${item}</span>
                </div>
                <button class="danger" onclick="deleteItem(${index})">å‰Šé™¤</button>
            `;
            container.appendChild(div);
        });
    }

    function addItem() {
        const inp = document.getElementById('inp-item');
        const name = inp.value.trim();
        if(!name) return;

        const db = getDB();
        if(!db[currentBoxID]) db[currentBoxID] = { loc: "", items: [] };
        
        // å ´æ‰€æƒ…å ±ã‚‚ä¿å­˜ (æœªå…¥åŠ›ãªã‚‰ç©ºæ–‡å­—)
        db[currentBoxID].loc = document.getElementById('inp-location').value;
        db[currentBoxID].items.push(name); // æœ«å°¾ã«è¿½åŠ 
        
        saveDB(db);
        inp.value = "";
        renderItems(db[currentBoxID].items);
    }

    function deleteItem(index) {
        if(!confirm("ã“ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        const db = getDB();
        db[currentBoxID].items.splice(index, 1);
        saveDB(db);
        renderItems(db[currentBoxID].items);
    }

    function saveCurrentBox() {
        if(!currentBoxID) return;
        const db = getDB();
        if(!db[currentBoxID]) db[currentBoxID] = { loc: "", items: [] };
        db[currentBoxID].loc = document.getElementById('inp-location').value;
        saveDB(db);
    }

    function closeBox() {
        saveCurrentBox();
        stopAICamera();
        currentBoxID = null;
        document.getElementById('box-detail').style.display = 'none';
        document.getElementById('scan-mode').style.display = 'block';
        startScanner();
    }

    // --- æ¤œç´¢æ©Ÿèƒ½ ---
    function runSearch() {
        const keyword = document.getElementById('search-keyword').value.toLowerCase();
        const container = document.getElementById('search-results');
        const db = getDB();
        container.innerHTML = "";

        if(!keyword) return;

        Object.keys(db).forEach(boxID => {
            const box = db[boxID];
            // ç®±IDã€å ´æ‰€ã€ã¾ãŸã¯ä¸­èº«ã®ã©ã‚Œã‹ã«ãƒ’ãƒƒãƒˆã™ã‚‹ã‹
            box.items.forEach((item, index) => {
                const fullText = `${boxID} ${box.loc} ${item}`.toLowerCase();
                if(fullText.includes(keyword)) {
                    // ãƒ’ãƒƒãƒˆã—ãŸã‚¢ã‚¤ãƒ†ãƒ ã‚’è¡¨ç¤º
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <div class="box-header" style="margin-bottom:5px; border:none; padding:0;">
                            <span class="box-title" style="font-size:1rem;">${boxID}</span>
                            <span class="box-meta">${box.loc || 'å ´æ‰€æœªå®š'}</span>
                        </div>
                        <div class="item-row" style="border:none; padding:0;">
                            <div class="item-info">
                                <span class="item-num">#${index + 1}</span>
                                <span class="item-name" style="font-weight:bold; color:#007bff;">${item}</span>
                            </div>
                        </div>
                    `;
                    // ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ãã®ç®±ã‚’é–‹ãæ©Ÿèƒ½ã‚’ã¤ã‘ã¦ã‚‚è‰¯ã„
                    container.appendChild(card);
                }
            });
            
            // ã‚¢ã‚¤ãƒ†ãƒ ã«ã¯ãƒ’ãƒƒãƒˆã—ãªã„ãŒã€ç®±ã®å ´æ‰€åã«ãƒ’ãƒƒãƒˆã—ãŸå ´åˆ
            if (!box.items.some(i => i.toLowerCase().includes(keyword)) && 
                (boxID.toLowerCase().includes(keyword) || box.loc.toLowerCase().includes(keyword))) {
                 const card = document.createElement('div');
                 card.className = 'card';
                 card.innerHTML = `
                    <div class="box-header">
                        <span class="box-title">${boxID}</span>
                        <span class="box-meta">${box.loc}</span>
                    </div>
                    <div style="font-size:0.8rem; color:#666;">ã“ã®ç®±ã®æƒ…å ±ã¾ãŸã¯å ´æ‰€ã«ãƒ’ãƒƒãƒˆã—ã¾ã—ãŸ</div>
                 `;
                 container.appendChild(card);
            }
        });
        
        if(container.innerHTML === "") {
            container.innerHTML = '<p style="text-align:center; color:#999;">è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>';
        }
    }

    // --- AIç”»åƒèªè­˜ ---
    async function startAICamera() {
        document.getElementById('btn-ai-start').style.display = 'none';
        document.getElementById('ai-status').style.display = 'block';
        document.getElementById('ai-status').innerText = 'AIãƒ¢ãƒ‡ãƒ«èª­è¾¼ä¸­...';

        if(!aiModel) aiModel = await mobilenet.load();

        document.getElementById('ai-status').innerText = 'ã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­...';
        const video = document.getElementById('ai-video');
        video.style.display = 'block';
        
        try {
            aiStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            video.srcObject = aiStream;
            document.getElementById('btn-ai-snap').style.display = 'flex';
            document.getElementById('ai-status').style.display = 'none';
        } catch(e) {
            alert("ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼");
        }
    }

    async function identifyItem() {
        const video = document.getElementById('ai-video');
        const predictions = await aiModel.classify(video);
        if(predictions && predictions.length > 0) {
            // è‹±èªã®çµæœãŒå‡ºã‚‹ã®ã§ã€ãã®ã¾ã¾å…¥åŠ›æ¬„ã¸
            document.getElementById('inp-item').value = predictions[0].className;
            alert(`ã€Œ${predictions[0].className}ã€ã‚’èªè­˜ã—ã¾ã—ãŸã€‚\næ—¥æœ¬èªã«ç›´ã—ã¦è¿½åŠ ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚`);
        }
        stopAICamera();
    }

    function stopAICamera() {
        if(aiStream) {
            aiStream.getTracks().forEach(t => t.stop());
            aiStream = null;
        }
        document.getElementById('ai-video').style.display = 'none';
        document.getElementById('btn-ai-snap').style.display = 'none';
        document.getElementById('btn-ai-start').style.display = 'flex';
        document.getElementById('ai-status').style.display = 'none';
    }

    // --- ãã®ä»–è¨­å®š ---
    function createQR() {
        const id = 'BOX-' + Math.floor(1000 + Math.random() * 9000);
        document.getElementById('new-id').value = id;
        document.getElementById('qrcode-display').innerHTML = "";
        new QRCode(document.getElementById("qrcode-display"), { text: id, width: 150, height: 150 });
    }

    function updateStorageInfo() {
        const size = new Blob([localStorage.getItem(DB_KEY)]).size;
        document.getElementById('storage-usage').innerText = (size / 1024).toFixed(2);
    }

    function clearData() {
        if(confirm("æœ¬å½“ã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) {
            localStorage.removeItem(DB_KEY);
            alert("æ¶ˆå»ã—ã¾ã—ãŸ");
            updateStorageInfo();
        }
    }

    // åˆæœŸåŒ–
    createQR();
</script>
</body>
</html>
