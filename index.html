<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Smart Box V13</title>
    
    <!-- Libraries -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@latest"></script>

    <style>
        :root { 
            --primary: #6366f1; 
            --primary-bg: #e0e7ff;
            --danger: #ef4444; 
            --warning: #f59e0b;
            --success: #10b981;
            --bg: #f8fafc; 
            --text: #334155;
            --card: #ffffff;
            --border: #e2e8f0;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            margin: 0; padding: 0; 
            background: var(--bg); color: var(--text); 
            padding-bottom: 120px; /* ä¸‹éƒ¨ãƒŠãƒ“ç”¨ã«ä½™ç™½ç¢ºä¿ */
            -webkit-tap-highlight-color: transparent; 
            line-height: 1.5;
        }
        
        /* ãƒ­ã‚°ã‚¤ãƒ³ */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; transition: opacity 0.3s; }
        #login-overlay input { width: 220px; text-align: center; font-size: 1.5rem; letter-spacing: 4px; margin: 20px 0; border: none; border-radius: 12px; padding: 12px; }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header { background: var(--primary); color: white; padding: 15px 20px; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.2); }
        h1 { margin: 0; font-size: 1.2rem; font-weight: 800; letter-spacing: 0.5px; }
        .sync-badge { font-size: 0.75rem; background: rgba(255,255,255,0.25); padding: 4px 12px; border-radius: 20px; font-weight: bold; backdrop-filter: blur(4px); }

        /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .container { max-width: 600px; margin: 0 auto; padding: 20px 15px; }
        .card { background: var(--card); border-radius: 20px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid var(--border); }
        .card-head { font-size: 1rem; font-weight: bold; margin-bottom: 15px; color: #64748b; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }

        /* ãƒ•ã‚©ãƒ¼ãƒ  */
        input, select { width: 100%; padding: 14px; margin-bottom: 12px; border: 1px solid var(--border); border-radius: 12px; background: #f8fafc; box-sizing: border-box; font-size: 1rem; transition: 0.2s; }
        input:focus { border-color: var(--primary); outline: none; background: white; box-shadow: 0 0 0 3px var(--primary-bg); }

        /* ãƒœã‚¿ãƒ³å…±é€š */
        button { width: 100%; padding: 14px; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; font-size: 0.95rem; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.1s; margin-bottom: 8px; min-height: 48px; /* ã‚¿ãƒƒãƒ—ã—ã‚„ã™ã */ }
        button:active { transform: scale(0.96); opacity: 0.9; }
        
        .btn-main { background: var(--primary); color: white; box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.3); }
        .btn-sub { background: #f1f5f9; color: #475569; border: 1px solid var(--border); }
        .btn-danger { background: #fee2e2; color: var(--danger); }
        .btn-success { background: #d1fae5; color: #065f46; }
        
        /* å°ã•ã„ãƒœã‚¿ãƒ³ (ãƒªã‚¹ãƒˆå†…ãªã©) */
        .btn-sm { 
            padding: 6px 14px; font-size: 0.8rem; width: auto; height: 36px; margin: 0; min-height: 36px; 
            white-space: nowrap; /* æ–‡å­—æŠ˜ã‚Šè¿”ã—é˜²æ­¢ */
        }

        /* ãƒœãƒƒã‚¯ã‚¹ä¸€è¦§ */
        .box-row { padding: 18px 10px; border-bottom: 1px solid #f1f5f9; cursor: pointer; position: relative; transition: background 0.2s; }
        .box-row:active { background: #f8fafc; }
        .box-row:last-child { border-bottom: none; }
        
        .box-info-top { display: flex; justify-content: space-between; align-items: baseline; flex-wrap: wrap; gap: 5px; }
        .box-id { font-weight: 900; color: var(--primary); font-size: 1.1rem; }
        .box-cat { font-size: 0.75rem; background: var(--primary-bg); color: var(--primary); padding: 4px 10px; border-radius: 8px; font-weight: bold; }
        
        .alert-badge { background: #fef2f2; color: var(--danger); padding: 3px 8px; border-radius: 6px; font-size: 0.7rem; display: none; font-weight: bold; border: 1px solid #fecaca; margin-left: 5px; }
        .alert-badge.show { display: inline-block; }

        /* ã‚¢ã‚¤ãƒ†ãƒ ãƒªã‚¹ãƒˆ (ã‚¹ãƒãƒ›è¦‹ã‚„ã™ã•æ”¹å–„) */
        .item-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 16px 0; 
            border-bottom: 1px solid #f1f5f9; 
            gap: 10px;
        }
        .item-content { 
            flex: 1; 
            min-width: 0; /* ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹ãƒœãƒƒã‚¯ã‚¹ã§ã®æ–‡å­—æº¢ã‚Œé˜²æ­¢ */
        }
        .item-name { 
            font-weight: bold; color: #334155; font-size: 1rem; 
            word-break: break-word; /* é•·ã„å˜èªã‚‚æŠ˜ã‚Šè¿”ã™ */
            line-height: 1.4;
        }
        .tag { 
            color: #0284c7; background: #e0f2fe; padding: 2px 8px; border-radius: 6px; 
            font-size: 0.75rem; display: inline-block; margin-top: 4px; white-space: nowrap;
        }
        .item-actions { 
            display: flex; gap: 8px; flex-shrink: 0; /* ãƒœã‚¿ãƒ³ãŒæ½°ã‚Œãªã„ã‚ˆã†ã« */
        }

        /* â˜…æ¤œç´¢ãƒã‚¤ãƒ©ã‚¤ãƒˆâ˜… */
        .hl { background: #fef08a; color: #854d0e; padding: 0 2px; border-radius: 2px; font-weight: bold; }

        /* â˜…ã‚¢ã‚¤ãƒ†ãƒ å¼·èª¿è¡¨ç¤ºï¼ˆã‚¸ãƒ£ãƒ³ãƒ—æ™‚ï¼‰â˜… */
        .highlight-target { background-color: #fff7ed; border: 2px solid #f97316; border-radius: 8px; padding: 10px; animation: flash 1.5s ease-in-out; }
        @keyframes flash {
            0% { background-color: #ffedd5; transform: scale(1); }
            50% { background-color: #fed7aa; transform: scale(1.02); }
            100% { background-color: #fff7ed; transform: scale(1); }
        }

        /* ææ¡ˆã‚¢ãƒ©ãƒ¼ãƒˆ */
        .suggestion-alert { display: none; margin-bottom: 15px; background: #fffbeb; border: 1px solid #fde68a; padding: 15px; border-radius: 12px; font-size: 0.95rem; color: #92400e; line-height: 1.6; }
        .jump-link { text-decoration: underline; cursor: pointer; color: #d97706; font-weight: bold; padding: 5px 0; display: inline-block; }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; justify-content: center; align-items: flex-end; backdrop-filter: blur(4px); }
        .modal-content { background: white; width: 100%; max-width: 600px; border-radius: 24px 24px 0 0; padding: 30px 20px; box-sizing: border-box; max-height: 85vh; overflow-y: auto; animation: slideUp 0.3s; }
        @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }

        /* é«˜é€Ÿãƒ¢ãƒ¼ãƒ‰UI */
        #fast-mode-ui { position: fixed; top:0; left:0; width:100%; height:100%; background: #000; z-index: 1500; display:none; flex-direction:column; }
        #fast-video { width: 100%; height: 100%; object-fit: cover; opacity: 0.6; }
        .fast-overlay { position: absolute; bottom: 0; width: 100%; background: linear-gradient(to top, #000, transparent); padding: 40px 20px; text-align: center; color: white; box-sizing: border-box; }
        #fast-log { font-size: 1.4rem; color: #4ade80; margin-bottom: 20px; min-height: 1.5em; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }

        /* ãƒŠãƒ“ */
        .nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid var(--border); display: flex; padding-bottom: env(safe-area-inset-bottom); z-index: 1000; box-shadow: 0 -5px 20px rgba(0,0,0,0.03); }
        .nav-item { flex: 1; text-align: center; padding: 12px 0; color: #94a3b8; font-size: 0.7rem; cursor: pointer; transition: 0.1s; }
        .nav-item.active { color: var(--primary); font-weight: bold; transform: translateY(-3px); }
        .nav-icon { font-size: 1.6rem; display: block; margin-bottom: 4px; }
        
        /* è¡¨ç¤ºåˆ‡æ›¿ */
        .view { display: none; animation: fadeIn 0.2s; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* å°åˆ· */
        #print-area { display: none; }
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; top: 0; left: 0; width: 100%; height: 100vh; padding: 10mm; box-sizing: border-box; }
            #print-area.mode-bulk { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: repeat(4, 1fr); gap: 10px; }
            #print-area.mode-single { display: flex; justify-content: center; align-items: center; }
            .print-card { border: 2px solid #000; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; border-radius: 8px; page-break-inside: avoid; }
            .print-id { font-size: 2rem; font-weight: bold; margin-bottom: 10px; }
            .mode-single .print-id { font-size: 4rem; }
        }
    </style>
</head>
<body>

<!-- ãƒ­ã‚°ã‚¤ãƒ³ -->
<div id="login-overlay">
    <h2>ğŸ”’ Smart Box</h2>
    <p style="opacity:0.8; margin-bottom:20px;">V13 Ultimate</p>
    <input type="password" id="login-pass" placeholder="****" maxlength="8">
    <button class="btn-main" style="width:240px; background:white; color:var(--primary);" onclick="login()">ãƒ­ãƒƒã‚¯è§£é™¤</button>
    <p id="login-msg" style="color:#fecaca; margin-top:15px; font-size:0.9rem;"></p>
</div>

<div class="header">
    <h1>ğŸ“¦ Smart Box V13</h1>
    <span id="sync-status" class="sync-badge">Wait</span>
</div>

<div class="container">

    <!-- 1. ã‚¹ã‚­ãƒ£ãƒ³ & ç·¨é›† -->
    <div id="view-scan" class="view active">
        <div id="scan-ui" class="card">
            <div class="card-head">QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³</div>
            <div id="reader" style="border-radius:16px; overflow:hidden; background:black; min-height:250px;"></div>
            <p style="text-align:center; font-size:0.85rem; color:#64748b; margin-top:15px;">â€»ã‚«ãƒ¡ãƒ©ã‚’è¨±å¯ã—ã¦ãã ã•ã„</p>
        </div>

        <!-- ç®±è©³ç´° -->
        <div id="box-ui" class="card" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:20px;">
                <div>
                    <div id="disp-id" class="box-id" style="font-size:1.6rem;">BOX-000</div>
                    <div style="margin-top:8px; display:flex; align-items:center; flex-wrap:wrap; gap:5px;">
                        <span id="disp-cat" class="box-cat" style="margin:0;">ã‚«ãƒ†ã‚´ãƒª</span>
                        <span id="disp-alert" class="alert-badge">âš ï¸ é•·æœŸæ”¾ç½®</span>
                    </div>
                </div>
                <button class="btn-sub" style="width:auto; padding:10px;" onclick="printQR()">ğŸ–¨ï¸</button>
            </div>
            
            <label style="font-size:0.85rem; font-weight:bold; color:#64748b;">ä¿ç®¡å ´æ‰€</label>
            <input type="text" id="inp-loc" placeholder="ä¾‹: ã‚¯ãƒ­ãƒ¼ã‚¼ãƒƒãƒˆä¸Šæ®µ" onchange="saveBox()">
            
            <!-- æ—¢å­˜åœ¨åº«ã®é‡è¤‡ã‚¢ãƒ©ãƒ¼ãƒˆ -->
            <div id="existing-dup-alert" class="suggestion-alert"></div>

            <!-- ãƒªã‚¹ãƒˆ -->
            <div class="card-head" style="margin-top:20px;">ä¸­èº«ãƒªã‚¹ãƒˆ</div>
            <div id="item-list-container" style="max-height:300px; overflow-y:auto; border:1px solid var(--border); border-radius:12px; padding:10px; margin-bottom:20px; background:#fff;"></div>

            <!-- è¿½åŠ ã‚¨ãƒªã‚¢ -->
            <div style="background:#f1f5f9; padding:20px; border-radius:16px;">
                <div class="card-head" style="border:none; padding:0; margin-bottom:10px;">ã‚¢ã‚¤ãƒ†ãƒ è¿½åŠ </div>
                
                <div style="display:flex; gap:10px;">
                    <input type="text" id="inp-name" placeholder="å“å (ä¾‹: é›»æ±  #å‚™è“„)" style="margin:0; flex:1;">
                    <button class="btn-main" style="width:auto; margin:0;" onclick="addItem()">è¿½åŠ </button>
                </div>

                <div id="input-dup-alert" class="suggestion-alert" style="margin-top:10px;"></div>

                <div style="margin-top:15px; font-size:0.8rem; color:#64748b; text-align:center;">ã‚¹ãƒãƒ¼ãƒˆå…¥åŠ›</div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:8px;">
                    <button class="btn-success" onclick="startFastMode(false)">ğŸš€ ã‚«ãƒ¡ãƒ©+éŸ³å£°</button>
                    <button class="btn-success" onclick="startFastMode(true)">ğŸ¤ éŸ³å£°(é€£ç¶š)</button>
                </div>
                
                <!-- AIã‚«ãƒ¡ãƒ© -->
                <div id="cam-ui" style="display:none; background:white; padding:15px; border-radius:16px; margin-top:15px; box-shadow:0 4px 10px rgba(0,0,0,0.1);">
                    <video id="cam-video" autoplay playsinline muted style="width:100%; border-radius:12px;"></video>
                    <div id="ai-hint" style="text-align:center; font-weight:bold; color:var(--primary); margin:10px 0;">è§£æä¸­...</div>
                    <div style="display:flex; gap:10px;">
                        <button class="btn-main" onclick="snapAI()">æ±ºå®š</button>
                        <button class="btn-sub" onclick="stopCam()">é–‰ã˜ã‚‹</button>
                    </div>
                </div>
            </div>

            <div style="display:flex; gap:10px; margin-top:25px;">
                <button class="btn-sub" onclick="closeBox()">é–‰ã˜ã‚‹</button>
                <button class="btn-danger" onclick="deleteBox()">ç®±ã‚’å‰Šé™¤</button>
            </div>
        </div>
    </div>

    <!-- 2. ä¸€è¦§ & æ¤œç´¢ -->
    <div id="view-list" class="view">
        <div class="card" style="background:#f0fdf4; border-color:#86efac;">
            <div class="card-head" style="color:#166534; border-color:#bbf7d0;">ğŸ§¹ ã“ã‚Œã©ã“ï¼Ÿæ¤œç´¢</div>
            <div style="display:flex; gap:10px;">
                <input type="text" id="suggest-input" placeholder="å“å (ä¾‹: ãƒã‚µãƒŸ)" style="margin:0; background:white;">
                <button class="btn-success" style="width:auto; margin:0;" onclick="findSuggestion()">æ¤œç´¢</button>
            </div>
            <div id="suggest-res" style="margin-top:15px; font-size:0.95rem; color:#14532d; line-height:1.6;"></div>
        </div>

        <div class="card">
            <div class="card-head">ğŸ“¦ ãƒœãƒƒã‚¯ã‚¹ä¸€è¦§</div>
            <input type="text" id="filter-input" placeholder="ğŸ” åå‰ã€å ´æ‰€ã€ã‚«ãƒ†ã‚´ãƒª..." onkeyup="renderList()">
            <div id="list-container"></div>
        </div>
    </div>

    <!-- 3. è¨­å®š -->
    <div id="view-settings" class="view">
        <div class="card" style="border:2px solid #f59e0b;">
            <div class="card-head" style="color:#b45309;">âš ï¸ ç®¡ç†ãƒ„ãƒ¼ãƒ«</div>
            <p style="font-size:0.9rem; color:#b45309; margin-bottom:15px;">
                å…¨ãƒœãƒƒã‚¯ã‚¹ã®ä¸­èº«ã‚’å†åˆ†æã—ã€ã‚«ãƒ†ã‚´ãƒªã‚’è‡ªå‹•è¨­å®šã—ç›´ã—ã¾ã™ã€‚<br>
                â€»å®Ÿè¡Œã«ã¯å³é‡ãªç¢ºèªãŒå¿…è¦ã§ã™ã€‚
            </p>
            <button class="btn-main" style="background:#f59e0b;" onclick="reCategorizeAll()">å…¨ãƒœãƒƒã‚¯ã‚¹è‡ªå‹•ã‚«ãƒ†ã‚´ãƒªæ•´ç†</button>
        </div>

        <div class="card">
            <div class="card-head">ğŸ–¨ï¸ QRä¸€æ‹¬å°åˆ·</div>
            <button class="btn-main" onclick="bulkPrint()">A4å°åˆ·ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ (8é¢)</button>
        </div>
        <div class="card">
            <div class="card-head">â˜ï¸ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</div>
            <button class="btn-sub" onclick="fetchData(true)">å¼·åˆ¶åŒæœŸ</button>
            <button class="btn-danger" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
    </div>
</div>

<!-- ãƒŠãƒ“ -->
<div class="nav">
    <div class="nav-item active" onclick="tab('scan')"><span class="nav-icon">ğŸ“·</span>ç·¨é›†</div>
    <div class="nav-item" onclick="tab('list')"><span class="nav-icon">ğŸ”</span>æ¤œç´¢</div>
    <div class="nav-item" onclick="tab('settings')"><span class="nav-icon">âš™ï¸</span>è¨­å®š</div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«: å¼•ã£è¶Šã— -->
<div id="move-modal" class="modal">
    <div class="modal-content">
        <h3>ğŸšš ã‚¢ã‚¤ãƒ†ãƒ ç§»å‹•</h3>
        <p id="move-info" style="margin-bottom:15px; font-weight:bold; color:var(--primary);"></p>
        <div id="move-list" style="max-height:300px; overflow-y:auto; border:1px solid var(--border); border-radius:12px; margin-bottom:15px;"></div>
        <button class="btn-sub" onclick="document.getElementById('move-modal').style.display='none'">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
</div>

<!-- é«˜é€Ÿãƒ¢ãƒ¼ãƒ‰UI -->
<div id="fast-mode-ui">
    <div style="flex:1; position:relative; overflow:hidden; display:flex; justify-content:center; align-items:center;">
        <video id="fast-video" autoplay playsinline muted></video>
        <div id="voice-icon" style="display:none; font-size:6rem; color:white;">ğŸ¤</div>
        <div class="scan-line" id="scan-line"></div>
    </div>
    <div class="fast-overlay">
        <div id="fast-log">å¾…æ©Ÿä¸­...</div>
        <button class="btn-sub" onclick="stopFastMode()">çµ‚äº†</button>
    </div>
</div>

<div id="print-area"></div>

<script>
    // â–¼â–¼â–¼ è¨­å®šã‚¨ãƒªã‚¢ â–¼â–¼â–¼
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyDZTbB-x1eftkFIET5f7NhWuZqM6gvV23G1zmuoCwpdKJ4FDY417qdtNufOe8l8o52QA/exec";
    // â–²â–²â–² â–²â–²â–² â–²â–²â–²

    let localDB = {}; 
    let currentBoxId = null;
    let qrScanner = null;
    let aiModel = null;
    let password = localStorage.getItem('sb_pass') || "";
    let moveTargetIdx = null;
    let suggestedBoxId = null;
    let targetHighlightItem = null;
    let audioCtx = null;

    // --- éŸ³å£° (Beep) æ©Ÿèƒ½ ---
    function initAudio() {
        const AC = window.AudioContext || window.webkitAudioContext;
        if (AC) audioCtx = new AC();
    }
    function beep() {
        if(!audioCtx) initAudio();
        if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
        
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        
        osc.type = 'sine';
        osc.frequency.setValueAtTime(880, audioCtx.currentTime); // 880Hz
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        
        osc.start();
        osc.stop(audioCtx.currentTime + 0.1); // 0.1ç§’é³´ã‚‰ã™
    }

    // å…¨ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã«éŸ³ã‚’é³´ã‚‰ã™è¨­å®š
    document.addEventListener('click', (e) => {
        if(e.target.tagName === 'BUTTON' || e.target.closest('button')) {
            beep();
        }
    });

    // æ‹¡å¼µè¾æ›¸
    const DICT = {
        "PCãƒ»ã‚¬ã‚¸ã‚§ãƒƒãƒˆ": ["PC","ãƒ‘ã‚½ã‚³ãƒ³","ãƒã‚¦ã‚¹","ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰","ãƒ¢ãƒ‹ã‚¿ãƒ¼","ã‚±ãƒ¼ãƒ–ãƒ«","USB","å……é›»å™¨","ã‚¹ãƒãƒ›","é›»æ± ","ã‚¤ãƒ¤ãƒ›ãƒ³","HDD","SSD","SD","ãƒã‚¤ã‚¯","ãƒ«ãƒ¼ã‚¿ãƒ¼","ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ","iPad","Apple"],
        "è¡£é¡ãƒ»ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³": ["æœ","ã‚·ãƒ£ãƒ„","ã‚ºãƒœãƒ³","ãƒ‘ãƒ³ãƒ„","ã‚¹ã‚«ãƒ¼ãƒˆ","ä¸‹ç€","é´ä¸‹","ã‚³ãƒ¼ãƒˆ","ã‚¸ãƒ£ã‚±ãƒƒãƒˆ","å¸½å­","ãƒãƒ•ãƒ©ãƒ¼","ãƒ™ãƒ«ãƒˆ","æ‰‹è¢‹","ã‚¹ãƒ¼ãƒ„","ãƒã‚¯ã‚¿ã‚¤","é„","ãƒãƒƒã‚°","é´","ãƒ–ãƒ¼ãƒ„","ã‚µãƒ³ãƒ€ãƒ«","ãƒ‘ã‚¸ãƒ£ãƒ"],
        "æ–‡æˆ¿å…·": ["ãƒšãƒ³","é‰›ç­†","æ¶ˆã—ã‚´ãƒ ","å®šè¦","ãƒã‚µãƒŸ","ã‚«ãƒƒã‚¿ãƒ¼","ã®ã‚Š","ãƒ†ãƒ¼ãƒ—","ãƒ›ãƒƒãƒã‚­ã‚¹","ä»˜ç®‹","ãƒãƒ¼ãƒˆ","ãƒ¡ãƒ¢","ãƒ•ã‚¡ã‚¤ãƒ«","é›»å“","ç­†ç®±"],
        "æ—¥ç”¨å“": ["ãƒ†ã‚£ãƒƒã‚·ãƒ¥","æ´—å‰¤","ã‚·ãƒ£ãƒ³ãƒ—ãƒ¼","çŸ³é¹¸","æ­¯ãƒ–ãƒ©ã‚·","ãƒã‚¹ã‚¯","è–¬","æƒé™¤","ã‚´ãƒŸè¢‹","ã‚¹ãƒãƒ³ã‚¸","ãƒãƒ³ã‚¬ãƒ¼","ã‚«ã‚¤ãƒ­","æŸ”è»Ÿå‰¤","èŠ³é¦™å‰¤","é›»æ± "],
        "ã‚­ãƒƒãƒãƒ³": ["é‹","ãƒ•ãƒ©ã‚¤ãƒ‘ãƒ³","çš¿","ã‚³ãƒƒãƒ—","ç®¸","ã‚¹ãƒ—ãƒ¼ãƒ³","ãƒ•ã‚©ãƒ¼ã‚¯","ãƒ©ãƒƒãƒ—","ã‚¢ãƒ«ãƒŸãƒ›ã‚¤ãƒ«","é£Ÿå“","èª¿å‘³æ–™","æ°´ç­’","å¼å½“ç®±","ä¿å­˜å®¹å™¨","ãƒœã‚¦ãƒ«"],
        "å·¥å…·ãƒ»DIY": ["ãƒ‰ãƒ©ã‚¤ãƒãƒ¼","ãƒ¬ãƒ³ãƒ","ãƒã‚¸","ã‚¬ãƒ ãƒ†ãƒ¼ãƒ—","è»æ‰‹","ç´","æ¥ç€å‰¤","ãƒ¡ã‚¸ãƒ£ãƒ¼","ãƒ‰ãƒªãƒ«","ãƒšãƒ³ãƒ"],
        "è¶£å‘³ãƒ»ãŠã‚‚ã¡ã‚ƒ": ["ã‚²ãƒ¼ãƒ ","ã‚¹ã‚¤ãƒƒãƒ","PS5","ãƒ•ã‚£ã‚®ãƒ¥ã‚¢","ãƒ—ãƒ©ãƒ¢","ã¬ã„ãã‚‹ã¿","æœ¬","æ¼«ç”»","CD","DVD","ã‚«ãƒ¡ãƒ©","æ¥½å™¨","æ¥½è­œ","ã‚°ãƒƒã‚º"],
        "ã‚¢ã‚¦ãƒˆãƒ‰ã‚¢": ["ãƒ†ãƒ³ãƒˆ","å¯è¢‹","ãƒ©ãƒ³ã‚¿ãƒ³","æ¤…å­","ãƒªãƒ¥ãƒƒã‚¯","é›¨å…·","è‡ªè»¢è»Š","é‡£ã‚Š","ã‚¯ãƒ¼ãƒ©ãƒ¼ãƒœãƒƒã‚¯ã‚¹","å¯è¢‹"],
        "å­£ç¯€ç”¨å“": ["æ‰‡é¢¨æ©Ÿ","ãƒ’ãƒ¼ã‚¿ãƒ¼","ã‚¹ãƒˆãƒ¼ãƒ–","ã“ãŸã¤","åŠ æ¹¿å™¨","ã‚¯ãƒªã‚¹ãƒã‚¹","æ­£æœˆ","ãƒ—ãƒ¼ãƒ«","æµ®ãè¼ª"],
        "æ›¸é¡": ["å¥‘ç´„æ›¸","é€šå¸³","å°é‘‘","ãƒ‘ã‚¹ãƒãƒ¼ãƒˆ","å¹´é‡‘","ä¿é™º","è¨¼æ›¸","èª¬æ˜æ›¸"]
    };

    window.onload = () => {
        initAudio();
        if(password) {
            document.getElementById('login-overlay').style.display='none';
            fetchData();
        }
        renderList();
        document.getElementById('inp-name').addEventListener('input', checkInputDuplicate);
    };

    function login() {
        const p = document.getElementById('login-pass').value;
        document.getElementById('login-msg').innerText = "èªè¨¼ä¸­...";
        fetch(`${GAS_URL}?password=${p}`)
        .then(r => r.json())
        .then(d => {
            if(d.error) {
                document.getElementById('login-msg').innerText = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™";
            } else {
                password = p;
                localStorage.setItem('sb_pass', p);
                document.getElementById('login-overlay').style.opacity = 0;
                setTimeout(()=>document.getElementById('login-overlay').style.display='none', 300);
                localDB = d;
                renderList();
            }
        }).catch(e => document.getElementById('login-msg').innerText = "é€šä¿¡ã‚¨ãƒ©ãƒ¼");
    }
    function logout() { localStorage.removeItem('sb_pass'); location.reload(); }

    async function fetchData(force=false) {
        document.getElementById('sync-status').innerText = "Syncing...";
        try {
            const res = await fetch(`${GAS_URL}?password=${password}`);
            const json = await res.json();
            if(json.error) { alert("èªè¨¼ã‚¨ãƒ©ãƒ¼"); logout(); return; }
            localDB = json;
            document.getElementById('sync-status').innerText = "Ready";
            if(force) { alert("åŒæœŸå®Œäº†"); renderList(); }
        } catch(e){ document.getElementById('sync-status').innerText = "Error"; }
    }
    async function pushData(payload) {
        document.getElementById('sync-status').innerText = "Saving...";
        payload.password = password;
        try {
            await fetch(GAS_URL, { method:'POST', headers:{ "Content-Type":"text/plain" }, body:JSON.stringify(payload) });
            document.getElementById('sync-status').innerText = "Saved";
        } catch(e){ document.getElementById('sync-status').innerText = "Save Error"; }
    }

    // --- UIåˆ¶å¾¡ ---
    function tab(t) {
        document.querySelectorAll('.view').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
        document.getElementById('view-'+t).classList.add('active');
        document.querySelectorAll('.nav-item')[['scan','list','settings'].indexOf(t)].classList.add('active');
        if(t==='scan') setTimeout(startQR,300); else stopQR();
        if(t==='list') renderList();
    }

    function startQR() {
        if(currentBoxId || qrScanner) return;
        const r = document.getElementById("reader");
        if(r && r.offsetParent!==null) {
            const sc = new Html5Qrcode("reader");
            sc.start({facingMode:"environment"},{fps:10,qrbox:250},(t)=>{
                beep(); // QRèª­ã¿å–ã‚Šæ™‚ã‚‚é³´ã‚‰ã™
                openBox(t);
            })
            .then(()=>{qrScanner=sc}).catch(()=>{setTimeout(startQR,500)});
        }
    }
    function stopQR() { if(qrScanner) qrScanner.stop().then(()=>{qrScanner.clear();qrScanner=null}).catch(()=>{qrScanner=null}); }

    function openBox(id) {
        stopQR();
        currentBoxId = id;
        document.getElementById('scan-ui').style.display='none';
        document.getElementById('box-ui').style.display='block';
        if(!localDB[id]) localDB[id] = { loc:"", items:[], category:"æœªåˆ†é¡", updated: new Date() };
        renderBoxUI();
    }
    
    function closeBox() { 
        currentBoxId=null; 
        targetHighlightItem=null; 
        document.getElementById('box-ui').style.display='none'; 
        document.getElementById('scan-ui').style.display='block'; 
        setTimeout(startQR,300); 
    }

    function jumpToBox(boxId, itemName) {
        document.getElementById('box-ui').style.display='none';
        targetHighlightItem = itemName;
        openBox(boxId);
    }

    function renderBoxUI() {
        const d = localDB[currentBoxId];
        document.getElementById('disp-id').innerText = currentBoxId;
        document.getElementById('disp-cat').innerText = d.category || "æœªåˆ†é¡";
        document.getElementById('inp-loc').value = d.loc;

        const diff = (new Date() - new Date(d.updated)) / (1000*60*60*24);
        if(diff > 365) document.getElementById('disp-alert').classList.add('show');
        else document.getElementById('disp-alert').classList.remove('show');

        checkExistingDuplicates(d.items);

        const list = document.getElementById('item-list-container');
        list.innerHTML = "";
        
        d.items.forEach((item, i) => {
            const row = document.createElement('div');
            row.className = "item-row";
            const tags = (item.t||[]).map(t=>`<span class="tag">${t}</span>`).join("");
            
            if(targetHighlightItem && item.n === targetHighlightItem) {
                row.classList.add('highlight-target');
                setTimeout(() => row.scrollIntoView({behavior: "smooth", block: "center"}), 300);
                targetHighlightItem = null;
            }

            row.innerHTML = `
                <div class="item-content">
                    <span class="item-name">${item.n}</span> ${tags}
                </div>
                <div class="item-actions">
                    <button class="btn-sm btn-sub" onclick="openMoveModal(${i})">ç§»å‹•</button>
                    <button class="btn-sm btn-danger" onclick="delItem(${i})">å‰Šé™¤</button>
                </div>`;
            list.appendChild(row);
        });
    }

    function checkExistingDuplicates(items) {
        const alertBox = document.getElementById('existing-dup-alert');
        alertBox.style.display = 'none';
        alertBox.innerHTML = "";
        if(!items || items.length === 0) return;

        let foundDupes = [];
        for(let item of items) {
            for(let bid of Object.keys(localDB)) {
                if(bid === currentBoxId) continue;
                if(localDB[bid].items.some(i => i.n.includes(item.n) || item.n.includes(i.n))) {
                    foundDupes.push(`ğŸ’¡ <span class="jump-link" onclick="jumpToBox('${bid}', '${item.n}')">${bid}</span> ã«ã‚‚ã€${item.n}ã€ãŒã‚ã‚Šã¾ã™`);
                    if(foundDupes.length >= 3) break;
                }
            }
            if(foundDupes.length >= 3) break;
        }

        if(foundDupes.length > 0) {
            alertBox.innerHTML = foundDupes.join("<br>");
            alertBox.style.display = 'block';
        }
    }

    function checkInputDuplicate() {
        const val = document.getElementById('inp-name').value.trim();
        const alertDiv = document.getElementById('input-dup-alert');
        if(val.length < 2) { alertDiv.style.display='none'; return; }
        
        suggestedBoxId = null;
        let foundName = "";
        
        Object.keys(localDB).forEach(bid => {
            if(bid === currentBoxId) return;
            const match = localDB[bid].items.find(i => i.n.includes(val) || val.includes(i.n));
            if(match) { suggestedBoxId = bid; foundName = match.n; }
        });

        if(suggestedBoxId) {
            const cat = localDB[suggestedBoxId].category;
            alertDiv.innerHTML = `ğŸ’¡ <b>${suggestedBoxId}</b> (${cat}) ã«ä¼¼ãŸç‰©ã€Œ${foundName}ã€ãŒã‚ã‚Šã¾ã™ã€‚<br><u style="cursor:pointer" onclick="jumpToBox('${suggestedBoxId}', '${foundName}')">ãã“ã¸ç§»å‹•ã—ã¦ç¢ºèª</u>`;
            alertDiv.style.display='block';
        } else {
            alertDiv.style.display='none';
        }
    }

    function autoCategorize(items) {
        let scores = {};
        items.forEach(itm => {
            const txt = itm.n + (itm.t||[]).join("");
            Object.keys(DICT).forEach(cat => {
                if(DICT[cat].some(w => txt.includes(w))) scores[cat] = (scores[cat]||0)+1;
            });
        });
        let max = 0, best = "æœªåˆ†é¡";
        Object.keys(scores).forEach(c => { if(scores[c]>max){max=scores[c]; best=c;} });
        if(best === "æœªåˆ†é¡" && localDB[currentBoxId].category !== "æœªåˆ†é¡") return localDB[currentBoxId].category;
        return best;
    }

    function reCategorizeAll() {
        if(!confirm("âš ï¸ ã€è­¦å‘Šã€‘\nå…¨ãƒœãƒƒã‚¯ã‚¹ã®ã‚«ãƒ†ã‚´ãƒªã‚’è‡ªå‹•å†è¨­å®šã—ã¾ã™ã€‚\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
        if(!confirm("æœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ\nå–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚")) return;
        const u = prompt("å®Ÿè¡Œã™ã‚‹ã«ã¯ã€Œæ•´ç†ã€ã¨å…¥åŠ›");
        if(u !== "æ•´ç†") { alert("ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ"); return; }
        
        let count = 0;
        Object.keys(localDB).forEach(bid => {
            const box = localDB[bid];
            const newCat = autoCategorize(box.items);
            if(newCat !== "æœªåˆ†é¡" && newCat !== box.category) {
                box.category = newCat;
                pushData({ action:'save', boxId:bid, location:box.loc, items:box.items, category:box.category });
                count++;
            }
        });
        alert(`${count}å€‹ã®ãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°ã—ã¾ã—ãŸ`);
    }

    function addItem() {
        const val = document.getElementById('inp-name').value.trim();
        if(!val) return;
        const tags = val.match(/#[^\s]+/g) || [];
        const name = val.replace(/#[^\s]+/g, "").trim();
        
        localDB[currentBoxId].items.push({ n:name, c:1, t:tags });
        document.getElementById('inp-name').value = "";
        document.getElementById('input-dup-alert').style.display='none';
        localDB[currentBoxId].category = autoCategorize(localDB[currentBoxId].items);
        saveBox(); renderBoxUI();
    }
    function delItem(i) {
        if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            localDB[currentBoxId].items.splice(i, 1);
            saveBox(); renderBoxUI();
        }
    }
    async function deleteBox() {
        if(!confirm("ç®±ã”ã¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        delete localDB[currentBoxId];
        await pushData({ action:'delete', boxId:currentBoxId });
        alert("å‰Šé™¤ã—ã¾ã—ãŸ"); closeBox();
    }
    function saveBox() {
        const d = localDB[currentBoxId];
        d.loc = document.getElementById('inp-loc').value;
        d.updated = new Date();
        pushData({ action:'save', boxId:currentBoxId, location:d.loc, items:d.items, category:d.category });
    }

    function openMoveModal(i) {
        moveTargetIdx = i;
        const itm = localDB[currentBoxId].items[i];
        document.getElementById('move-info').innerText = `ã€Œ${itm.n}ã€ã‚’ç§»å‹•`;
        const list = document.getElementById('move-list'); list.innerHTML="";
        Object.keys(localDB).forEach(bid => {
            if(bid === currentBoxId) return;
            const b = localDB[bid];
            const div = document.createElement('div');
            div.style.padding="12px"; div.style.borderBottom="1px solid #f1f5f9"; div.style.cursor="pointer";
            div.innerHTML = `<b>${bid}</b> <span class="box-cat">${b.category}</span> <span style="font-size:0.8rem;color:#666">@${b.loc}</span>`;
            div.onclick = () => {
                localDB[bid].items.push(itm);
                localDB[currentBoxId].items.splice(moveTargetIdx,1);
                const d1 = localDB[currentBoxId];
                pushData({ action:'save', boxId:currentBoxId, location:d1.loc, items:d1.items, category:d1.category });
                const d2 = localDB[bid];
                pushData({ action:'save', boxId:bid, location:d2.loc, items:d2.items, category:d2.category });
                alert(`ç§»å‹•ã—ã¾ã—ãŸ`); document.getElementById('move-modal').style.display='none'; renderBoxUI();
            };
            list.appendChild(div);
        });
        document.getElementById('move-modal').style.display='flex';
    }

    function findSuggestion() {
        const key = document.getElementById('suggest-input').value.trim().toLowerCase();
        const res = document.getElementById('suggest-res');
        if(!key) return;
        let hits = [];
        let words = [key];
        Object.keys(DICT).forEach(c => { if(DICT[c].some(w=>w.includes(key))) words=words.concat(DICT[c]); });

        Object.keys(localDB).forEach(id => {
            const b = localDB[id];
            let score = 0;
            const content = b.items.map(i=>i.n.toLowerCase()).join(" ");
            words.forEach(w => {
                if(content.includes(w)) score += 10;
                if(b.category.includes(w)) score += 5;
            });
            if(b.items.some(i => i.n.toLowerCase().includes(key))) score += 20;
            if(score>0) hits.push({id, loc:b.loc, cat:b.category, score});
        });
        
        hits.sort((a,b)=>b.score-a.score);
        if(hits.length>0) {
            res.innerHTML = "<b>ğŸ’¡ ãŠã™ã™ã‚:</b><br>" + hits.slice(0,3).map(h=>
                `ãƒ»<u onclick="jumpToBox('${h.id}', '')" style="cursor:pointer;color:var(--primary);font-weight:bold;">${h.id}</u> (${h.cat}) @${h.loc}`
            ).join("<br>");
        } else {
            res.innerHTML = "è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚";
        }
    }

    function renderList() {
        const key = document.getElementById('filter-input').value.toLowerCase();
        const c = document.getElementById('list-container'); c.innerHTML="";
        
        let words = [key];
        if(key) Object.keys(DICT).forEach(cat => { if(cat.includes(key)||DICT[cat].some(w=>w.includes(key))) words=words.concat(DICT[cat]); });

        Object.keys(localDB).forEach(id => {
            const d = localDB[id];
            const txt = `${id} ${d.loc} ${d.category} ${d.items.map(i=>i.n).join(" ")}`.toLowerCase();
            let match = !key;
            if(key) for(let w of words) if(txt.includes(w)) match=true;

            if(match) {
                const div = document.createElement('div');
                div.className = "box-row";
                
                let prevItems = d.items.slice(0,3).map(i => {
                    let name = i.n;
                    if(key) {
                        for(let w of words) {
                            if(name.toLowerCase().includes(w) && w.length > 0) {
                                const regex = new RegExp(`(${w})`, 'gi');
                                name = name.replace(regex, '<span class="hl">$1</span>');
                                break; 
                            }
                        }
                    }
                    return name;
                });
                const prev = prevItems.join(", ") + (d.items.length>3?"...":"");

                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between;">
                        <div class="box-info-top">
                            <span class="box-id">${id}</span>
                            <span class="box-cat">${d.category}</span>
                        </div>
                        <div style="font-size:0.8rem; color:#64748b;">@${d.loc}</div>
                    </div>
                    <div style="font-size:0.85rem; color:#334155; margin-top:5px; line-height:1.4;">${prev}</div>
                `;
                div.onclick=()=>{ tab('scan'); openBox(id); };
                c.appendChild(div);
            }
        });
    }

    // --- é«˜é€Ÿãƒ¢ãƒ¼ãƒ‰ ---
    let aiStream=null, recognition=null;
    let isVoiceOnly=false, lastSpoken="";

    async function startFastMode(voiceOnly) {
        isVoiceOnly = voiceOnly;
        if(!voiceOnly && !aiModel) aiModel = await mobilenet.load();
        document.getElementById('fast-mode-ui').style.display='flex';
        const v = document.getElementById('fast-video');
        const ico = document.getElementById('voice-icon');
        
        if(voiceOnly) {
            v.style.display='none'; document.getElementById('scan-line').style.display='none'; ico.style.display='block';
            document.getElementById('fast-log').innerText = "éŸ³å£°å…¥åŠ›ä¸­...";
        } else {
            v.style.display='block'; document.getElementById('scan-line').style.display='block'; ico.style.display='none';
            try {
                aiStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
                v.srcObject = aiStream;
                loopAI();
            } catch(e){}
        }

        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(SR) {
            recognition = new SR();
            recognition.lang = 'ja-JP'; recognition.continuous = true; recognition.interimResults = false;
            recognition.onend = () => { if(document.getElementById('fast-mode-ui').style.display==='flex') try{recognition.start()}catch(e){} };
            recognition.onresult = (e) => {
                const t = e.results[e.results.length-1][0].transcript.trim();
                handleFastInput(t, false);
            };
            try{recognition.start()}catch(e){}
        }
    }

    async function loopAI() {
        if(document.getElementById('fast-mode-ui').style.display==='none' || isVoiceOnly) return;
        const v = document.getElementById('fast-video');
        if(v.readyState===4) {
            if(Math.random() < 0.05) {
                const p = await aiModel.classify(v);
                if(p.length>0 && p[0].probability>0.65) {
                    const ja = await translate(p[0].className);
                    handleFastInput(ja, true);
                }
            }
        }
        if(aiStream) requestAnimationFrame(loopAI);
    }
    async function translate(t) {
        try {
            const r = await fetch(`${GAS_URL}?action=translate&text=${t}&password=${password}`);
            const j = await r.json(); return j.translated;
        } catch(e){return t;}
    }

    function handleFastInput(t, isAI) {
        if(t==="çµ‚äº†") { stopFastMode(); return; }
        if(t===lastSpoken) return; 
        lastSpoken = t;
        localDB[currentBoxId].items.push({n:t, c:1, t:[]});
        document.getElementById('fast-log').innerText = `ç™»éŒ²: ${t}`;
        localDB[currentBoxId].category = autoCategorize(localDB[currentBoxId].items);
        beep();
    }

    function stopFastMode() {
        if(aiStream) aiStream.getTracks().forEach(t=>t.stop());
        if(recognition) recognition.stop();
        aiStream=null; recognition=null;
        document.getElementById('fast-mode-ui').style.display='none';
        saveBox(); renderBoxUI();
    }

    // --- å°åˆ· ---
    function printQR() {
        const a=document.getElementById('print-area'); a.style.display='flex'; a.className='mode-single';
        a.innerHTML=`<div class="print-card"><div class="print-id">${currentBoxId}</div><div id="pq"></div></div>`;
        new QRCode(document.getElementById("pq"),{text:currentBoxId,width:256,height:256});
        setTimeout(()=>{window.print();a.style.display='none'},500);
    }
    function bulkPrint() {
        const a=document.getElementById('print-area'); a.style.display='grid'; a.className='mode-bulk';
        a.innerHTML="";
        for(let i=0; i<8; i++) {
            let id='BOX-'+Math.floor(1000+Math.random()*9000);
            while(localDB[id]) id='BOX-'+Math.floor(1000+Math.random()*9000);
            const d=document.createElement('div'); d.className='print-card';
            d.innerHTML=`<div class="print-id">${id}</div><div id="pq${i}"></div>`;
            a.appendChild(d);
            new QRCode(document.getElementById(`pq${i}`),{text:id,width:128,height:128});
        }
        setTimeout(()=>{window.print();a.style.display='none'},500);
    }
</script>
</body>
</html>
