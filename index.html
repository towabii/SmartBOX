<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Box Cloud</title>
    <!-- QRã‚³ãƒ¼ãƒ‰é–¢é€£ -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- AIç”»åƒèªè­˜ -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@latest"></script>

    <style>
        :root { --primary: #007bff; --bg: #f4f7f6; }
        body { font-family: sans-serif; margin: 0; padding: 0; background: var(--bg); padding-bottom: 80px; }
        
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 2000; display: flex; justify-content: center; align-items: center; flex-direction: column; display: none; }
        .spinner { width: 40px; height: 40px; border: 4px solid #ddd; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        header { background: var(--primary); color: white; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 100; }
        h1 { margin: 0; font-size: 1.2rem; }
        .container { max-width: 600px; margin: 0 auto; padding: 15px; }
        
        .card { background: white; border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        input, button { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        input { border: 1px solid #ddd; background: #fafafa; }
        button { border: none; background: var(--primary); color: white; cursor: pointer; }
        button.secondary { background: #6c757d; }
        button.danger { background: #dc3545; width: auto; padding: 5px 10px; font-size: 0.8rem; margin: 0; }
        button.ai-btn { background: #28a745; display: flex; justify-content: center; gap: 8px; }

        /* ãƒªã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ« */
        .box-header { display: flex; justify-content: space-between; border-bottom: 2px solid #eee; padding-bottom: 8px; margin-bottom: 10px; }
        .box-id { font-weight: bold; color: var(--primary); font-size: 1.2rem; }
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; }
        .item-num { background: #eee; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 0.8rem; margin-right: 8px; }

        /* ã‚«ãƒ¡ãƒ© */
        #reader { width: 100%; background: #000; border-radius: 8px; overflow: hidden; }
        #ai-video { width: 100%; border-radius: 8px; display: none; }

        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #ddd; display: flex; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { flex: 1; text-align: center; padding: 10px 0; color: #888; font-size: 0.8rem; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-icon { font-size: 1.5rem; display: block; margin-bottom: 2px; }

        .view { display: none; }
        .view.active { display: block; }
    </style>
</head>
<body>

<!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
<div id="loading-overlay">
    <div class="spinner"></div>
    <p id="loading-text">é€šä¿¡ä¸­...</p>
</div>

<header>
    <h1>â˜ï¸ Smart Box Cloud</h1>
</header>

<div class="container">

    <!-- 1. ã‚¹ã‚­ãƒ£ãƒ³ç”»é¢ -->
    <div id="view-scan" class="view active">
        <div id="scan-ui" class="card">
            <h3 style="text-align:center; margin-top:0;">QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³</h3>
            <div id="reader"></div>
            <p style="text-align:center; color:#666; font-size:0.8rem;">ç®±ã®QRã‚³ãƒ¼ãƒ‰ã‚’å†™ã—ã¦ãã ã•ã„</p>
        </div>

        <div id="box-ui" class="card" style="display:none;">
            <div class="box-header">
                <span class="box-id" id="disp-id">BOX-ID</span>
                <span style="font-size:0.9rem; background:#eee; padding:4px 8px; border-radius:10px;">åˆè¨ˆ: <span id="disp-count">0</span>ç‚¹</span>
            </div>
            
            <input type="text" id="inp-loc" placeholder="ä¿ç®¡å ´æ‰€ (ä¾‹: ã‚¯ãƒ­ãƒ¼ã‚¼ãƒƒãƒˆ)" onchange="saveBoxData()">
            
            <div id="item-list" style="max-height:300px; overflow-y:auto; margin-bottom:15px;"></div>

            <div style="border-top:2px dashed #ddd; padding-top:15px;">
                <h4 style="margin:0 0 10px 0;">è¿½åŠ ã™ã‚‹</h4>
                
                <!-- AIã‚«ãƒ¡ãƒ©ã‚¨ãƒªã‚¢ -->
                <video id="ai-video" autoplay playsinline muted></video>
                <div id="ai-msg" style="text-align:center; font-size:0.8rem; color:#28a745; display:none;"></div>
                
                <button id="btn-ai-start" class="ai-btn" onclick="startAICamera()">
                    <span>ğŸ¤– AIã§è‡ªå‹•å…¥åŠ› (ç¿»è¨³ä»˜)</span>
                </button>
                <button id="btn-ai-snap" class="ai-btn" style="display:none; background:#ff9800;" onclick="identifyItem()">
                    <span>ğŸ“¸ èªè­˜ & ç¿»è¨³ï¼</span>
                </button>

                <div style="display:flex; gap:5px;">
                    <input type="text" id="inp-item" placeholder="å“å">
                    <button onclick="addItem()" style="width:80px;">è¿½åŠ </button>
                </div>
            </div>
            <button class="secondary" onclick="closeBox()">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <!-- 2. æ¤œç´¢ç”»é¢ -->
    <div id="view-search" class="view">
        <div class="card">
            <input type="text" id="search-key" placeholder="ğŸ” ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢..." onkeyup="renderSearchResults()">
            <div id="search-res"></div>
        </div>
    </div>

    <!-- 3. QRä½œæˆ -->
    <div id="view-settings" class="view">
        <div class="card">
            <h3>QRã‚³ãƒ¼ãƒ‰ä½œæˆ</h3>
            <input type="text" id="new-id" readonly>
            <div id="qrcode-display" style="display:flex; justify-content:center; margin:15px;"></div>
            <button onclick="createQR()">IDç™ºè¡Œ</button>
        </div>
        <div class="card">
            <p>â€»ãƒ‡ãƒ¼ã‚¿ã¯Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>
            <button class="secondary" onclick="fetchAllData(true)">å¼·åˆ¶ãƒ‡ãƒ¼ã‚¿æ›´æ–°</button>
        </div>
    </div>
</div>

<div class="nav">
    <div class="nav-item active" onclick="switchTab('scan')"><span class="nav-icon">ğŸ“·</span>ã‚¹ã‚­ãƒ£ãƒ³</div>
    <div class="nav-item" onclick="switchTab('search')"><span class="nav-icon">ğŸ”</span>æ¤œç´¢</div>
    <div class="nav-item" onclick="switchTab('settings')"><span class="nav-icon">âš™ï¸</span>è¨­å®š</div>
</div>

<script>
    // ==========================================
    // â–¼ ã“ã“ã«GASã®Webã‚¢ãƒ—ãƒªURLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ â–¼
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwXbL-a1Ec02n1C2Qt8loQO6g_BsNh2n1cFk9LETBazpk7_m2KRKrOUGbS-ZbiAvb8XNA/exec"; 
    // ==========================================

    let localDB = {}; // ãƒ‡ãƒ¼ã‚¿ã®ä¸€æ™‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    let currentBoxId = null;
    let html5QrcodeScanner = null;
    let aiModel = null;
    let aiStream = null;

    // --- åˆæœŸåŒ– ---
    window.onload = function() {
        if(GAS_API_URL === "ã“ã“ã«URLã‚’è²¼ã‚Šä»˜ã‘") {
            alert("ã‚³ãƒ¼ãƒ‰å†…ã®GAS_API_URLã«ç™ºè¡Œã•ã‚ŒãŸURLã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼");
        } else {
            fetchAllData(); // èµ·å‹•æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        }
        createQR();
    };

    // --- é€šä¿¡é–¢é€£ ---
    function showLoading(msg) {
        document.getElementById('loading-text').innerText = msg;
        document.getElementById('loading-overlay').style.display = 'flex';
    }
    function hideLoading() {
        document.getElementById('loading-overlay').style.display = 'none';
    }

    async function fetchAllData(force = false) {
        if(force) showLoading("ãƒ‡ãƒ¼ã‚¿åŒæœŸä¸­...");
        try {
            const res = await fetch(GAS_API_URL);
            localDB = await res.json();
            if(force) {
                alert("ãƒ‡ãƒ¼ã‚¿ã‚’æœ€æ–°ã«ã—ã¾ã—ãŸ");
                renderSearchResults();
            }
        } catch(e) {
            console.error(e);
            if(force) alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
        } finally {
            if(force) hideLoading();
        }
    }

    async function pushBoxData(id, loc, items) {
        showLoading("ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ä¸­...");
        // å…ˆã«ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°ã—ã¦è¡¨ç¤ºã‚’é€Ÿãã™ã‚‹
        localDB[id] = { loc: loc, items: items };
        
        try {
            const payload = { boxId: id, location: loc, items: items };
            await fetch(GAS_API_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            });
        } catch(e) {
            alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        } finally {
            hideLoading();
        }
    }

    // AIç¿»è¨³ç”¨
    async function translateText(text) {
        showLoading("AIãŒç¿»è¨³ä¸­...");
        try {
            // GASçµŒç”±ã§ç¿»è¨³
            const url = `${GAS_API_URL}?action=translate&text=${encodeURIComponent(text)}`;
            const res = await fetch(url);
            const json = await res.json();
            return json.translated || text;
        } catch(e) {
            return text; // å¤±æ•—ã—ãŸã‚‰è‹±èªã®ã¾ã¾è¿”ã™
        } finally {
            hideLoading();
        }
    }

    // --- UIæ“ä½œ ---
    function switchTab(tab) {
        document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        document.getElementById('view-' + tab).classList.add('active');
        
        const tabs = ['scan', 'search', 'settings'];
        document.querySelectorAll('.nav-item')[tabs.indexOf(tab)].classList.add('active');

        if(tab === 'scan') startScanner(); else stopScanner();
        if(tab === 'search') renderSearchResults();
    }

    // --- QRã‚¹ã‚­ãƒ£ãƒ³ ---
    function startScanner() {
        if(currentBoxId) return;
        if(!html5QrcodeScanner) {
            html5QrcodeScanner = new Html5Qrcode("reader");
            html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
            (decodedText) => {
                openBox(decodedText);
            }).catch(e=>{});
        }
    }
    function stopScanner() {
        if(html5QrcodeScanner) {
            html5QrcodeScanner.stop().then(() => { html5QrcodeScanner.clear(); html5QrcodeScanner = null; }).catch(e=>{});
        }
    }

    // --- ç®±ã‚’é–‹ã ---
    function openBox(id) {
        stopScanner();
        currentBoxId = id;
        document.getElementById('scan-ui').style.display = 'none';
        document.getElementById('box-ui').style.display = 'block';

        const data = localDB[id] || { loc: "", items: [] };
        document.getElementById('disp-id').innerText = id;
        document.getElementById('inp-loc').value = data.loc;
        renderItems(data.items);
    }

    function renderItems(items) {
        const list = document.getElementById('item-list');
        document.getElementById('disp-count').innerText = items.length;
        list.innerHTML = "";
        
        items.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = 'item-row';
            div.innerHTML = `
                <div><span class="item-num">#${idx+1}</span> ${item}</div>
                <button class="danger" onclick="deleteItem(${idx})">å‰Šé™¤</button>
            `;
            list.appendChild(div);
        });
    }

    function addItem(nameOverride = null) {
        const inp = document.getElementById('inp-item');
        const val = nameOverride || inp.value.trim();
        if(!val) return;

        const data = localDB[currentBoxId] || { loc: "", items: [] };
        // å ´æ‰€å…¥åŠ›æ¬„ã®å€¤ã‚‚å–å¾—
        const loc = document.getElementById('inp-loc').value;
        
        data.items.push(val);
        pushBoxData(currentBoxId, loc, data.items);
        
        inp.value = "";
        renderItems(data.items);
    }

    function deleteItem(idx) {
        if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        const data = localDB[currentBoxId];
        const loc = document.getElementById('inp-loc').value;
        data.items.splice(idx, 1);
        pushBoxData(currentBoxId, loc, data.items);
        renderItems(data.items);
    }

    function saveBoxData() {
        if(!currentBoxId) return;
        const loc = document.getElementById('inp-loc').value;
        const data = localDB[currentBoxId] || { loc: "", items: [] };
        pushBoxData(currentBoxId, loc, data.items);
    }

    function closeBox() {
        stopAICamera();
        currentBoxId = null;
        document.getElementById('box-ui').style.display = 'none';
        document.getElementById('scan-ui').style.display = 'block';
        startScanner();
    }

    // --- AIèªè­˜ã¨è‡ªå‹•ç¿»è¨³ ---
    async function startAICamera() {
        document.getElementById('btn-ai-start').style.display = 'none';
        document.getElementById('ai-msg').style.display = 'block';
        document.getElementById('ai-msg').innerText = "ãƒ¢ãƒ‡ãƒ«èª­è¾¼ä¸­...";
        
        if(!aiModel) aiModel = await mobilenet.load();
        
        document.getElementById('ai-msg').innerText = "ã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­...";
        const video = document.getElementById('ai-video');
        video.style.display = 'block';

        try {
            aiStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            video.srcObject = aiStream;
            document.getElementById('btn-ai-snap').style.display = 'flex';
            document.getElementById('ai-msg').style.display = 'none';
        } catch(e) {
            alert("ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼");
        }
    }

    async function identifyItem() {
        const video = document.getElementById('ai-video');
        const predictions = await aiModel.classify(video);
        
        if(predictions && predictions.length > 0) {
            const englishName = predictions[0].className;
            // ã“ã“ã§ç¿»è¨³ã‚’å®Ÿè¡Œ
            const japaneseName = await translateText(englishName);
            
            // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã®å ´åˆã€å…ˆé ­ã ã‘å–ã‚‹ï¼ˆä¾‹: "mouse, computer mouse" -> "ãƒã‚¦ã‚¹"ï¼‰
            const simpleName = japaneseName.split('ã€')[0].split(',')[0];
            
            document.getElementById('inp-item').value = simpleName;
            alert(`ã€Œ${simpleName}ã€(${englishName}) ã‚’èªè­˜ã—ã¾ã—ãŸ`);
        }
        stopAICamera();
    }

    function stopAICamera() {
        if(aiStream) aiStream.getTracks().forEach(t => t.stop());
        document.getElementById('ai-video').style.display = 'none';
        document.getElementById('btn-ai-snap').style.display = 'none';
        document.getElementById('btn-ai-start').style.display = 'flex';
    }

    // --- æ¤œç´¢ ---
    function renderSearchResults() {
        const key = document.getElementById('search-key').value.toLowerCase();
        const div = document.getElementById('search-res');
        div.innerHTML = "";
        
        if(!key) return;

        Object.keys(localDB).forEach(id => {
            const data = localDB[id];
            let hit = false;
            let innerHTML = `<div class="box-header"><span class="box-id" style="font-size:1rem">${id}</span> <span>${data.loc}</span></div>`;
            
            // ã‚¢ã‚¤ãƒ†ãƒ æ¤œç´¢
            data.items.forEach((item, idx) => {
                if(item.toLowerCase().includes(key)) {
                    hit = true;
                    innerHTML += `<div class="item-row"><span class="item-num">#${idx+1}</span> <b>${item}</b></div>`;
                }
            });

            // å ´æ‰€ã‚„IDæ¤œç´¢
            if(!hit && (id.toLowerCase().includes(key) || data.loc.toLowerCase().includes(key))) {
                hit = true;
                innerHTML += `<div style="font-size:0.8rem; color:#666;">ç®±ã¾ãŸã¯å ´æ‰€ã«ãƒ’ãƒƒãƒˆ</div>`;
            }

            if(hit) {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = innerHTML;
                div.appendChild(card);
            }
        });
        
        if(div.innerHTML === "") div.innerHTML = "<p style='text-align:center;color:#999'>è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>";
    }

    function createQR() {
        const id = 'BOX-' + Math.floor(1000 + Math.random()*9000);
        document.getElementById('new-id').value = id;
        document.getElementById('qrcode-display').innerHTML = "";
        new QRCode(document.getElementById("qrcode-display"), { text: id, width: 128, height: 128 });
    }
</script>

</body>
</html>
